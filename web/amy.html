<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MD3 éœ‡åŠ¨æŒ‰æ‘©ä»ª</title>
    <!-- å¼•å…¥ Material Symbols å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <!-- å¼•å…¥ Roboto å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* MD3 é£æ ¼é…è‰² (ç´«ç½—å…°è‰²ç³») */
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-surface: #FEF7FF;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface: #1D1B20;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-background: #FEF7FF;

            /* é˜´å½± */
            --md-sys-elevation-1: 0px 1px 2px rgba(0,0,0,0.3), 0px 1px 3px 1px rgba(0,0,0,0.15);
            --md-sys-elevation-3: 0px 4px 8px 3px rgba(0,0,0,0.15), 0px 1px 3px rgba(0,0,0,0.3);
            
            --border-radius-lg: 16px;
            --border-radius-xl: 28px;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-surface);
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* é¡¶éƒ¨æ  */
        header {
            padding: 24px 16px 16px;
            display: flex;
            align-items: center;
            background-color: var(--md-sys-color-surface);
        }
        
        h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 400;
            margin-left: 12px;
        }

        /* ä¸»å†…å®¹åŒº */
        main {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨åœ†ç¯ */
        .status-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .status-circle {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background-color: var(--md-sys-color-surface-variant);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .status-circle.active {
            background-color: var(--md-sys-color-primary-container);
            box-shadow: 0 0 30px var(--md-sys-color-primary-container);
            animation: pulse-animation 1s infinite;
        }

        .status-icon {
            font-size: 64px;
            color: var(--md-sys-color-on-surface-variant);
            transition: color 0.3s;
        }

        .status-circle.active .status-icon {
            color: var(--md-sys-color-on-primary-container);
        }

        @keyframes pulse-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--border-radius-lg);
            padding: 16px;
            /* å»æ‰è¾¹æ¡†ï¼Œä½¿ç”¨æ›´æŸ”å’Œçš„èƒŒæ™¯è‰²åŒºåˆ† */
            border: none;
            background-color: #F3EDF7; 
        }

        .card-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 12px;
            display: block;
        }

        /* æ»‘å—æ§ä»¶ */
        .slider-group {
            margin-bottom: 16px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 8px;
        }

        input[type=range] {
            width: 100%;
            height: 4px;
            background: var(--md-sys-color-outline);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--md-sys-color-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--md-sys-elevation-1);
        }

        /* é¢„è®¾æŒ‰é’® Chips */
        .chip-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .chip {
            border: 1px solid var(--md-sys-color-outline);
            background: transparent;
            color: var(--md-sys-color-on-surface-variant);
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .chip.selected {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-color: transparent;
        }

        /* åº•éƒ¨ FAB */
        .fab-container {
            position: fixed;
            bottom: 32px;
            right: 24px;
            z-index: 10;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            box-shadow: var(--md-sys-elevation-3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab span {
            font-size: 24px;
        }

        /* è­¦å‘Šæ¨ªå¹… */
        .banner {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
            padding: 12px 16px;
            font-size: 14px;
            border-radius: 12px;
            display: none; /* é»˜è®¤éšè— */
            margin-bottom: 16px;
            align-items: center;
            gap: 12px;
        }

        .hint {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            text-align: center;
            margin-top: 10px;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <header>
        <span class="material-symbols-rounded" style="color: var(--md-sys-color-primary);">vibration</span>
        <h1>MD3 æŒ‰æ‘©ä»ª</h1>
    </header>

    <main>
        <!-- é”™è¯¯æç¤º Banner -->
        <div id="errorBanner" class="banner">
            <span class="material-symbols-rounded">warning</span>
            <span id="errorText">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéœ‡åŠ¨åŠŸèƒ½ã€‚</span>
        </div>

        <!-- çŠ¶æ€åœ†ç¯ -->
        <div class="status-container">
            <div class="status-circle" id="statusCircle">
                <span class="material-symbols-rounded status-icon" id="statusIcon">power_settings_new</span>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="card">
            <span class="card-title">æ‰‹åŠ¨è°ƒèŠ‚</span>
            
            <div class="slider-group">
                <div class="slider-label">
                    <span>éœ‡åŠ¨å¼ºåº¦ (æ—¶é•¿)</span>
                    <span id="valDuration">50 ms</span>
                </div>
                <input type="range" id="rangeDuration" min="10" max="500" value="50" step="10">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>é—´éš” (é¢‘ç‡)</span>
                    <span id="valInterval">30 ms</span>
                </div>
                <input type="range" id="rangeInterval" min="0" max="500" value="30" step="10">
            </div>
        </div>

        <!-- é¢„è®¾æ¨¡å¼ -->
        <div class="card">
            <span class="card-title">å¿«é€Ÿé¢„è®¾</span>
            <div class="chip-container">
                <button class="chip" onclick="applyPreset('soft')">â˜ï¸ è½»æŸ”æ¨¡å¼</button>
                <button class="chip" onclick="applyPreset('medium')">ğŸŒŠ èˆ’é€‚æ¨¡å¼</button>
                <button class="chip" onclick="applyPreset('strong')">âš¡ å¼ºåŠ›æ¨¡å¼</button>
                <button class="chip" onclick="applyPreset('ultra')">ğŸš€ è¶…å¼ºæŒç»­</button>
            </div>
        </div>

        <p class="hint">æç¤ºï¼šè¯·å…³é—­é™éŸ³æ¨¡å¼ï¼Œå¹¶ç¡®ä¿æ‰‹æœºæ”¯æŒéœ‡åŠ¨é©¬è¾¾ã€‚<br>iOS è®¾å¤‡ç”±äºç³»ç»Ÿé™åˆ¶æš‚ä¸æ”¯æŒç½‘é¡µéœ‡åŠ¨ã€‚</p>
    </main>

    <!-- æ‚¬æµ®å¼€å…³æŒ‰é’® -->
    <div class="fab-container">
        <button class="fab" id="toggleBtn" onclick="toggleVibration()">
            <span class="material-symbols-rounded" id="fabIcon">play_arrow</span>
        </button>
    </div>

    <script>
        // çŠ¶æ€å˜é‡
        let isVibrating = false;
        let wakeLock = null;
        let loopTimeout = null;

        // é»˜è®¤å‚æ•° (æ¯«ç§’)
        let vibrateDuration = 50; // éœ‡åŠ¨æ—¶é•¿ (On)
        let vibrateInterval = 30; // é—´éš”æ—¶é•¿ (Off)

        // DOM å…ƒç´ 
        const statusCircle = document.getElementById('statusCircle');
        const fabIcon = document.getElementById('fabIcon');
        const statusIcon = document.getElementById('statusIcon');
        const rangeDuration = document.getElementById('rangeDuration');
        const rangeInterval = document.getElementById('rangeInterval');
        const valDuration = document.getElementById('valDuration');
        const valInterval = document.getElementById('valInterval');
        const errorBanner = document.getElementById('errorBanner');
        const errorText = document.getElementById('errorText');

        // åˆå§‹åŒ–æ£€æŸ¥
        window.addEventListener('load', () => {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isIOS) {
                errorBanner.style.display = 'flex';
                errorText.innerText = "Apple iOS ç³»ç»Ÿå±è”½äº†ç½‘é¡µéœ‡åŠ¨æƒé™ï¼Œæ— æ³•ä½¿ç”¨ã€‚";
                disableControls();
            } else if (!("vibrate" in navigator)) {
                errorBanner.style.display = 'flex';
                errorText.innerText = "æ‚¨çš„è®¾å¤‡æˆ–æµè§ˆå™¨ä¸æ”¯æŒéœ‡åŠ¨ APIã€‚";
                disableControls();
            }
        });

        function disableControls() {
            document.getElementById('toggleBtn').disabled = true;
            document.querySelector('main').style.opacity = '0.5';
            document.querySelector('main').style.pointerEvents = 'none';
        }

        // æ»‘å—äº‹ä»¶ç›‘å¬
        rangeDuration.addEventListener('input', (e) => {
            vibrateDuration = parseInt(e.target.value);
            valDuration.innerText = vibrateDuration + " ms";
            clearPresetSelection();
        });

        rangeInterval.addEventListener('input', (e) => {
            vibrateInterval = parseInt(e.target.value);
            valInterval.innerText = vibrateInterval + " ms";
            clearPresetSelection();
        });

        // é¢„è®¾é€»è¾‘
        function applyPreset(type) {
            // å…ˆæ¸…é™¤é«˜äº®
            clearPresetSelection();
            
            // æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®å¹¶é«˜äº® (é€šè¿‡éå†ç®€æ˜“å®ç°)
            const chips = document.querySelectorAll('.chip');
            let index = 0;
            
            switch(type) {
                case 'soft':
                    vibrateDuration = 30;
                    vibrateInterval = 80;
                    index = 0;
                    break;
                case 'medium':
                    vibrateDuration = 80;
                    vibrateInterval = 40;
                    index = 1;
                    break;
                case 'strong':
                    vibrateDuration = 200;
                    vibrateInterval = 30;
                    index = 2;
                    break;
                case 'ultra':
                    vibrateDuration = 1000;
                    vibrateInterval = 0; // å°½å¯èƒ½è¿ç»­
                    index = 3;
                    break;
            }

            chips[index].classList.add('selected');
            
            // åŒæ­¥æ»‘å—UI
            rangeDuration.value = vibrateDuration;
            rangeInterval.value = vibrateInterval;
            valDuration.innerText = vibrateDuration + " ms";
            valInterval.innerText = vibrateInterval + " ms";

            // å¦‚æœæ­£åœ¨éœ‡åŠ¨ï¼Œé‡å¯ä»¥åº”ç”¨æ–°å‚æ•°
            if (isVibrating) {
                stopLoop();
                startLoop();
            }
        }

        function clearPresetSelection() {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
        }

        // æ ¸å¿ƒéœ‡åŠ¨å¼€å…³
        function toggleVibration() {
            if (isVibrating) {
                stopVibration();
            } else {
                startVibration();
            }
        }

        async function startVibration() {
            // å°è¯•è¯·æ±‚ WakeLock é˜²æ­¢é”å±
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                console.log('WakeLock error:', err);
            }

            isVibrating = true;
            updateUI(true);
            startLoop();
        }

        function stopVibration() {
            isVibrating = false;
            
            // é‡Šæ”¾ WakeLock
            if (wakeLock) {
                wakeLock.release().then(() => wakeLock = null);
            }

            updateUI(false);
            stopLoop();
            navigator.vibrate(0); // ç«‹å³åœæ­¢ç¡¬ä»¶éœ‡åŠ¨
        }

        // éœ‡åŠ¨å¾ªç¯é€»è¾‘
        // ä½¿ç”¨ setTimeout é€’å½’æ¨¡æ‹Ÿ PWM (è„‰å†²å®½åº¦è°ƒåˆ¶)
        function startLoop() {
            const run = () => {
                if (!isVibrating) return;

                // æ ¸å¿ƒ API è°ƒç”¨
                // å‚æ•°1: éœ‡åŠ¨æ—¶é•¿
                if (vibrateDuration > 0) {
                    navigator.vibrate(vibrateDuration);
                }

                // è®¡ç®—ä¸‹ä¸€æ¬¡å¾ªç¯çš„æ—¶é—´ï¼šéœ‡åŠ¨æ—¶é•¿ + é—´éš”æ—¶é•¿
                // ä¸ºäº†ä¿è¯è¿ç»­æ€§ï¼Œå¦‚æœé—´éš”ä¸º0ï¼Œæˆ‘ä»¬ä»éœ€æå°çš„å»¶è¿Ÿé˜²æ­¢ä¸»çº¿ç¨‹å¡æ­»ï¼Œ
                // ä½†å¤§å¤šæ•°æµè§ˆå™¨å¯¹vibrateè¿ç»­è°ƒç”¨æœ‰ä¿æŠ¤ï¼Œè¿™é‡Œä½¿ç”¨ç®€å•çš„é€»è¾‘
                let nextDelay = vibrateDuration + vibrateInterval;
                if (nextDelay < 10) nextDelay = 10; // æœ€å°å®‰å…¨é˜ˆå€¼

                loopTimeout = setTimeout(run, nextDelay);
            };
            run();
        }

        function stopLoop() {
            if (loopTimeout) {
                clearTimeout(loopTimeout);
                loopTimeout = null;
            }
        }

        // UI æ›´æ–°è¾…åŠ©å‡½æ•°
        function updateUI(active) {
            if (active) {
                statusCircle.classList.add('active');
                fabIcon.innerText = 'stop'; // å˜ä¸ºåœæ­¢å›¾æ ‡
                document.querySelector('.fab').style.backgroundColor = 'var(--md-sys-color-error)';
            } else {
                statusCircle.classList.remove('active');
                fabIcon.innerText = 'play_arrow'; // å˜ä¸ºå¼€å§‹å›¾æ ‡
                document.querySelector('.fab').style.backgroundColor = 'var(--md-sys-color-primary)';
            }
        }

        // é¡µé¢å¯è§æ€§æ”¹å˜æ—¶åœæ­¢ (çœç”µ & é¿å…åå°Bug)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isVibrating) {
                stopVibration();
            }
        });
    </script>
</body>
</html>

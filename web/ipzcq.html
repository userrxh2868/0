<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP & 设备信息工具</title>
    <!-- 引入 Google Fonts 和 Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- 引入 html2canvas 用于截图 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* MD3 Color Tokens (Teal Theme) */
            --md-sys-color-primary: #006a6a;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #6ff7f6;
            --md-sys-color-on-primary-container: #002020;
            --md-sys-color-background: #fafdfc;
            --md-sys-color-surface: #fafdfc;
            --md-sys-color-surface-variant: #dae5e4;
            --md-sys-color-on-surface: #191c1c;
            --md-sys-color-on-surface-variant: #3f4948;
            --md-sys-color-outline: #6f7979;
            --md-elevation-1: 0px 1px 3px 1px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-radius-container: 16px;
            --md-radius-button: 20px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', system-ui, sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Top App Bar */
        .top-app-bar {
            width: 100%;
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-sizing: border-box;
            background-color: var(--md-sys-color-surface);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            color: var(--md-sys-color-on-surface);
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:active {
            background-color: var(--md-sys-color-surface-variant);
        }

        .app-title {
            font-size: 22px;
            margin-left: 16px;
            font-weight: 500;
        }

        /* Content Container */
        #content-area {
            width: 100%;
            max-width: 600px;
            padding: 16px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Cards */
        .card {
            background-color: #fff; /* Fallback */
            background-color: var(--md-sys-color-surface);
            border-radius: var(--md-radius-container);
            padding: 24px;
            box-shadow: var(--md-elevation-1);
            transition: transform 0.2s;
            border: 1px solid #eff1f1;
        }

        .card.highlight {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border: none;
        }

        .card-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card.highlight .card-title {
            color: var(--md-sys-color-on-primary-container);
            opacity: 0.8;
        }

        .data-large {
            font-size: 32px;
            font-weight: 400;
            margin: 0;
            word-break: break-all;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--md-sys-color-surface-variant);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .label {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .value {
            font-weight: 500;
            text-align: right;
            font-size: 14px;
        }

        /* Export Dialog/Menu */
        .export-menu {
            position: fixed;
            top: 60px;
            left: 16px;
            background-color: var(--md-sys-color-surface);
            border-radius: 12px;
            box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15);
            padding: 8px 0;
            display: none;
            flex-direction: column;
            z-index: 20;
            min-width: 180px;
            animation: fadeIn 0.2s ease-out;
        }

        .export-menu.show {
            display: flex;
        }

        .menu-item {
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
            transition: background 0.1s;
        }

        .menu-item:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loader */
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid var(--md-sys-color-primary-container);
            border-bottom-color: var(--md-sys-color-primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- 顶部导航栏 -->
    <div class="top-app-bar">
        <button class="icon-btn" id="exportBtn" title="导出信息">
            <span class="material-symbols-rounded">ios_share</span>
        </button>
        <span class="app-title">IP 检测工具</span>
    </div>

    <!-- 导出菜单 -->
    <div class="export-menu" id="exportMenu">
        <div class="menu-item" onclick="exportAsTXT()">
            <span class="material-symbols-rounded">description</span> 导出为 TXT
        </div>
        <div class="menu-item" onclick="exportAsImage()">
            <span class="material-symbols-rounded">image</span> 导出为 图片
        </div>
        <div class="menu-item" onclick="exportAsWord()">
            <span class="material-symbols-rounded">article</span> 导出为 Word
        </div>
    </div>

    <!-- 主要内容区域 (将用于截图和导出) -->
    <div id="content-area">
        <!-- IP 卡片 -->
        <div class="card highlight">
            <div class="card-title">当前 IP 地址</div>
            <h1 class="data-large" id="ip-address"><span class="loader"></span></h1>
            <div id="ip-details" style="margin-top: 16px;">
                <div class="info-row" style="border-color: rgba(0,32,32,0.1);">
                    <span class="label" style="color: var(--md-sys-color-on-primary-container)">位置</span>
                    <span class="value" id="ip-location">加载中...</span>
                </div>
                <div class="info-row" style="border-color: rgba(0,32,32,0.1);">
                    <span class="label" style="color: var(--md-sys-color-on-primary-container)">运营商 (ISP)</span>
                    <span class="value" id="ip-isp">加载中...</span>
                </div>
            </div>
        </div>

        <!-- 设备信息 卡片 -->
        <div class="card">
            <div class="card-title">设备信息</div>
            
            <div class="info-row">
                <span class="label">操作系统</span>
                <span class="value" id="dev-os">-</span>
            </div>
            <div class="info-row">
                <span class="label">浏览器</span>
                <span class="value" id="dev-browser">-</span>
            </div>
            <div class="info-row">
                <span class="label">屏幕分辨率</span>
                <span class="value" id="dev-screen">-</span>
            </div>
            <div class="info-row">
                <span class="label">语言环境</span>
                <span class="value" id="dev-lang">-</span>
            </div>
            <div class="info-row">
                <span class="label">User Agent</span>
                <span class="value" id="dev-ua" style="font-size: 10px; max-width: 60%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">-</span>
            </div>
        </div>
        
        <div style="text-align: center; font-size: 12px; color: var(--md-sys-color-outline); margin-top: 20px;">
            Generated by IP Tool
        </div>
    </div>

    <script>
        // 1. 界面交互逻辑
        const exportBtn = document.getElementById('exportBtn');
        const exportMenu = document.getElementById('exportMenu');
        const contentArea = document.getElementById('content-area');

        // 点击导出按钮显示/隐藏菜单
        exportBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exportMenu.classList.toggle('show');
        });

        // 点击其他地方关闭菜单
        document.addEventListener('click', () => {
            exportMenu.classList.remove('show');
        });

        // 2. 获取数据逻辑
        
        // 获取 IP 信息 (使用 ipapi.co 的公共 JSON API)
        async function fetchIP() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                document.getElementById('ip-address').textContent = data.ip;
                document.getElementById('ip-location').textContent = `${data.city}, ${data.region}, ${data.country_name}`;
                document.getElementById('ip-isp').textContent = data.org;
            } catch (error) {
                console.error("Fetching detailed IP failed, trying fallback", error);
                // 备用方案只获取 IP
                try {
                    const fallback = await fetch('https://api.ipify.org?format=json');
                    const data = await fallback.json();
                    document.getElementById('ip-address').textContent = data.ip;
                    document.getElementById('ip-location').textContent = "获取位置失败";
                    document.getElementById('ip-isp').textContent = "未知";
                } catch (e) {
                    document.getElementById('ip-address').textContent = "网络错误";
                }
            }
        }

        // 获取设备信息
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let os = "Unknown OS";
            
            if (ua.indexOf("Win") !== -1) os = "Windows";
            if (ua.indexOf("Mac") !== -1) os = "MacOS";
            if (ua.indexOf("Linux") !== -1) os = "Linux";
            if (ua.indexOf("Android") !== -1) os = "Android";
            if (ua.indexOf("like Mac") !== -1) os = "iOS";

            // 简单的浏览器检测
            let browser = "Unknown";
            if(ua.indexOf("Chrome") != -1 ) browser = "Chrome";
            else if(ua.indexOf("Safari") != -1) browser = "Safari";
            else if(ua.indexOf("Firefox") != -1) browser = "Firefox";
            if((ua.indexOf("MSIE") != -1 ) || (!!document.documentMode == true )) browser = "IE";

            document.getElementById('dev-os').textContent = os;
            document.getElementById('dev-browser').textContent = browser;
            document.getElementById('dev-screen').textContent = `${window.screen.width} x ${window.screen.height}`;
            document.getElementById('dev-lang').textContent = navigator.language;
            document.getElementById('dev-ua').textContent = ua;
        }

        // 初始化执行
        fetchIP();
        getDeviceInfo();


        // 3. 导出功能逻辑

        function getFormattedData() {
            return `
IP 信息报告
---------------------------
IP 地址: ${document.getElementById('ip-address').innerText}
位置: ${document.getElementById('ip-location').innerText}
ISP: ${document.getElementById('ip-isp').innerText}

设备信息
---------------------------
操作系统: ${document.getElementById('dev-os').innerText}
浏览器: ${document.getElementById('dev-browser').innerText}
分辨率: ${document.getElementById('dev-screen').innerText}
语言: ${document.getElementById('dev-lang').innerText}
User Agent: ${document.getElementById('dev-ua').innerText}
            `;
        }

        // 导出 TXT
        function exportAsTXT() {
            const data = getFormattedData();
            const blob = new Blob([data], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ip_info.txt';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // 导出 图片 (使用 html2canvas)
        function exportAsImage() {
            // 暂时隐藏导出菜单以免被截图进去
            exportMenu.classList.remove('show');
            
            html2canvas(contentArea, {
                backgroundColor: "#fafdfc", // 保持背景色
                scale: 2 // 提高清晰度
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'ip_info.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // 导出 Word (使用 MHTML/HTML Blob 伪装法，兼容性较好且轻量)
        function exportAsWord() {
            const content = contentArea.innerHTML;
            // 构建一个简单的 HTML 结构用于 Word 读取
            const preHtml = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML to Word Document with JavaScript</title><style>body{font-family: Arial} .card{border:1px solid #ccc; padding:10px; margin-bottom:10px;} .label{font-weight:bold;}</style></head><body>";
            const postHtml = "</body></html>";
            
            // 简单清理一下样式，以便在Word中更好看 (可选)
            // 这里直接使用 raw HTML，Word 能够解析大部分 DIV 和 Span
            
            const html = preHtml + content + postHtml;

            const blob = new Blob(['\ufeff', html], {
                type: 'application/msword'
            });
            
            const url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(html);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'ip_info.doc'; // .doc 兼容性比 .docx 更好处理简单的 HTML 转换
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e1e1e">
    <title>Emoji Art App - Creative Suite</title>
    
    <!-- ‰ºòÂåñÂ≠ó‰ΩìÂä†ËΩΩËøûÊé• -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- ÂºïÂÖ• Materialize CSS (‰ªÖÂü∫Á°ÄÊ†∑Âºè) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    
    <!-- ÂºïÂÖ• Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff5252;
            --secondary-color: #2979ff;
            --accent-color: #ffb74d; 
            --purple-color: #e040fb; 
            --pen-color-indicator: #00e676; /* ÁîªÁ¨îÊ®°ÂºèÊåáÁ§∫Ëâ≤ */
            --surface-color: #1e1e1e;
            --surface-element: #2d2d2d;
            --text-color: #ffffff;
            --panel-radius: 28px;
            --island-bg: #000000;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #121212;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            touch-action: none; 
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.4s ease;
        }

        /* ÂÖ®Â±èÁîªÂ∏É */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
            cursor: crosshair;
        }

        /* ÁΩëÊ†ºËæÖÂä©Á∫øÂ±Ç */
        #grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
            z-index: 2;
            display: none;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px; 
        }
        #grid-overlay.visible { display: block; }

        /* --- ÁÅµÂä®Â≤õ (Dynamic Island) --- */
        .dynamic-island {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--island-bg);
            border-radius: 40px;
            z-index: 200;
            transition: 
                width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), 
                height 0.6s cubic-bezier(0.34, 1.56, 0.64, 1),
                border-radius 0.5s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            
            width: 100px;
            height: 32px;
        }

        .dynamic-island.expanded {
            width: 420px; /* ÂÜçÊ¨°Âä†ÂÆΩ‰ª•ÂÆπÁ∫≥ÁîªÁ¨îÊåâÈíÆ */
            height: 64px;
        }

        .island-content {
            display: flex;
            align-items: center;
            gap: 6px; 
            opacity: 0;
            pointer-events: none;
            transform: scale(0.9);
            transition: opacity 0.2s ease, transform 0.3s ease;
            width: 100%;
            justify-content: center;
        }

        .dynamic-island.expanded .island-content {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
            transition-delay: 0.1s;
        }

        .island-idle {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            opacity: 1;
            transition: opacity 0.2s;
        }
        .dynamic-island.expanded .island-idle { opacity: 0; }
        
        .status-dot {
            width: 6px;
            height: 6px;
            background-color: var(--primary-color);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--primary-color);
            animation: breathe 2s infinite;
        }
        @keyframes breathe {
            0% { opacity: 0.5; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.5; transform: scale(0.8); }
        }

        /* Â∑•ÂÖ∑Ê†èÊåâÈíÆ */
        .icon-btn {
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .icon-btn i { font-size: 22px; }
        .icon-btn:active { color: white; transform: scale(0.9); }
        .icon-btn.active { color: var(--primary-color); background: rgba(255, 82, 82, 0.1); }
        .icon-btn.mirror-active { color: var(--secondary-color); background: rgba(41, 121, 255, 0.1); }
        .icon-btn.jitter-active { color: var(--accent-color); background: rgba(255, 183, 77, 0.15); }
        .icon-btn.size-active { color: var(--purple-color); background: rgba(224, 64, 251, 0.15); }
        /* Êñ∞Â¢ûÔºöÁîªÁ¨îÊøÄÊ¥ªÊ†∑Âºè */
        .icon-btn.pen-active { color: var(--pen-color-indicator); background: rgba(0, 230, 118, 0.15); }
        
        .divider { width: 1px; background: #333; height: 20px; margin: auto 0; }

        /* --- Â∫ïÈÉ®ÊäΩÂ±â --- */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--surface-color);
            border-top-left-radius: var(--panel-radius);
            border-top-right-radius: var(--panel-radius);
            padding: 0 0 30px 0;
            z-index: 100;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 85vh; 
            overflow-y: auto;
        }

        .bottom-sheet.collapsed {
            transform: translateY(calc(100% - 40px));
        }

        .sheet-inner {
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* ‰∫§ÈîôÂä®Áîª */
        .stagger-item {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .bottom-sheet:not(.collapsed) .stagger-item {
            opacity: 1;
            transform: translateY(0);
        }
        .bottom-sheet:not(.collapsed) .stagger-item:nth-child(1) { transition-delay: 0.05s; } 
        .bottom-sheet:not(.collapsed) .stagger-item:nth-child(2) { transition-delay: 0.1s; } 
        .bottom-sheet:not(.collapsed) .stagger-item:nth-child(3) { transition-delay: 0.15s; } 


        .drag-handle {
            width: 100%;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        .drag-indicator { width: 40px; height: 5px; background-color: #444; border-radius: 3px; }

        /* ‰ª™Ë°®Áõò */
        .dashboard-row {
            display: flex;
            justify-content: space-between;
            background: rgba(0,0,0,0.2);
            padding: 10px 15px;
            border-radius: 16px;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .info-block { display: flex; flex-direction: column; }
        .info-label { font-size: 10px; color: #888; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
        .info-value { font-family: 'Courier New', monospace; font-weight: 600; color: #eee; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .time-ms { color: #666; font-size: 0.8em; }
        .battery-error { font-size: 12px; color: #ef5350; font-family: sans-serif; }

        /* Emoji ËΩ®ÈÅì */
        .emoji-track {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 5px 20px;
            scrollbar-width: none;
            flex-shrink: 0;
            opacity: 0;
            transform: translateX(-20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .bottom-sheet:not(.collapsed) .emoji-track {
            opacity: 1;
            transform: translateX(0);
        }

        .emoji-item {
            font-size: 28px;
            width: 60px;
            height: 60px;
            border-radius: 20px;
            background: var(--surface-element);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .emoji-item.active {
            background: var(--primary-color);
            transform: translateY(-8px) scale(1.1);
            box-shadow: 0 8px 15px rgba(255, 82, 82, 0.4);
            z-index: 2;
        }
        
        .custom-input { width: 100%; height: 100%; background: transparent; border: none; text-align: center; color: white; font-size: 24px; outline: none; }

        .slider-container { background: var(--surface-element); padding: 15px; border-radius: 16px; }
        .slider-row { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .slider-row:last-child { margin-bottom: 0; }
        .slider-icon { color: #888; font-size: 20px; width: 24px;}
        
        input[type=range] { border: none; background: transparent; margin: 0; height: 24px; }
        input[type=range]::-webkit-slider-thumb { background-color: var(--primary-color); width: 16px; height: 16px; margin-top: -6px; box-shadow: 0 0 0 4px rgba(255, 82, 82, 0.2); }
        input[type=range]::-webkit-slider-runnable-track { background: #444; height: 4px; border-radius: 2px; }
        .val-display { font-size: 12px; color: #888; width: 35px; text-align: right; font-variant-numeric: tabular-nums; }

        .action-scroll-container {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .action-scroll-container::-webkit-scrollbar { display: none; }

        .action-area {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 100%;
            gap: 20px;
            padding: 0 5px;
        }

        .color-group { display: flex; gap: 10px; background: var(--surface-element); padding: 8px; border-radius: 50px; flex-shrink: 0; }
        .color-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; position: relative; }
        .color-dot.active { border-color: white; transform: scale(1.1); }
        .rainbow-dot { background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); }
        
        /* Êñ∞Â¢ûÔºöÁîªÁ¨îÈ¢úËâ≤ÈÄâÊã©ÁÇπ */
        .pen-color-dot {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #424242; /* ÈªòËÆ§ÁÅ∞Ëâ≤Â∫ï */
            border: 2px solid #666;
        }
        .pen-color-dot i { font-size: 16px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .pen-color-dot.active { border-color: var(--pen-color-indicator); }

        #custom-bg-picker { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        /* Êñ∞Â¢ûÔºöÁîªÁ¨îÈ¢úËâ≤ËæìÂÖ•Ê°Ü (ÈöêËóè) */
        #pen-color-picker { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        .fab-row { display: flex; gap: 12px; flex-shrink: 0; }
        .fab { width: 48px; height: 48px; border-radius: 16px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.2s; color: white; }
        .fab:active { transform: scale(0.92); }
        .fab-blue { background: #2979ff; }
        .fab-red { background: #d32f2f; }
        .fab-grey { background: #424242; }
        
        .res-chip {
            background: var(--surface-element);
            padding: 0 12px;
            height: 48px;
            border-radius: 16px;
            color: #888;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            flex-shrink: 0;
            border: 1px solid transparent;
        }
        .res-chip.active { color: var(--primary-color); border-color: var(--primary-color); }

    </style>
</head>
<body>

    <!-- ÁΩëÊ†ºÈÅÆÁΩ© -->
    <div id="grid-overlay"></div>

    <!-- ÁÅµÂä®Â≤õ (Â¢ûÂä† Pen Mode ÊåâÈíÆ) -->
    <div class="dynamic-island" id="dynamic-island">
        <div class="island-idle">
            <div class="status-dot"></div>
        </div>

        <div class="island-content">
            <button class="icon-btn active" id="mode-brush" title="Emoji ÁîªÁ¨î">
                <i class="material-icons">brush</i>
            </button>
            <!-- Êñ∞Â¢ûÔºöÁ∫ØËâ≤ÁîªÁ¨îÊåâÈíÆ -->
            <button class="icon-btn" id="mode-pen" title="Á∫ØËâ≤ÁîªÁ¨î">
                <i class="material-icons">create</i>
            </button>
            <button class="icon-btn" id="mode-eraser" title="Ê©°ÁöÆÊì¶">
                <i class="material-icons">auto_fix_normal</i>
            </button>
            <div class="divider"></div>
            <button class="icon-btn" id="mode-mirror" title="ÈïúÂÉèÊ®°Âºè">
                <i class="material-icons">flip</i>
            </button>
            <button class="icon-btn" id="mode-jitter" title="ËßíÂ∫¶ÊäñÂä®">
                <i class="material-icons">casino</i>
            </button>
            <button class="icon-btn" id="mode-size-jitter" title="Â§ßÂ∞èÊäñÂä®">
                <i class="material-icons">bubble_chart</i>
            </button>
            <div class="divider"></div>
            <button class="icon-btn" id="btn-undo" title="Êí§ÈîÄ">
                <i class="material-icons">undo</i>
            </button>
            <button class="icon-btn" id="btn-redo" title="ÈáçÂÅö">
                <i class="material-icons">redo</i>
            </button>
        </div>
    </div>

    <!-- ÁîªÂ∏É -->
    <div id="canvas-container">
        <canvas id="drawing-board"></canvas>
    </div>

    <!-- Â∫ïÈÉ®ÊéßÂà∂Èù¢Êùø -->
    <div class="bottom-sheet" id="bottom-sheet">
        <div class="drag-handle" id="toggle-sheet">
            <div class="drag-indicator"></div>
        </div>

        <!-- Emoji ËΩ®ÈÅì -->
        <div class="emoji-track">
            <button class="emoji-item active" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
            <button class="emoji-item" data-emoji="ü´ß">ü´ß</button>
            <button class="emoji-item" data-emoji="‚ú®">‚ú®</button>
            <button class="emoji-item" data-emoji="üå∏">üå∏</button>
            <button class="emoji-item" data-emoji="üî•">üî•</button>
            <button class="emoji-item" data-emoji="üçî">üçî</button>
            <button class="emoji-item" data-emoji="üí©">üí©</button>
            <button class="emoji-item" data-emoji="ü§°">ü§°</button>
            <div class="emoji-item" style="background: #333;">
                <input id="custom_emoji" type="text" class="custom-input" maxlength="2" placeholder="+">
            </div>
        </div>

        <div class="sheet-inner">
            <!-- Áä∂ÊÄÅ‰ª™Ë°®Áõò -->
            <div class="dashboard-row stagger-item">
                <div class="info-block">
                    <span class="info-label">Current Time</span>
                    <span class="info-value" id="dashboard-time">
                        00:00:00 <span class="time-ms">.000</span>
                    </span>
                </div>
                <div class="info-block" style="align-items: flex-end;">
                    <span class="info-label">Power</span>
                    <span class="info-value" id="dashboard-battery">
                        <span id="battery-text">Detecting...</span>
                        <i class="material-icons" id="battery-icon" style="font-size:16px; margin-left:5px;">battery_unknown</i>
                    </span>
                </div>
            </div>

            <!-- ÊªëÂùóÊéßÂà∂ -->
            <div class="slider-container stagger-item">
                <div class="slider-row">
                    <i class="material-icons slider-icon">circle</i>
                    <p class="range-field" style="margin:0; flex:1;">
                        <input type="range" id="size-slider" min="5" max="120" value="40" />
                    </p>
                    <span class="val-display" id="size-val">40</span>
                </div>
                <div class="slider-row">
                    <i class="material-icons slider-icon">grid_view</i>
                    <p class="range-field" style="margin:0; flex:1;">
                        <input type="range" id="spacing-slider" min="1" max="80" value="10" />
                    </p>
                    <span class="val-display" id="spacing-val">10</span>
                </div>
            </div>

            <!-- Â∫ïÈÉ®ÂäüËÉΩÂå∫ -->
            <div class="action-scroll-container stagger-item">
                <div class="action-area">
                    <div class="color-group">
                        <!-- ËÉåÊôØËâ≤ -->
                        <div class="color-dot active" style="background:#121212" data-bg="#121212"></div>
                        <div class="color-dot" style="background:#1b3a28" data-bg="#1b3a28"></div>
                        <div class="color-dot" style="background:#0d1b2a" data-bg="#0d1b2a"></div>
                        <div class="color-dot rainbow-dot" title="Ëá™ÂÆö‰πâËÉåÊôØ">
                            <input type="color" id="custom-bg-picker" value="#121212">
                        </div>
                        
                        <!-- Êñ∞Â¢ûÔºöÁîªÁ¨îÈ¢úËâ≤ÈÄâÊã©Âô® -->
                        <div class="color-dot pen-color-dot" title="ÁîªÁ¨îÈ¢úËâ≤">
                            <i class="material-icons">edit</i>
                            <input type="color" id="pen-color-picker" value="#ffffff">
                        </div>
                    </div>

                    <div class="fab-row">
                        <button class="fab fab-grey waves-effect waves-light" id="grid-btn" title="ÊòæÁ§∫/ÈöêËóèÁΩëÊ†º">
                            <i class="material-icons">grid_on</i>
                        </button>
                        <button class="fab fab-grey waves-effect waves-light" id="fullscreen-btn" title="ÂÖ®Â±è">
                            <i class="material-icons">fullscreen</i>
                        </button>
                        
                        <div class="res-chip waves-effect" id="res-toggle">
                            <i class="material-icons" style="font-size:16px">hd</i>
                            <span id="res-text">SD</span>
                        </div>
                        <button class="fab fab-blue waves-effect waves-light" id="snapshot-btn">
                            <i class="material-icons">camera_alt</i>
                        </button>
                        <button class="fab fab-red waves-effect waves-light" id="clear-btn">
                            <i class="material-icons">delete</i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        // --- Ê†∏ÂøÉÂèòÈáè ---
        const canvas = document.getElementById('drawing-board');
        const ctx = canvas.getContext('2d');
        const bottomSheet = document.getElementById('bottom-sheet');
        const gridOverlay = document.getElementById('grid-overlay');
        
        // Êéß‰ª∂ÂºïÁî®
        const emojiBtns = document.querySelectorAll('.emoji-item:not(:last-child)');
        const customInput = document.getElementById('custom_emoji');
        const sizeSlider = document.getElementById('size-slider');
        const spacingSlider = document.getElementById('spacing-slider');
        const clearBtn = document.getElementById('clear-btn');
        const snapshotBtn = document.getElementById('snapshot-btn');
        const resToggle = document.getElementById('res-toggle');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const gridBtn = document.getElementById('grid-btn');
        
        // ÁÅµÂä®Â≤õÂºïÁî®
        const dynamicIsland = document.getElementById('dynamic-island');
        
        // È°∂ÈÉ®Â∑•ÂÖ∑
        const undoBtn = document.getElementById('btn-undo');
        const redoBtn = document.getElementById('btn-redo');
        const modeBrushBtn = document.getElementById('mode-brush');
        const modePenBtn = document.getElementById('mode-pen'); // Êñ∞Â¢û
        const modeEraserBtn = document.getElementById('mode-eraser');
        const modeMirrorBtn = document.getElementById('mode-mirror');
        const modeJitterBtn = document.getElementById('mode-jitter');
        const modeSizeJitterBtn = document.getElementById('mode-size-jitter');
        
        // È¢úËâ≤Êéß‰ª∂
        const bgDots = document.querySelectorAll('.color-dot:not(.rainbow-dot):not(.pen-color-dot)');
        const rainbowDot = document.querySelector('.rainbow-dot');
        const customBgPicker = document.getElementById('custom-bg-picker');
        // Êñ∞Â¢ûÁîªÁ¨îÈ¢úËâ≤
        const penColorDot = document.querySelector('.pen-color-dot');
        const penColorPicker = document.getElementById('pen-color-picker');

        // Áä∂ÊÄÅÂèòÈáè
        let currentEmoji = '‚ù§Ô∏è';
        let brushSize = 40;
        let brushSpacing = 10; 
        let isDrawing = false;
        let pixelRatio = 1; 
        
        // Ê®°ÂºèÁä∂ÊÄÅ
        let isPen = false; // Êñ∞Â¢ûÔºöÊòØÂê¶ÊòØÁ∫ØËâ≤Á¨îÊ®°Âºè
        let isEraser = false;
        let isMirror = false; 
        let isJitter = false;
        let isSizeJitter = false; 
        
        let currentBgColor = '#121212';
        let currentPenColor = '#ffffff'; // Êñ∞Â¢ûÔºöÂΩìÂâçÁîªÁ¨îÈ¢úËâ≤
        let lastX = 0, lastY = 0;

        let undoStack = [];
        let redoStack = [];
        const MAX_HISTORY = 15;

        // --- 0. Ëá™Âä®‰øùÂ≠ò‰∏éÂä†ËΩΩ ---
        function saveToLocal() {
            localStorage.setItem('emojiArtSave', canvas.toDataURL());
        }

        function loadFromLocal() {
            const data = localStorage.getItem('emojiArtSave');
            if (data) {
                const img = new Image();
                img.src = data;
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, canvas.width/pixelRatio, canvas.height/pixelRatio);
                    undoStack.push(data); 
                };
            }
        }
        window.addEventListener('load', loadFromLocal);

        // --- 1. ÁÅµÂä®Â≤õ‰∫§‰∫í ---
        dynamicIsland.addEventListener('click', (e) => {
            e.stopPropagation(); 
            dynamicIsland.classList.add('expanded');
        });

        document.addEventListener('click', (e) => {
            if (!dynamicIsland.contains(e.target)) {
                dynamicIsland.classList.remove('expanded');
            }
        });

        // --- 2. ‰ª™Ë°®ÁõòÈÄªËæë ---
        function updateTime() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            const ms = String(now.getMilliseconds()).padStart(3, '0');
            document.getElementById('dashboard-time').innerHTML = 
                `${h}:${m}:${s}<span class="time-ms">.${ms}</span>`;
            requestAnimationFrame(updateTime);
        }
        requestAnimationFrame(updateTime);

        function initBattery() {
            const batteryText = document.getElementById('battery-text');
            const batteryIcon = document.getElementById('battery-icon');
            if ('getBattery' in navigator) {
                navigator.getBattery().then(function(battery) {
                    function updateBatteryUI() {
                        const level = Math.round(battery.level * 100);
                        const isCharging = battery.charging;
                        batteryText.innerText = `${level}%${isCharging ? ' (Charging)' : ''}`;
                        batteryText.style.color = isCharging ? '#4caf50' : '#eee';
                        if (isCharging) batteryIcon.innerText = 'bolt';
                        else if (level >= 90) batteryIcon.innerText = 'battery_full';
                        else if (level >= 60) batteryIcon.innerText = 'battery_5_bar';
                        else if (level >= 30) batteryIcon.innerText = 'battery_3_bar';
                        else batteryIcon.innerText = 'battery_alert';
                    }
                    updateBatteryUI();
                    battery.addEventListener('levelchange', updateBatteryUI);
                    battery.addEventListener('chargingchange', updateBatteryUI);
                }).catch(() => { showBatteryError(); });
            } else { showBatteryError(); }

            function showBatteryError() {
                batteryText.innerText = "ÊµèËßàÂô®Ê≤°ÊúâËØ•apiÊàñËÆæÂ§á‰∏çÊîØÊåÅ";
                batteryText.className = "battery-error";
                batteryIcon.style.display = 'none';
            }
        }
        initBattery();

        // --- 3. Ê®°ÂºèÂäüËÉΩ ---

        modeMirrorBtn.addEventListener('click', () => {
            isMirror = !isMirror;
            modeMirrorBtn.classList.toggle('mirror-active', isMirror);
            M.toast({html: isMirror ? 'ÈïúÂÉèÊ®°Âºè: ÂºÄÂêØ ü¶ã' : 'ÈïúÂÉèÊ®°Âºè: ÂÖ≥Èó≠', classes: 'rounded blue'});
        });

        modeJitterBtn.addEventListener('click', () => {
            isJitter = !isJitter;
            modeJitterBtn.classList.toggle('jitter-active', isJitter);
            M.toast({html: isJitter ? 'ËßíÂ∫¶ÊäñÂä®: ÂºÄÂêØ üé≤' : 'ËßíÂ∫¶ÊäñÂä®: ÂÖ≥Èó≠', classes: 'rounded orange'});
        });

        modeSizeJitterBtn.addEventListener('click', () => {
            isSizeJitter = !isSizeJitter;
            modeSizeJitterBtn.classList.toggle('size-active', isSizeJitter);
            M.toast({html: isSizeJitter ? 'Â§ßÂ∞èÈöèÊú∫: ÂºÄÂêØ ü´ß' : 'Â§ßÂ∞èÈöèÊú∫: ÂÖ≥Èó≠', classes: 'rounded purple'});
        });

        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    M.toast({html: 'Êó†Ê≥ïÂÖ®Â±è: ' + err.message});
                });
            } else {
                document.exitFullscreen();
            }
        });

        gridBtn.addEventListener('click', () => {
            gridOverlay.classList.toggle('visible');
            const isVisible = gridOverlay.classList.contains('visible');
            gridBtn.querySelector('i').innerText = isVisible ? 'grid_off' : 'grid_on';
            if (isVisible) gridBtn.classList.add('fab-blue');
            else gridBtn.classList.remove('fab-blue');
        });

        // --- 4. ÁîªÂ∏É‰∏éÂàÜËæ®Áéá ---
        function resizeCanvas() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            canvas.width = w * pixelRatio;
            canvas.height = h * pixelRatio;
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
            ctx.scale(pixelRatio, pixelRatio);
            updateCompositeOperation();
            loadFromLocal(); 
        }
        // resizeCanvas logic should ideally preserve content, simple reload for now
        window.addEventListener('resize', () => {
             // ÁÆÄÂçïÁöÑ resize Á≠ñÁï•ÔºöÈáçÊñ∞ËÆæÁΩÆÂ∞∫ÂØ∏Âπ∂ÈáçÁªò
             // ËøôÈáå‰∏∫‰∫Ü‰øùÊåÅ‰ª£Á†ÅÁÆÄÊ¥ÅÔºåÊöÇÊó∂Âè™ÂÅöÂ∞∫ÂØ∏Ë∞ÉÊï¥ÔºåÂèØËÉΩ‰ºöÊ∏ÖÁ©∫ÁîªÂ∏ÉÔºà‰ΩÜloadFromLocal‰ºöÂ∞ùËØïÊÅ¢Â§çÔºâ
             // ÂÆûÈôÖÁîü‰∫ß‰∏≠Âª∫ËÆÆÁî® offscreen canvas ‰øùÂ≠ò
            const w = window.innerWidth;
            const h = window.innerHeight;
            canvas.width = w * pixelRatio;
            canvas.height = h * pixelRatio;
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
            ctx.scale(pixelRatio, pixelRatio);
            loadFromLocal();
        });
        
        // ÂàùÂßãÊâßË°å‰∏ÄÊ¨°
        const w = window.innerWidth;
        const h = window.innerHeight;
        canvas.width = w * pixelRatio;
        canvas.height = h * pixelRatio;
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        ctx.scale(pixelRatio, pixelRatio);


        resToggle.addEventListener('click', () => {
            if (pixelRatio === 1) {
                pixelRatio = window.devicePixelRatio || 2;
                resToggle.classList.add('active');
                document.getElementById('res-text').innerText = 'HD';
                M.toast({html: 'Â∑≤ÂºÄÂêØÈ´òÊ∏ÖÊ®°Âºè', classes: 'rounded'});
            } else {
                pixelRatio = 1;
                resToggle.classList.remove('active');
                document.getElementById('res-text').innerText = 'SD';
                M.toast({html: 'ÁúÅÁîµÊ®°Âºè', classes: 'rounded'});
            }
            saveToLocal(); 
            resizeCanvas();
        });

        // --- 5. Êí§ÈîÄÈáçÂÅöÈÄªËæë ---
        function saveState() {
            if (undoStack.length >= MAX_HISTORY) undoStack.shift();
            undoStack.push(canvas.toDataURL());
            redoStack = []; 
            saveToLocal(); 
        }

        function restoreState(imgData) {
            ctx.clearRect(0, 0, canvas.width / pixelRatio, canvas.height / pixelRatio);
            const img = new Image();
            img.src = imgData;
            img.onload = () => {
                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.drawImage(img, 0, 0);
                ctx.restore();
                saveToLocal(); 
            };
        }

        undoBtn.addEventListener('click', () => {
            if (undoStack.length > 0) {
                redoStack.push(canvas.toDataURL());
                const prev = undoStack.pop();
                restoreState(prev);
            } else {
                redoStack.push(canvas.toDataURL());
                ctx.clearRect(0, 0, canvas.width / pixelRatio, canvas.height / pixelRatio);
                saveToLocal();
            }
        });

        redoBtn.addEventListener('click', () => {
            if (redoStack.length > 0) {
                const next = redoStack.pop();
                undoStack.push(canvas.toDataURL());
                restoreState(next);
            }
        });

        // --- 6. Ê®°Âºè‰∏éÁªòÂõæ (Êõ¥Êñ∞ÔºöÁîªÁ¨îÊîØÊåÅ) ---
        function updateCompositeOperation() {
            ctx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
        }

        // ÂàáÊç¢Âà∞ Emoji Ê®°Âºè
        modeBrushBtn.addEventListener('click', () => {
            isEraser = false;
            isPen = false; // ÂÖ≥Èó≠Á∫ØËâ≤Á¨î
            modeBrushBtn.classList.add('active');
            modePenBtn.classList.remove('pen-active');
            modeEraserBtn.classList.remove('active');
            updateCompositeOperation();
            M.toast({html: 'Emoji Ê®°Âºè', classes: 'rounded'});
        });

        // ÂàáÊç¢Âà∞ Á∫ØËâ≤ÁîªÁ¨î Ê®°Âºè (Êñ∞Â¢û)
        modePenBtn.addEventListener('click', () => {
            isEraser = false;
            isPen = true;
            modePenBtn.classList.add('pen-active');
            modeBrushBtn.classList.remove('active');
            modeEraserBtn.classList.remove('active');
            updateCompositeOperation();
            M.toast({html: 'ÁîªÁ¨îÊ®°Âºè', classes: 'rounded green'});
        });

        // ÂàáÊç¢Âà∞ Ê©°ÁöÆÊì¶ Ê®°Âºè
        modeEraserBtn.addEventListener('click', () => {
            isEraser = true;
            // Ê©°ÁöÆÊì¶‰∏çÊîπÂèò isPen Áä∂ÊÄÅÔºåÂè™ÊîπÂèò eraser Áä∂ÊÄÅÔºå‰ΩÜ‰∏∫‰∫Ü UI ‰∫íÊñ•ÔºåÊàë‰ª¨ËøôÈáåËßÜ‰∏∫‰∏ÄÁßçÁâπÊÆäÊ®°Âºè
            isPen = false; 
            modeEraserBtn.classList.add('active');
            modeBrushBtn.classList.remove('active');
            modePenBtn.classList.remove('pen-active');
            updateCompositeOperation();
            M.toast({html: 'Ê©°ÁöÆÊì¶', classes: 'rounded'});
        });

        // --- 7. ËÉåÊôØ‰∏éÈ¢úËâ≤‰∫§‰∫í (Âê´ÁîªÁ¨îÈ¢úËâ≤) ---
        function setBg(color) {
            currentBgColor = color;
            document.body.style.backgroundColor = color;
        }

        bgDots.forEach(dot => {
            dot.addEventListener('click', () => {
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                dot.classList.add('active');
                setBg(dot.getAttribute('data-bg'));
            });
        });

        rainbowDot.addEventListener('click', () => {
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            rainbowDot.classList.add('active');
            setBg(customBgPicker.value);
        });

        customBgPicker.addEventListener('input', (e) => {
            const color = e.target.value;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            rainbowDot.classList.add('active');
            setBg(color);
        });

        // ÁîªÁ¨îÈ¢úËâ≤ÈÄªËæë (Êñ∞Â¢û)
        penColorDot.addEventListener('click', () => {
            // Ëß¶ÂèëÂÜÖÈÉ® input ÁÇπÂáª
            penColorPicker.click();
            // ÂàáÊç¢Âà∞ÁîªÁ¨îÊ®°ÂºèÂ¶ÇÊûú‰∏çÂú®ÁîªÁ¨îÊ®°Âºè
            if (!isPen) modePenBtn.click();
        });

        penColorPicker.addEventListener('input', (e) => {
            currentPenColor = e.target.value;
            penColorDot.style.backgroundColor = currentPenColor; // ËÆ©ÊåâÈíÆÊòæÁ§∫ÂΩìÂâçÈ¢úËâ≤
        });


        document.getElementById('toggle-sheet').addEventListener('click', () => {
            bottomSheet.classList.toggle('collapsed');
        });

        emojiBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // ÁÇπÂáª Emoji Ëá™Âä®ÂàáÂõû Emoji Ê®°Âºè
                if (isEraser || isPen) modeBrushBtn.click();
                
                document.querySelectorAll('.emoji-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                customInput.value = '';
                currentEmoji = btn.getAttribute('data-emoji');
            });
        });

        customInput.addEventListener('input', (e) => {
            if (e.target.value) {
                if (isEraser || isPen) modeBrushBtn.click();
                document.querySelectorAll('.emoji-item').forEach(b => b.classList.remove('active'));
                e.target.parentElement.classList.add('active');
                currentEmoji = e.target.value;
            }
        });

        sizeSlider.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            document.getElementById('size-val').innerText = brushSize;
        });

        spacingSlider.addEventListener('input', (e) => {
            brushSpacing = parseInt(e.target.value);
            document.getElementById('spacing-val').innerText = brushSpacing;
        });

        snapshotBtn.addEventListener('click', () => {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.fillStyle = currentBgColor;
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempCtx.drawImage(canvas, 0, 0);
            const link = document.createElement('a');
            link.download = `EmojiArt_${Date.now()}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
            M.toast({html: 'Â∑≤‰øùÂ≠òÂà∞Áõ∏ÂÜå', classes: 'rounded green'});
        });

        clearBtn.addEventListener('click', () => {
            saveState();
            ctx.clearRect(0, 0, canvas.width / pixelRatio, canvas.height / pixelRatio);
            localStorage.removeItem('emojiArtSave'); 
        });

        // --- 8. ÁªòÂõæÂºïÊìé (ÈõÜÊàêÁîªÁ¨î) ---
        function getPos(e) {
            const t = e.touches ? e.touches[0] : e;
            return { x: t.clientX, y: t.clientY };
        }

        function drawPoint(x, y) {
            drawShape(x, y);
            if (isMirror) {
                const canvasW = canvas.width / pixelRatio; 
                drawShape(canvasW - x, y);
            }
        }

        function drawShape(x, y) {
            ctx.save();
            ctx.translate(x, y);

            // Â§ÑÁêÜÈöèÊú∫Â§ßÂ∞èÊäñÂä® (ÂØπÊâÄÊúâÊ®°ÂºèÁîüÊïà)
            let currentScale = 1;
            if (isSizeJitter) {
                currentScale = 0.5 + Math.random();
            }

            // Â§ÑÁêÜÈöèÊú∫ËßíÂ∫¶ÊäñÂä® (ÂØπÊâÄÊúâÊ®°ÂºèÁîüÊïà)
            if (isJitter) {
                const angle = Math.random() * Math.PI * 2; 
                ctx.rotate(angle);
            }

            const finalSize = brushSize * currentScale;

            if (isEraser) {
                ctx.beginPath();
                // Ê©°ÁöÆÊì¶‰πüÊòØÂúÜÁöÑ
                ctx.arc(0, 0, finalSize / 2, 0, Math.PI * 2);
                ctx.fill();
            } 
            else if (isPen) {
                // Á∫ØËâ≤ÁîªÁ¨îÈÄªËæë
                ctx.fillStyle = currentPenColor;
                ctx.beginPath();
                ctx.arc(0, 0, finalSize / 2, 0, Math.PI * 2);
                ctx.fill();
            } 
            else {
                // Emoji ÈÄªËæë
                ctx.font = `${finalSize}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(currentEmoji, 0, 0); 
            }
            
            ctx.restore(); 
        }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('touchstart', start, {passive: false});
        canvas.addEventListener('mousemove', move);
        canvas.addEventListener('touchmove', move, {passive: false});
        canvas.addEventListener('mouseup', end);
        canvas.addEventListener('touchend', end);
        canvas.addEventListener('mouseout', end);

        function start(e) {
            if(e.target !== canvas) return;
            dynamicIsland.classList.remove('expanded');
            
            isDrawing = true;
            saveState();
            const pos = getPos(e);
            lastX = pos.x;
            lastY = pos.y;
            drawPoint(lastX, lastY);
            if(e.type === 'touchstart') e.preventDefault();
        }

        function move(e) {
            if (!isDrawing) return;
            const pos = getPos(e);
            const dist = Math.hypot(pos.x - lastX, pos.y - lastY);
            // ÂØπ‰∫éÁîªÁ¨îÊ®°ÂºèÔºåÂ¶ÇÊûúÈó¥Ë∑ùÂæàÂ∞èÔºåÂèØ‰ª•ÂΩ¢ÊàêËøûÁª≠Á∫øÊù°
            // Â¶ÇÊûúÁî®Êà∑ÊÉ≥Ë¶ÅÁÇπÁä∂ÁîªÁ¨îÔºåÂèØ‰ª•Ë∞ÉÂ§ßÈó¥Ë∑ùÊªëÂùó
            const step = isEraser ? brushSize/4 : brushSpacing;

            if (dist >= step) {
                const angle = Math.atan2(pos.y - lastY, pos.x - lastX);
                for (let i = 0; i < dist; i += step) {
                    const nextX = lastX + Math.cos(angle) * i;
                    const nextY = lastY + Math.sin(angle) * i;
                    drawPoint(nextX, nextY);
                }
                lastX = pos.x;
                lastY = pos.y;
            }
            if(e.type === 'touchmove') e.preventDefault();
        }

        function end() {
            isDrawing = false;
            ctx.beginPath();
            saveToLocal(); 
        }

    </script>
</body>
</html>

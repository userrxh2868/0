<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çŒœå›½æ——æ¨¡æ‹Ÿå™¨ Pro Max</title>
    <!-- å¼•å…¥ MDUI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/mdui@1.0.2/dist/css/mdui.min.css"/>
    <style>
        body {
            background-color: #f5f5f5;
            user-select: none;
            padding-bottom: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* é¡µé¢åˆ‡æ¢é€»è¾‘ */
        .page {
            display: none;
            animation: fadeIn 0.3s;
        }
        .page.active {
            display: block;
        }

        /* æ¸¸æˆåŒºåŸŸæ ·å¼ */
        .flag-card {
            margin-bottom: 20px;
            padding: 10px;
            text-align: center;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            position: relative;
            flex-direction: column; /* è®©å›¾ç‰‡å’Œæç¤ºæ–‡å­—å‚ç›´æ’åˆ— */
        }
        .flag-img {
            max-width: 100%;
            max-height: 200px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #eee;
            transition: transform 0.3s;
            z-index: 1;
        }
        
        /* å®å®æ¨¡å¼æç¤ºæ–‡å­— */
        #baby-hint {
            display: none;
            margin-top: 15px;
            font-weight: bold;
            font-size: 2em;
            color: #e91e63; /* ç²‰è‰² */
            z-index: 2;
            text-shadow: 1px 1px 0px #fff;
        }

        /* é•œåƒæ¨¡å¼æ ·å¼ */
        .flag-img.mirror-effect {
            transform: scaleX(-1);
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .option-btn {
            height: 60px;
            font-weight: bold;
            white-space: normal;
            line-height: 1.2;
            padding: 5px;
        }

        /* å€’è®¡æ—¶æ¡ */
        .timer-bar-bg {
            height: 6px;
            background: #e0e0e0;
            margin-bottom: 10px;
            border-radius: 3px;
            overflow: hidden;
            display: none;
        }
        .timer-bar-fill {
            height: 100%;
            background: #f44336;
            width: 100%;
            transition: width 0.1s linear;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
        }

        /* æˆå°±åˆ—è¡¨æ ·å¼ */
        .achievement-item {
            border-left: 4px solid #ddd;
            margin-bottom: 10px;
            background: #fff;
        }
        .achievement-item.unlocked {
            border-left-color: #ff9800;
            background: #fff8e1;
        }
        .achievement-icon {
            opacity: 0.3;
        }
        .achievement-item.unlocked .achievement-icon {
            opacity: 1;
            color: #ff9800;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="mdui-theme-primary-indigo mdui-theme-accent-pink">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="mdui-appbar mdui-appbar-fixed">
        <div class="mdui-toolbar mdui-color-theme">
            <span class="mdui-typo-headline">çŒœå›½æ—— Pro Max</span>
            <div class="mdui-toolbar-spacer"></div>
            <button onclick="game.showAchievements()" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'æˆå°±'}">
                <i class="mdui-icon material-icons">emoji_events</i>
            </button>
            <!-- ä¿®æ”¹ï¼šä¸å†åˆ·æ–°é¡µé¢ï¼Œè€Œæ˜¯è°ƒç”¨ goHome -->
            <button onclick="game.goHome()" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">home</i></button>
        </div>
    </div>

    <div class="container" style="margin-top: 70px;">
        
        <!-- 1. èœå•é¡µ -->
        <div id="page-menu" class="page active">
            <div class="mdui-card mdui-p-a-2 mdui-m-b-2">
                <div class="mdui-typo-title mdui-text-center mdui-m-b-2">é€‰æ‹©æ¸¸æˆæ¨¡å¼</div>
                
                <!-- æ–°å¢å®å®æ¨¡å¼ -->
                <button onclick="game.start('baby')" class="mdui-btn mdui-btn-block mdui-color-pink-100 mdui-ripple mdui-m-b-1">
                    <i class="mdui-icon material-icons mdui-text-color-pink">child_care</i> å®å®æ¨¡å¼ <span class="mdui-text-color-red mdui-typo-caption">(NEW)</span>
                    <div class="mdui-text-color-grey-600 mdui-typo-caption">æ˜¾ç¤ºåå­—ï¼Œè½»æ¾è®¤å›¾</div>
                </button>

                <button onclick="game.start('practice')" class="mdui-btn mdui-btn-block mdui-color-green-100 mdui-ripple mdui-m-b-1">
                    <i class="mdui-icon material-icons mdui-text-color-green">school</i> ç»ƒä¹ æ¨¡å¼
                    <div class="mdui-text-color-grey-600 mdui-typo-caption">æ— å‹åŠ›ï¼Œçº¯ç»ƒä¹ </div>
                </button>

                <button onclick="game.start('endless')" class="mdui-btn mdui-btn-block mdui-color-blue-100 mdui-ripple mdui-m-b-1">
                    <i class="mdui-icon material-icons mdui-text-color-blue">all_inclusive</i> æ— å°½æ¨¡å¼
                    <div class="mdui-text-color-grey-600 mdui-typo-caption">ç´¯ç§¯åˆ†æ•°ï¼Œä¸€ç›´ç©</div>
                </button>
                
                <button onclick="game.start('mirror')" class="mdui-btn mdui-btn-block mdui-color-purple-100 mdui-ripple mdui-m-b-1">
                    <i class="mdui-icon material-icons mdui-text-color-purple">flip</i> é•œåƒæ¨¡å¼
                    <div class="mdui-text-color-grey-600 mdui-typo-caption">å›½æ——å·¦å³ç¿»è½¬ï¼Œæ— å°½æŒ‘æˆ˜</div>
                </button>

                <button onclick="game.start('timeattack')" class="mdui-btn mdui-btn-block mdui-color-cyan-100 mdui-ripple mdui-m-b-1">
                    <i class="mdui-icon material-icons mdui-text-color-cyan">timer</i> 60ç§’ç«é€Ÿ
                    <div class="mdui-text-color-grey-600 mdui-typo-caption">é™æ—¶60ç§’ï¼Œç­”é”™æ‰£æ—¶</div>
                </button>

                <button onclick="game.start('extreme')" class="mdui-btn mdui-btn-block mdui-color-orange-100 mdui-ripple mdui-m-b-1">
                    <i class="mdui-icon material-icons mdui-text-color-orange">warning</i> æé™æ¨¡å¼
                    <div class="mdui-text-color-grey-600 mdui-typo-caption">é”™ä¸€ä¸ªç›´æ¥é‡æ¥</div>
                </button>

                <button onclick="game.start('hell')" class="mdui-btn mdui-btn-block mdui-color-red-100 mdui-ripple">
                    <i class="mdui-icon material-icons mdui-text-color-red">whatshot</i> åœ°ç‹±æ¨¡å¼
                    <div class="mdui-text-color-grey-600 mdui-typo-caption">æé™æ¨¡å¼ + å•é¢˜é™æ—¶5ç§’</div>
                </button>
            </div>
            
            <div class="mdui-text-center">
                <button onclick="game.showAchievements()" class="mdui-btn mdui-btn-raised mdui-color-amber-500 mdui-text-color-white mdui-ripple">
                    <i class="mdui-icon material-icons">stars</i> æŸ¥çœ‹æˆå°±
                </button>
            </div>
        </div>

        <!-- 2. æ¸¸æˆé¡µ -->
        <div id="page-game" class="page">
            <div class="status-bar">
                <span id="score-display">å¾—åˆ†: 0</span>
                <span id="mode-display">æ¨¡å¼</span>
            </div>

            <!-- å€’è®¡æ—¶æ¡ -->
            <div id="timer-bar" class="timer-bar-bg">
                <div id="timer-fill" class="timer-bar-fill"></div>
            </div>
            
            <!-- ç«é€Ÿæ¨¡å¼æ–‡æœ¬å€’è®¡æ—¶ -->
            <div id="text-timer" class="mdui-text-center mdui-typo-title mdui-text-color-red" style="display:none; margin-bottom:10px;">
                å‰©ä½™æ—¶é—´: <span id="text-timer-val">60</span>s
            </div>

            <div class="mdui-card flag-card mdui-shadow-3">
                <div id="flag-loading" class="mdui-spinner mdui-spinner-colorful"></div>
                <img id="flag-img" class="flag-img" src="" alt="Flag" style="display:none;" onload="this.style.display='block'; document.getElementById('flag-loading').style.display='none';">
                <!-- å®å®æ¨¡å¼æç¤ºæ–‡å­—å®¹å™¨ -->
                <div id="baby-hint"></div>
            </div>

            <div class="options-grid" id="options-container">
                <!-- é€‰é¡¹ç”± JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- 3. ç»“ç®—é¡µ -->
        <div id="page-result" class="page">
            <div class="mdui-card mdui-p-a-3 mdui-text-center">
                <i class="mdui-icon material-icons mdui-text-color-red mdui-typo-display-4">sentiment_very_dissatisfied</i>
                <h2 class="mdui-typo-display-1 mdui-m-t-2">æ¸¸æˆç»“æŸ</h2>
                <div class="mdui-typo-title mdui-m-y-2">æœ€ç»ˆå¾—åˆ†: <span id="final-score" class="mdui-text-color-theme-accent">0</span></div>
                <div id="result-reason" class="mdui-typo-subheading mdui-text-color-grey mdui-m-b-3"></div>
                
                <!-- ä¿®æ”¹ï¼šè¿”å›ä¸»èœå•è°ƒç”¨ goHome -->
                <button onclick="game.goHome()" class="mdui-btn mdui-btn-raised mdui-btn-block mdui-color-theme-accent mdui-ripple">
                    è¿”å›ä¸»èœå•
                </button>
                <button onclick="game.showAchievements()" class="mdui-btn mdui-btn-flat mdui-btn-block mdui-color-amber-100 mdui-text-color-amber-900 mdui-m-t-2">
                    æŸ¥çœ‹æˆå°±
                </button>
            </div>
        </div>

        <!-- 4. æˆå°±é¡µ -->
        <div id="page-achievements" class="page">
             <div class="mdui-card mdui-p-a-2">
                <div class="mdui-typo-title mdui-m-b-2">
                    <i class="mdui-icon material-icons mdui-text-color-amber">emoji_events</i> æˆ‘çš„æˆå°±
                    <small id="achievement-count" class="mdui-float-right mdui-typo-subheading mdui-m-t-1">0/0</small>
                </div>
                <div class="mdui-divider mdui-m-b-2"></div>
                
                <div id="achievements-list">
                    <!-- JS ç”Ÿæˆåˆ—è¡¨ -->
                </div>

                <button onclick="game.switchPage('page-menu')" class="mdui-btn mdui-btn-raised mdui-btn-block mdui-color-theme mdui-m-t-2">
                    è¿”å›
                </button>
             </div>
        </div>

    </div>

    <!-- å¼•å…¥ MDUI JS -->
    <script src="https://unpkg.com/mdui@1.0.2/dist/js/mdui.min.js"></script>
    <script>
        // --- 1. é¢˜åº“æ•°æ® ---
        const countryData = [
            {code: "cn", name: "ä¸­å›½"}, {code: "us", name: "ç¾å›½"}, {code: "jp", name: "æ—¥æœ¬"}, 
            {code: "kr", name: "éŸ©å›½"}, {code: "gb", name: "è‹±å›½"}, {code: "fr", name: "æ³•å›½"}, 
            {code: "de", name: "å¾·å›½"}, {code: "ru", name: "ä¿„ç½—æ–¯"}, {code: "it", name: "æ„å¤§åˆ©"}, 
            {code: "ca", name: "åŠ æ‹¿å¤§"}, {code: "au", name: "æ¾³å¤§åˆ©äºš"}, {code: "br", name: "å·´è¥¿"}, 
            {code: "in", name: "å°åº¦"}, {code: "ar", name: "é˜¿æ ¹å»·"}, {code: "mx", name: "å¢¨è¥¿å“¥"}, 
            {code: "id", name: "å°åº¦å°¼è¥¿äºš"}, {code: "sa", name: "æ²™ç‰¹é˜¿æ‹‰ä¼¯"}, {code: "tr", name: "åœŸè€³å…¶"}, 
            {code: "za", name: "å—é"}, {code: "es", name: "è¥¿ç­ç‰™"}, {code: "pt", name: "è‘¡è„ç‰™"}, 
            {code: "nl", name: "è·å…°"}, {code: "be", name: "æ¯”åˆ©æ—¶"}, {code: "ch", name: "ç‘å£«"}, 
            {code: "se", name: "ç‘å…¸"}, {code: "no", name: "æŒªå¨"}, {code: "dk", name: "ä¸¹éº¦"}, 
            {code: "fi", name: "èŠ¬å…°"}, {code: "pl", name: "æ³¢å…°"}, {code: "gr", name: "å¸Œè…Š"}, 
            {code: "ua", name: "ä¹Œå…‹å…°"}, {code: "eg", name: "åŸƒåŠ"}, {code: "vn", name: "è¶Šå—"}, 
            {code: "th", name: "æ³°å›½"}, {code: "my", name: "é©¬æ¥è¥¿äºš"}, {code: "sg", name: "æ–°åŠ å¡"}, 
            {code: "ph", name: "è²å¾‹å®¾"}, {code: "pk", name: "å·´åŸºæ–¯å¦"}, {code: "bd", name: "å­ŸåŠ æ‹‰å›½"}, 
            {code: "ir", name: "ä¼Šæœ—"}, {code: "iq", name: "ä¼Šæ‹‰å…‹"}, {code: "il", name: "ä»¥è‰²åˆ—"}, 
            {code: "kp", name: "æœé²œ"}, {code: "mn", name: "è’™å¤"}, {code: "kz", name: "å“ˆè¨å…‹æ–¯å¦"}, 
            {code: "nz", name: "æ–°è¥¿å…°"}, {code: "cl", name: "æ™ºåˆ©"}, {code: "co", name: "å“¥ä¼¦æ¯”äºš"}, 
            {code: "pe", name: "ç§˜é²"}, {code: "ve", name: "å§”å†…ç‘æ‹‰"}, {code: "cu", name: "å¤å·´"}, 
            {code: "at", name: "å¥¥åœ°åˆ©"}, {code: "ie", name: "çˆ±å°”å…°"}, {code: "cz", name: "æ·å…‹"}, 
            {code: "hu", name: "åŒˆç‰™åˆ©"}, {code: "ro", name: "ç½—é©¬å°¼äºš"}, {code: "hr", name: "å…‹ç½—åœ°äºš"},
            {code: "qa", name: "å¡å¡”å°”"}, {code: "ae", name: "é˜¿è”é…‹"}, {code: "ng", name: "å°¼æ—¥åˆ©äºš"}
        ];

        // --- 2. æˆå°±ç³»ç»Ÿå®šä¹‰ ---
        const achievementsDef = [
            { id: 'first_blood', title: 'åˆéœ²é”‹èŠ’', desc: 'ç­”å¯¹ç¬¬ 1 é“é¢˜', check: (g) => g.score >= 1 },
            { id: 'novice_10', title: 'å…¥é—¨é€‰æ‰‹', desc: 'å•å±€è¾¾åˆ° 10 åˆ†', check: (g) => g.score >= 10 },
            { id: 'master_50', title: 'å›½æ——å¤§å¸ˆ', desc: 'å•å±€è¾¾åˆ° 50 åˆ†', check: (g) => g.score >= 50 },
            { id: 'extreme_survivor', title: 'æé™ç”Ÿå­˜', desc: 'æé™æ¨¡å¼è¾¾åˆ° 15 åˆ†', check: (g) => g.mode === 'extreme' && g.score >= 15 },
            { id: 'hell_walker', title: 'åœ°ç‹±è¡Œè€…', desc: 'åœ°ç‹±æ¨¡å¼è¾¾åˆ° 10 åˆ†', check: (g) => g.mode === 'hell' && g.score >= 10 },
            { id: 'speed_demon', title: 'é€Ÿåº¦ä¹‹é­”', desc: '60ç§’ç«é€Ÿæ¨¡å¼æ‹¿åˆ° 20 åˆ†', check: (g) => g.mode === 'timeattack' && g.score >= 20 },
            { id: 'mirror_mind', title: 'é€†å‘æ€ç»´', desc: 'é•œåƒæ¨¡å¼è¾¾åˆ° 15 åˆ†', check: (g) => g.mode === 'mirror' && g.score >= 15 },
            { id: 'baby_steps', title: 'å°å°æ¢é™©å®¶', desc: 'å®å®æ¨¡å¼ç©è€è¾¾åˆ° 5 åˆ†', check: (g) => g.mode === 'baby' && g.score >= 5 }
        ];

        // --- 3. æ¸¸æˆé€»è¾‘æ§åˆ¶å™¨ ---
        const game = {
            score: 0,
            mode: '', 
            currentQuestion: null,
            timerInterval: null, 
            timeLimit: 0, 
            timeRemaining: 0,
            unlockedAchievements: JSON.parse(localStorage.getItem('flagGameAchievements') || '[]'),

            ui: {
                menu: document.getElementById('page-menu'),
                game: document.getElementById('page-game'),
                result: document.getElementById('page-result'),
                achievements: document.getElementById('page-achievements'),
                score: document.getElementById('score-display'),
                modeName: document.getElementById('mode-display'),
                flagImg: document.getElementById('flag-img'),
                flagLoading: document.getElementById('flag-loading'),
                babyHint: document.getElementById('baby-hint'), // å®å®æ¨¡å¼æç¤º
                options: document.getElementById('options-container'),
                timerBar: document.getElementById('timer-bar'),
                timerFill: document.getElementById('timer-fill'),
                textTimer: document.getElementById('text-timer'),
                textTimerVal: document.getElementById('text-timer-val'),
                finalScore: document.getElementById('final-score'),
                resultReason: document.getElementById('result-reason'),
                achList: document.getElementById('achievements-list'),
                achCount: document.getElementById('achievement-count')
            },

            switchPage: function(pageId) {
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
            },

            // --- æ–°å¢ï¼šè¿”å›ä¸»é¡µé€»è¾‘ ---
            goHome: function() {
                clearInterval(this.timerInterval); // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„è®¡æ—¶å™¨
                this.score = 0; // é‡ç½®åˆ†æ•°
                this.switchPage('page-menu');
            },

            // --- æˆå°±ç³»ç»Ÿé€»è¾‘ ---
            checkAchievements: function() {
                let newUnlock = false;
                achievementsDef.forEach(ach => {
                    if (!this.unlockedAchievements.includes(ach.id)) {
                        if (ach.check(this)) {
                            this.unlockedAchievements.push(ach.id);
                            this.showUnlockToast(ach.title);
                            newUnlock = true;
                        }
                    }
                });
                if (newUnlock) {
                    localStorage.setItem('flagGameAchievements', JSON.stringify(this.unlockedAchievements));
                }
            },

            showUnlockToast: function(title) {
                mdui.snackbar({
                    message: `ğŸ† è§£é”æˆå°±ï¼š${title}`,
                    position: 'top',
                    timeout: 2000
                });
            },

            showAchievements: function() {
                this.ui.achList.innerHTML = '';
                this.ui.achCount.innerText = `${this.unlockedAchievements.length}/${achievementsDef.length}`;
                
                achievementsDef.forEach(ach => {
                    const isUnlocked = this.unlockedAchievements.includes(ach.id);
                    const div = document.createElement('div');
                    div.className = `mdui-list-item mdui-ripple achievement-item ${isUnlocked ? 'unlocked' : ''}`;
                    div.innerHTML = `
                        <i class="mdui-list-item-icon mdui-icon material-icons achievement-icon">${isUnlocked ? 'emoji_events' : 'lock'}</i>
                        <div class="mdui-list-item-content">
                            <div class="mdui-list-item-title">${ach.title}</div>
                            <div class="mdui-list-item-text">${ach.desc}</div>
                        </div>
                        ${isUnlocked ? '<i class="mdui-icon material-icons mdui-text-color-green">check</i>' : ''}
                    `;
                    this.ui.achList.appendChild(div);
                });
                this.switchPage('page-achievements');
            },

            // --- æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ---
            start: function(selectedMode) {
                this.mode = selectedMode;
                this.score = 0;
                this.updateScore();
                clearInterval(this.timerInterval);
                
                // UI é‡ç½®
                this.ui.flagImg.classList.remove('mirror-effect');
                this.ui.timerBar.style.display = 'none';
                this.ui.textTimer.style.display = 'none';
                this.ui.babyHint.style.display = 'none'; // é»˜è®¤éšè—å®å®æç¤º

                const modeConfig = {
                    'practice': 'ç»ƒä¹ æ¨¡å¼',
                    'baby': 'å®å®æ¨¡å¼',
                    'endless': 'æ— å°½æ¨¡å¼',
                    'extreme': 'æé™æ¨¡å¼',
                    'hell': 'åœ°ç‹±æ¨¡å¼',
                    'timeattack': '60ç§’ç«é€Ÿ',
                    'mirror': 'é•œåƒæ¨¡å¼'
                };
                this.ui.modeName.innerText = modeConfig[selectedMode];

                // æ¨¡å¼ç‰¹å®šåˆå§‹åŒ–
                if (this.mode === 'hell') {
                    this.ui.timerBar.style.display = 'block';
                    this.timeLimit = 5000;
                } else if (this.mode === 'timeattack') {
                    this.ui.textTimer.style.display = 'block';
                    this.startTimeAttack(60);
                } else if (this.mode === 'mirror') {
                    this.ui.flagImg.classList.add('mirror-effect');
                } else if (this.mode === 'baby') {
                    this.ui.babyHint.style.display = 'block'; // å®å®æ¨¡å¼æ˜¾ç¤ºæç¤ºåŒºåŸŸ
                }

                this.switchPage('page-game');
                this.nextRound();
            },

            nextRound: function() {
                if (this.mode !== 'timeattack') {
                    clearInterval(this.timerInterval);
                }

                const correctIndex = Math.floor(Math.random() * countryData.length);
                const correctCountry = countryData[correctIndex];
                let options = [correctCountry];
                while (options.length < 4) {
                    const random = countryData[Math.floor(Math.random() * countryData.length)];
                    if (!options.includes(random)) options.push(random);
                }
                options.sort(() => Math.random() - 0.5);
                this.currentQuestion = { correct: correctCountry, options: options };

                this.renderQuestion();

                if (this.mode === 'hell') {
                    this.startQuestionTimer();
                }
            },

            renderQuestion: function() {
                this.ui.flagLoading.style.display = 'inline-block';
                this.ui.flagImg.style.display = 'none';
                this.ui.flagImg.src = `https://flagcdn.com/w640/${this.currentQuestion.correct.code}.png`;

                // å®å®æ¨¡å¼ï¼šè®¾ç½®æç¤ºæ–‡å­—
                if (this.mode === 'baby') {
                    this.ui.babyHint.innerText = this.currentQuestion.correct.name;
                }

                this.ui.options.innerHTML = '';
                this.currentQuestion.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'mdui-btn mdui-btn-raised mdui-ripple mdui-color-white option-btn';
                    btn.innerText = opt.name;
                    btn.onclick = (e) => this.handleAnswer(opt, e.target);
                    this.ui.options.appendChild(btn);
                });
            },

            startQuestionTimer: function() {
                this.timeRemaining = this.timeLimit;
                this.ui.timerFill.style.width = '100%';
                
                const step = 50;
                this.timerInterval = setInterval(() => {
                    this.timeRemaining -= step;
                    const percent = (this.timeRemaining / this.timeLimit) * 100;
                    this.ui.timerFill.style.width = percent + '%';

                    if (this.timeRemaining <= 0) {
                        clearInterval(this.timerInterval);
                        this.gameOver('æ—¶é—´åˆ°ï¼ååº”å¤ªæ…¢å•¦ï¼');
                    }
                }, step);
            },

            startTimeAttack: function(seconds) {
                this.timeRemaining = seconds * 1000;
                this.updateTextTimer();
                
                const step = 100;
                this.timerInterval = setInterval(() => {
                    this.timeRemaining -= step;
                    this.updateTextTimer();

                    if (this.timeRemaining <= 0) {
                        clearInterval(this.timerInterval);
                        this.gameOver('æ—¶é—´åˆ°ï¼æ¯”èµ›ç»“æŸã€‚');
                    }
                }, step);
            },

            updateTextTimer: function() {
                let sec = Math.ceil(this.timeRemaining / 1000);
                if (sec < 0) sec = 0;
                this.ui.textTimerVal.innerText = sec;
            },

            handleAnswer: function(selected, btnElement) {
                if (this.mode !== 'timeattack') {
                    clearInterval(this.timerInterval);
                }
                
                const allBtns = this.ui.options.querySelectorAll('button');
                allBtns.forEach(b => b.disabled = true);

                const isCorrect = selected.code === this.currentQuestion.correct.code;

                if (isCorrect) {
                    btnElement.classList.remove('mdui-color-white');
                    btnElement.classList.add('mdui-color-green-500', 'mdui-text-color-white');
                    
                    if (this.mode !== 'practice') {
                        this.score++;
                        this.updateScore();
                        this.checkAchievements();
                    }
                    
                    // å®å®æ¨¡å¼æˆ–ç»ƒä¹ æ¨¡å¼æ˜¾ç¤ºæç¤º
                    if(this.mode === 'practice' || this.mode === 'baby') mdui.snackbar({message: 'çœŸæ£’ï¼å›ç­”æ­£ç¡®ï¼', position: 'top', timeout: 500});
                    setTimeout(() => this.nextRound(), 500);
                } else {
                    btnElement.classList.remove('mdui-color-white');
                    btnElement.classList.add('mdui-color-red-500', 'mdui-text-color-white');
                    
                    allBtns.forEach(b => {
                        if (b.innerText === this.currentQuestion.correct.name) {
                            b.classList.remove('mdui-color-white');
                            b.classList.add('mdui-color-green-500', 'mdui-text-color-white');
                        }
                    });

                    // å®å®æ¨¡å¼ä¹Ÿå±äºâ€œæ— æƒ©ç½šâ€æ¨¡å¼
                    if (this.mode === 'practice' || this.mode === 'endless' || this.mode === 'mirror' || this.mode === 'baby') {
                        if(this.mode !== 'practice' && this.mode !== 'baby') mdui.snackbar({message: 'ç­”é”™å•¦ï¼Œç»§ç»­åŠ æ²¹ï¼', position: 'top'});
                        setTimeout(() => this.nextRound(), 1500);
                    } else if (this.mode === 'timeattack') {
                        this.timeRemaining -= 2000;
                        mdui.snackbar({message: 'ç­”é”™æ‰£2ç§’ï¼', position: 'top', timeout: 500});
                        setTimeout(() => this.nextRound(), 500);
                    } else {
                        setTimeout(() => this.gameOver(`é€‰é”™äº†ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${this.currentQuestion.correct.name}`), 1000);
                    }
                }
            },

            updateScore: function() {
                this.ui.score.innerText = `å¾—åˆ†: ${this.score}`;
            },

            gameOver: function(reason) {
                clearInterval(this.timerInterval);
                this.ui.finalScore.innerText = this.score;
                this.ui.resultReason.innerText = reason;
                this.checkAchievements();
                this.switchPage('page-result');
            }
        };
    </script>
</body>
</html>

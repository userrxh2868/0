<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>小壮浏览器 Pro</title>
    <!-- 引入 Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* --- 核心变量定义 --- */
        :root {
            /* 默认种子颜色生成的色板 (紫色系) */
            --seed-color: #6750A4;
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-surface: #FEF7FF;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-container-high: #ECE6F0;
            --md-sys-color-on-surface: #1D1B20;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;

            /* 动画曲线 */
            --anim-standard: cubic-bezier(0.2, 0.0, 0, 1.0);
            --anim-emphasized: cubic-bezier(0.2, 0.0, 0, 1.0);
            
            /* 常用尺寸 */
            --radius-full: 9999px;
            --radius-lg: 28px;
            --radius-md: 16px;
            --radius-sm: 12px;
        }

        /* 深色模式变量覆盖 */
        [data-theme="dark"] {
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            --md-sys-color-surface: #141218;
            --md-sys-color-surface-container: #211F26;
            --md-sys-color-surface-container-high: #2B2930;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-outline-variant: #49454F;
        }

        /* --- 全局基础样式 --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: system-ui, -apple-system, Roboto, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            transition: background-color 0.4s var(--anim-standard), color 0.4s var(--anim-standard);
            display: flex;
            flex-direction: column;
        }

        /* 图标大小统一 */
        .material-symbols-rounded { font-size: 24px; font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .icon-filled { font-variation-settings: 'FILL' 1 !important; }

        /* --- 视图容器 --- */
        .view-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--md-sys-color-surface);
            transition: transform 0.5s var(--anim-emphasized), opacity 0.3s var(--anim-emphasized);
            z-index: 1;
        }

        .view-hidden {
            pointer-events: none;
            opacity: 0;
            transform: scale(0.92);
            z-index: 0;
        }
        
        .view-active {
            opacity: 1;
            transform: scale(1);
            z-index: 2;
        }

        /* --- 首页 (Home View) --- */
        #home-view {
            padding: 24px;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .brand-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 48px;
            animation: fadeInDown 0.8s var(--anim-emphasized);
        }

        .brand-logo {
            font-size: 72px;
            color: var(--md-sys-color-primary);
            text-shadow: 0 4px 12px var(--md-sys-color-primary-container);
        }

        .brand-name {
            font-size: 28px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            letter-spacing: -0.5px;
        }

        /* 搜索框 */
        .search-box-wrapper {
            width: 100%;
            max-width: 420px;
            position: relative;
            margin-bottom: 40px;
            z-index: 10;
        }

        .search-box {
            width: 100%;
            height: 56px;
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.3s var(--anim-standard);
            border: 1px solid transparent;
        }

        .search-box:focus-within {
            background: var(--md-sys-color-surface-container);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
            border-color: var(--md-sys-color-primary);
        }

        .search-input {
            flex: 1;
            height: 100%;
            border: none;
            background: transparent;
            margin: 0 12px;
            font-size: 16px;
            color: var(--md-sys-color-on-surface);
        }

        /* 快捷方式网格 */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px 16px;
            width: 100%;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
        }

        .shortcut-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            cursor: pointer;
            animation: popUp 0.4s var(--anim-emphasized) backwards;
        }

        .shortcut-icon {
            width: 56px;
            height: 56px;
            background: var(--md-sys-color-surface-container-high);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--md-sys-color-primary);
            transition: transform 0.2s var(--anim-standard), background 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        /* Ripple effect fake */
        .shortcut-item:active .shortcut-icon {
            transform: scale(0.92);
            background: var(--md-sys-color-primary-container);
        }

        .shortcut-label {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
        }

        .shortcut-delete {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 22px;
            height: 22px;
            background: var(--md-sys-color-error);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            transform: scale(0);
            transition: transform 0.2s var(--anim-standard);
        }

        .editing .shortcut-delete { transform: scale(1); }
        .editing .shortcut-icon { animation: shake 0.3s infinite alternate; }

        @keyframes shake { from { transform: rotate(-3deg); } to { transform: rotate(3deg); } }
        @keyframes popUp { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* 底部 FAB 工具栏 */
        .home-bottom-bar {
            position: absolute;
            bottom: 32px;
            display: flex;
            gap: 24px;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
            transition: all 0.2s var(--anim-standard);
            cursor: pointer;
        }
        
        .fab.active { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .fab:active { transform: scale(0.95); box-shadow: 0 2px 4px rgba(0,0,0,0.12); }

        /* --- 浏览器 (Browser View) --- */
        #browser-view { background: var(--md-sys-color-surface); }

        /* 顶部地址栏 */
        .browser-top-bar {
            height: 64px;
            background: var(--md-sys-color-surface);
            display: flex;
            align-items: center;
            padding: 8px 16px;
            gap: 12px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            position: relative;
        }
        
        .url-input-wrapper {
            flex: 1;
            height: 40px;
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            padding: 0 16px;
            transition: background 0.2s;
        }

        .url-input-wrapper:focus-within { background: var(--md-sys-color-secondary-container); }
        
        .url-input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
        }

        /* 加载进度条 */
        .progress-bar {
            position: absolute;
            bottom: -1px; left: 0; height: 2px;
            background: var(--md-sys-color-primary);
            width: 0%;
            transition: width 0.2s linear, opacity 0.3s;
            z-index: 10;
        }

        /* 内容区 */
        .browser-frame-container {
            flex: 1;
            width: 100%;
            position: relative;
            background: #fff; /* 网页背景通常是白色的 */
        }

        iframe { width: 100%; height: 100%; border: none; }

        .browser-placeholder {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface-variant);
            z-index: 5;
        }

        /* 底部导航 */
        .browser-bottom-nav {
            height: 56px;
            background: var(--md-sys-color-surface-container);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--md-sys-color-on-surface-variant);
            padding: 8px 16px;
            border-radius: var(--radius-full);
            transition: background 0.2s;
        }
        
        .nav-btn:active { background: var(--md-sys-color-on-surface-variant); color: var(--md-sys-color-surface); opacity: 0.2; }

        /* --- 对话框 & 抽屉 (Overlays) --- */
        .overlay-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center; /* 对话框居中 */
            justify-content: center;
        }
        
        .overlay-backdrop.active { opacity: 1; pointer-events: auto; }

        /* 底部抽屉 */
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: var(--md-sys-color-surface-container);
            border-radius: 28px 28px 0 0;
            padding: 24px;
            transform: translateY(100%);
            transition: transform 0.4s var(--anim-emphasized);
        }

        .overlay-backdrop.active .bottom-sheet { transform: translateY(0); }
        
        .sheet-drag-handle { width: 32px; height: 4px; background: var(--md-sys-color-outline-variant); border-radius: 2px; margin: 0 auto 24px; }
        
        .setting-section { margin-bottom: 24px; }
        .setting-title { font-size: 14px; color: var(--md-sys-color-primary); font-weight: 500; margin-bottom: 12px; }
        
        .chips-container { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .chip {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--md-sys-color-outline);
            font-size: 14px;
            background: transparent;
            color: var(--md-sys-color-on-surface-variant);
            transition: all 0.2s;
        }
        
        .chip.selected {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border-color: transparent;
            font-weight: 500;
        }
        
        .color-dot { width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent; }
        .color-dot.selected { border-color: var(--md-sys-color-on-surface); }

        /* 对话框 (Dialog) */
        .dialog-card {
            background: var(--md-sys-color-surface-container-high);
            width: 85%; max-width: 320px;
            border-radius: 28px;
            padding: 24px;
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s var(--anim-emphasized);
        }
        
        .overlay-backdrop.active .dialog-card { transform: scale(1); opacity: 1; }
        
        .dialog-title { font-size: 24px; margin-bottom: 16px; color: var(--md-sys-color-on-surface); }
        
        .md-input-field {
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            padding: 12px;
            width: 100%;
            margin-bottom: 16px;
            color: var(--md-sys-color-on-surface);
            transition: border 0.2s;
        }
        
        .md-input-field:focus { border-color: var(--md-sys-color-primary); border-width: 2px; padding: 11px; }
        
        .dialog-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
        
        .text-btn { background: none; border: none; color: var(--md-sys-color-primary); font-weight: 500; padding: 10px 20px; border-radius: 20px; font-size: 14px; }
        .fill-btn { background: var(--md-sys-color-primary); border: none; color: var(--md-sys-color-on-primary); font-weight: 500; padding: 10px 24px; border-radius: 20px; font-size: 14px; }

    </style>
</head>
<body>

    <!-- 主页视图 -->
    <div id="home-view" class="view-container view-active">
        <div class="brand-header">
            <span class="material-symbols-rounded brand-logo">rocket_launch</span>
            <div class="brand-name">小壮浏览器</div>
        </div>

        <div class="search-box-wrapper">
            <div class="search-box">
                <span class="material-symbols-rounded" style="color: var(--md-sys-color-outline);">search</span>
                <input type="text" class="search-input" id="home-search-input" placeholder="搜索或输入网址..." autocomplete="off">
                <span class="material-symbols-rounded" style="color: var(--md-sys-color-primary); cursor: pointer" onclick="app.navigate()">arrow_forward</span>
            </div>
        </div>

        <div class="shortcuts-grid" id="shortcuts-grid">
            <!-- JS 生成 -->
        </div>

        <div class="home-bottom-bar">
            <button class="fab" id="edit-mode-btn" onclick="app.toggleEditMode()">
                <span class="material-symbols-rounded">edit</span>
            </button>
            <button class="fab" onclick="app.openSettings()">
                <span class="material-symbols-rounded">settings</span>
            </button>
        </div>
    </div>

    <!-- 浏览器视图 -->
    <div id="browser-view" class="view-container view-hidden">
        <div class="browser-top-bar">
            <div class="url-input-wrapper">
                <span class="material-symbols-rounded" style="font-size: 18px; color: var(--md-sys-color-outline); margin-right:8px;">lock</span>
                <input type="text" class="url-input" id="browser-url-input" onkeydown="if(event.key==='Enter') app.navigateFromBrowser()">
                <span class="material-symbols-rounded" style="font-size: 20px; color: var(--md-sys-color-on-surface-variant); cursor: pointer" onclick="location.reload()">refresh</span>
            </div>
        </div>
        
        <!-- 进度条 -->
        <div class="progress-bar" id="progress-bar"></div>

        <div class="browser-frame-container">
            <iframe id="web-frame" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-top-navigation-by-user-activation"></iframe>
            <!-- 如果加载失败或初始状态 -->
            <div id="frame-placeholder" class="browser-placeholder" style="display: none;">
                <span class="material-symbols-rounded" style="font-size: 48px; margin-bottom:16px; opacity:0.5">web_asset_off</span>
                <p>安全策略限制：部分网站禁止嵌入</p>
            </div>
        </div>

        <div class="browser-bottom-nav">
            <button class="nav-btn" onclick="app.goHome()"><span class="material-symbols-rounded icon-filled">home</span></button>
            <button class="nav-btn" onclick="history.back()"><span class="material-symbols-rounded">arrow_back_ios</span></button>
            <button class="nav-btn" onclick="history.forward()"><span class="material-symbols-rounded">arrow_forward_ios</span></button>
            <button class="nav-btn" onclick="app.openSettings()"><span class="material-symbols-rounded">menu</span></button>
        </div>
    </div>

    <!-- 设置抽屉 -->
    <div class="overlay-backdrop" id="settings-overlay" onclick="if(event.target===this) app.closeSettings()">
        <div class="bottom-sheet">
            <div class="sheet-drag-handle"></div>
            
            <div class="setting-section">
                <div class="setting-title">搜索引擎</div>
                <div class="chips-container" id="engine-options">
                    <button class="chip" onclick="app.setEngine('bing')">必应</button>
                    <button class="chip" onclick="app.setEngine('baidu')">百度</button>
                    <button class="chip" onclick="app.setEngine('google')">谷歌</button>
                    <button class="chip" onclick="app.setEngine('fsou')">F搜</button>
                </div>
            </div>

            <div class="setting-section">
                <div class="setting-title">外观主题</div>
                <div class="chips-container">
                    <button class="chip" id="theme-light" onclick="app.setThemeMode('light')">浅色</button>
                    <button class="chip" id="theme-dark" onclick="app.setThemeMode('dark')">深色</button>
                    <button class="chip" id="theme-auto" onclick="app.setThemeMode('auto')">跟随系统</button>
                </div>
            </div>

            <div class="setting-section">
                <div class="setting-title">个性化颜色 (Monet)</div>
                <div class="chips-container">
                    <div class="color-dot" style="background:#6750A4" onclick="app.setAccentColor('#6750A4')"></div>
                    <div class="color-dot" style="background:#006C4C" onclick="app.setAccentColor('#006C4C')"></div>
                    <div class="color-dot" style="background:#9A25AE" onclick="app.setAccentColor('#9A25AE')"></div>
                    <div class="color-dot" style="background:#B3261E" onclick="app.setAccentColor('#B3261E')"></div>
                    <div class="color-dot" style="background:#3344AA" onclick="app.setAccentColor('#3344AA')"></div>
                </div>
            </div>
            
            <div style="height: 20px;"></div>
        </div>
    </div>

    <!-- 添加快捷方式对话框 -->
    <div class="overlay-backdrop" id="add-shortcut-overlay">
        <div class="dialog-card">
            <div class="dialog-title">添加快捷方式</div>
            <input type="text" class="md-input-field" id="new-shortcut-name" placeholder="名称 (例如: 哔哩哔哩)">
            <input type="text" class="md-input-field" id="new-shortcut-url" placeholder="网址 (例如: bilibili.com)">
            <div class="dialog-actions">
                <button class="text-btn" onclick="app.closeDialog()">取消</button>
                <button class="fill-btn" onclick="app.saveShortcut()">添加</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * 小壮浏览器核心逻辑类
         * 包含数据持久化、UI交互、MD3色彩计算
         */
        class XiaoZhuangBrowser {
            constructor() {
                // 默认配置
                this.defaultShortcuts = [
                    { name: '必应', url: 'https://cn.bing.com', icon: 'search' },
                    { name: '维基', url: 'https://zh.m.wikipedia.org', icon: 'menu_book' },
                    { name: '知乎', url: 'https://www.zhihu.com', icon: 'question_mark' },
                    { name: 'Github', url: 'https://github.com', icon: 'code' }
                ];
                
                this.engines = {
                    bing: { url: 'https://cn.bing.com/search?q=', name: '必应' },
                    baidu: { url: 'https://www.baidu.com/s?wd=', name: '百度' },
                    google: { url: 'https://www.google.com/search?q=', name: '谷歌' },
                    fsou: { url: 'https://fsoufsou.com/search?q=', name: 'F搜' }
                };

                this.state = {
                    engine: 'bing',
                    themeMode: 'auto',
                    accentColor: '#6750A4',
                    shortcuts: [],
                    isEditMode: false
                };

                this.loadState();
                this.initUI();
            }

            // --- 初始化与存储 ---
            loadState() {
                const localData = localStorage.getItem('xz_browser_data');
                if (localData) {
                    const parsed = JSON.parse(localData);
                    this.state = { ...this.state, ...parsed };
                } else {
                    this.state.shortcuts = [...this.defaultShortcuts];
                }
                // 首次加载应用设置
                this.applyTheme();
                this.updateEngineUI();
            }

            saveState() {
                // 保存除临时状态(isEditMode)外的所有数据
                const toSave = { ...this.state, isEditMode: false };
                localStorage.setItem('xz_browser_data', JSON.stringify(toSave));
            }

            initUI() {
                this.renderShortcuts();
                
                // 绑定主页回车事件
                document.getElementById('home-search-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.navigate();
                });

                // 监听系统深色模式变化
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (this.state.themeMode === 'auto') this.applyTheme();
                });
            }

            // --- 核心浏览功能 ---
            navigate(url = null) {
                const input = document.getElementById('home-search-input');
                const query = url || input.value.trim();
                if (!query) return;

                // 智能URL识别
                let targetUrl = '';
                const urlPattern = /^((http|https):\/\/)?(([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,})(:[0-9]+)?(\/.*)?$/;
                
                if (urlPattern.test(query)) {
                    targetUrl = query.startsWith('http') ? query : 'https://' + query;
                } else {
                    targetUrl = this.engines[this.state.engine].url + encodeURIComponent(query);
                }

                // 切换界面
                document.getElementById('home-view').classList.remove('view-active');
                document.getElementById('home-view').classList.add('view-hidden');
                
                const browserView = document.getElementById('browser-view');
                browserView.classList.remove('view-hidden');
                browserView.classList.add('view-active');

                // 更新浏览器栏
                document.getElementById('browser-url-input').value = targetUrl;
                
                // 加载动画
                this.loadUrl(targetUrl);
            }

            navigateFromBrowser() {
                const val = document.getElementById('browser-url-input').value;
                this.navigate(val);
            }

            loadUrl(url) {
                const iframe = document.getElementById('web-frame');
                const progressBar = document.getElementById('progress-bar');
                const placeholder = document.getElementById('frame-placeholder');

                // 重置状态
                placeholder.style.display = 'none';
                iframe.style.display = 'block';
                
                // 假进度条动画
                progressBar.style.opacity = 1;
                progressBar.style.width = '20%';
                setTimeout(() => progressBar.style.width = '60%', 300);
                setTimeout(() => progressBar.style.width = '90%', 800);

                iframe.src = url;

                iframe.onload = () => {
                    progressBar.style.width = '100%';
                    setTimeout(() => progressBar.style.opacity = 0, 200);
                    setTimeout(() => progressBar.style.width = '0%', 400);
                };
                
                // 简单的错误处理（实际上跨域无法捕获详细错误，这里做个基本兜底）
                iframe.onerror = () => {
                    iframe.style.display = 'none';
                    placeholder.style.display = 'flex';
                }
            }

            goHome() {
                document.getElementById('browser-view').classList.remove('view-active');
                document.getElementById('browser-view').classList.add('view-hidden');
                
                const homeView = document.getElementById('home-view');
                homeView.classList.remove('view-hidden');
                homeView.classList.add('view-active');
                
                // 清理 iframe 以释放内存
                document.getElementById('web-frame').src = 'about:blank';
                document.getElementById('home-search-input').value = '';
            }

            // --- 快捷方式管理 ---
            renderShortcuts() {
                const grid = document.getElementById('shortcuts-grid');
                grid.innerHTML = '';

                this.state.shortcuts.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = `shortcut-item ${this.state.isEditMode ? 'editing' : ''}`;
                    // 延迟动画
                    el.style.animationDelay = `${index * 50}ms`;
                    
                    el.innerHTML = `
                        <div class="shortcut-icon" onclick="app.onShortcutClick(${index})">
                            <span class="material-symbols-rounded">${item.icon || 'public'}</span>
                            <div class="shortcut-delete" onclick="event.stopPropagation(); app.deleteShortcut(${index})">
                                <span class="material-symbols-rounded" style="font-size:16px">close</span>
                            </div>
                        </div>
                        <span class="shortcut-label">${item.name}</span>
                    `;
                    grid.appendChild(el);
                });

                // 添加按钮
                const addBtn = document.createElement('div');
                addBtn.className = 'shortcut-item';
                addBtn.innerHTML = `
                    <div class="shortcut-icon" style="background:transparent; border:1px dashed var(--md-sys-color-outline);" onclick="app.openAddDialog()">
                        <span class="material-symbols-rounded" style="color:var(--md-sys-color-on-surface)">add</span>
                    </div>
                    <span class="shortcut-label">添加</span>
                `;
                grid.appendChild(addBtn);
            }

            onShortcutClick(index) {
                if (this.state.isEditMode) return;
                this.navigate(this.state.shortcuts[index].url);
            }

            toggleEditMode() {
                this.state.isEditMode = !this.state.isEditMode;
                const btn = document.getElementById('edit-mode-btn');
                if (this.state.isEditMode) btn.classList.add('active');
                else btn.classList.remove('active');
                this.renderShortcuts();
            }

            deleteShortcut(index) {
                this.state.shortcuts.splice(index, 1);
                this.saveState();
                this.renderShortcuts();
            }

            // --- 对话框逻辑 ---
            openAddDialog() {
                document.getElementById('add-shortcut-overlay').classList.add('active');
            }

            closeDialog() {
                document.getElementById('add-shortcut-overlay').classList.remove('active');
                document.getElementById('new-shortcut-name').value = '';
                document.getElementById('new-shortcut-url').value = '';
            }

            saveShortcut() {
                const name = document.getElementById('new-shortcut-name').value;
                let url = document.getElementById('new-shortcut-url').value;
                
                if (name && url) {
                    if (!url.startsWith('http')) url = 'https://' + url;
                    this.state.shortcuts.push({ name, url, icon: 'link' });
                    this.saveState();
                    this.renderShortcuts();
                    this.closeDialog();
                }
            }

            // --- 设置 & 主题逻辑 ---
            openSettings() {
                document.getElementById('settings-overlay').classList.add('active');
                this.updateEngineUI();
            }

            closeSettings() {
                document.getElementById('settings-overlay').classList.remove('active');
            }

            setEngine(key) {
                this.state.engine = key;
                this.saveState();
                this.updateEngineUI();
            }

            updateEngineUI() {
                const container = document.getElementById('engine-options');
                Array.from(container.children).forEach(btn => {
                    btn.classList.remove('selected');
                    // 简单的文本匹配逻辑来高亮
                    if(btn.innerText === this.engines[this.state.engine].name) {
                        btn.classList.add('selected');
                    }
                });
            }

            setThemeMode(mode) {
                this.state.themeMode = mode;
                this.saveState();
                this.applyTheme();
                
                // 更新UI高亮
                ['light', 'dark', 'auto'].forEach(m => {
                    const el = document.getElementById(`theme-${m}`);
                    if (m === mode) el.classList.add('selected');
                    else el.classList.remove('selected');
                });
            }

            setAccentColor(hex) {
                this.state.accentColor = hex;
                this.saveState();
                this.applyTheme();
                // 这里可以遍历 color-dot 添加 selected 样式，略
            }

            applyTheme() {
                // 1. 处理深色/浅色模式
                let isDark = false;
                if (this.state.themeMode === 'dark') isDark = true;
                else if (this.state.themeMode === 'auto') {
                    isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                }

                if (isDark) document.documentElement.setAttribute('data-theme', 'dark');
                else document.documentElement.removeAttribute('data-theme');

                // 2. 处理主题色 (简化版 Monet 算法模拟)
                // 实际上完整的动态取色需要复杂的 HSL 转换，这里用透明度模拟变体
                const root = document.documentElement;
                const c = this.state.accentColor;

                // 这里是一个非常简单的 hack，真正的 MD3 需要 JS 库如 material-color-utilities
                // 但为了保持单文件且不依赖外部重型库，我们直接改变 --md-sys-color-primary
                // 并利用 CSS 变量的 fallback 或透明度
                
                if (!isDark) {
                   root.style.setProperty('--md-sys-color-primary', c);
                   root.style.setProperty('--md-sys-color-primary-container', c + '25'); // 15% opacity
                   root.style.setProperty('--md-sys-color-on-primary-container', c); 
                } else {
                   // 深色模式下主色通常更亮
                   root.style.setProperty('--md-sys-color-primary', c); // 理想情况应该调亮
                   root.style.setProperty('--md-sys-color-primary-container', c + '50');
                }
            }
        }

        // --- 启动应用 ---
        const app = new XiaoZhuangBrowser();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>小说查看器</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            --md-sys-color-background: #FFFBFE;
            --md-sys-color-on-background: #1C1B1F;
            --md-sys-color-error: #B3261E;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-container-low: #F7F2FA;
            --md-sys-color-surface-container-high: #ECE6F0;
            --md-sys-color-inverse-surface: #313033;
            --md-sys-color-inverse-on-surface: #F4EFF4;
            
            --reading-bg: #FFFBFE;
            --reading-text: #1C1B1F;
            --font-size: 18px;
            --line-height: 1.8;
        }

        [data-theme="dark"] {
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-on-secondary: #332D41;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-outline-variant: #49454F;
            --md-sys-color-background: #1C1B1F;
            --md-sys-color-on-background: #E6E1E5;
            --md-sys-color-surface-container: #211F26;
            --md-sys-color-surface-container-low: #1D1B20;
            --md-sys-color-surface-container-high: #2B2930;
            --md-sys-color-inverse-surface: #E6E1E5;
            --md-sys-color-inverse-on-surface: #313033;
            
            --reading-bg: #1C1B1F;
            --reading-text: #E6E1E5;
        }

        [data-theme="sepia"] {
            --reading-bg: #F5E6D3;
            --reading-text: #5B4636;
        }

        [data-theme="green"] {
            --reading-bg: #E8F5E9;
            --reading-text: #2E4A32;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 顶部应用栏 */
        .top-app-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background-color: var(--md-sys-color-surface);
            display: flex;
            align-items: center;
            padding: 0 8px;
            z-index: 100;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }

        .top-app-bar.hidden {
            transform: translateY(-100%);
        }

        .top-app-bar-title {
            flex: 1;
            font-size: 22px;
            font-weight: 400;
            margin-left: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 图标按钮 */
        .icon-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            position: relative;
            overflow: hidden;
        }

        .icon-btn:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        .icon-btn:active {
            background-color: var(--md-sys-color-outline-variant);
        }

        .icon-btn .material-icons-round {
            font-size: 24px;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            border: none;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 5px -1px rgba(0,0,0,.2), 0 6px 10px 0 rgba(0,0,0,.14), 0 1px 18px 0 rgba(0,0,0,.12);
            transition: all 0.3s ease;
            z-index: 90;
        }

        .fab:hover {
            box-shadow: 0 5px 5px -3px rgba(0,0,0,.2), 0 8px 10px 1px rgba(0,0,0,.14), 0 3px 14px 2px rgba(0,0,0,.12);
        }

        .fab .material-icons-round {
            font-size: 24px;
        }

        /* 底部导航栏 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background-color: var(--md-sys-color-surface-container);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 64px;
        }

        .nav-item.active {
            color: var(--md-sys-color-on-secondary-container);
        }

        .nav-item .nav-icon {
            width: 64px;
            height: 32px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .nav-item.active .nav-icon {
            background-color: var(--md-sys-color-secondary-container);
        }

        .nav-item .nav-label {
            font-size: 12px;
            margin-top: 4px;
            font-weight: 500;
        }

        /* 页面容器 */
        .page {
            display: none;
            padding-top: 64px;
            padding-bottom: 80px;
            min-height: 100vh;
        }

        .page.active {
            display: block;
        }

        /* 书架页面 */
        .bookshelf {
            padding: 16px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            text-align: center;
        }

        .empty-state .material-icons-round {
            font-size: 96px;
            color: var(--md-sys-color-outline);
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 24px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            max-width: 280px;
        }

        /* 书籍网格 */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
        }

        .book-card {
            background-color: var(--md-sys-color-surface-container-low);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .book-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .book-cover {
            width: 100%;
            aspect-ratio: 3/4;
            background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-secondary-container));
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .book-cover-text {
            font-size: 18px;
            font-weight: 500;
            color: var(--md-sys-color-on-primary-container);
            text-align: center;
            word-break: break-word;
            line-height: 1.3;
        }

        .book-info {
            padding: 12px;
        }

        .book-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .book-progress {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .book-menu-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: rgba(0,0,0,0.3);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .book-card:hover .book-menu-btn {
            opacity: 1;
        }

        /* 阅读页面 */
        .reader-page {
            padding-top: 0;
            padding-bottom: 0;
        }

        .reader-page .top-app-bar {
            background-color: rgba(0,0,0,0.5);
            color: white;
        }

        .reader-container {
            min-height: 100vh;
            background-color: var(--reading-bg);
            color: var(--reading-text);
            padding: 80px 20px;
            font-size: var(--font-size);
            line-height: var(--line-height);
            transition: all 0.3s ease;
        }

        .reader-content {
            max-width: 800px;
            margin: 0 auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .reader-content p {
            text-indent: 2em;
            margin-bottom: 0.5em;
        }

        /* 阅读器底部工具栏 */
        .reader-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.8);
            padding: 16px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .reader-toolbar.visible {
            transform: translateY(0);
        }

        .toolbar-row {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin-bottom: 16px;
        }

        .toolbar-row:last-child {
            margin-bottom: 0;
        }

        .toolbar-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .toolbar-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .toolbar-btn.active {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .progress-bar-container {
            flex: 1;
            margin: 0 16px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            outline: none;
        }

        .progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--md-sys-color-primary);
            cursor: pointer;
        }

        .progress-text {
            color: white;
            font-size: 12px;
            text-align: center;
            margin-top: 8px;
        }

        /* 设置页面 */
        .settings-page {
            padding: 16px;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-primary);
            margin-bottom: 8px;
            padding: 0 16px;
        }

        .settings-card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: 16px;
            overflow: hidden;
        }

        .settings-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
        }

        .settings-item-content {
            flex: 1;
        }

        .settings-item-title {
            font-size: 16px;
            color: var(--md-sys-color-on-surface);
        }

        .settings-item-subtitle {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 2px;
        }

        /* 开关 */
        .switch {
            position: relative;
            width: 52px;
            height: 32px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--md-sys-color-surface-variant);
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 16px;
            transition: 0.3s;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 6px;
            bottom: 6px;
            background-color: var(--md-sys-color-outline);
            border-radius: 50%;
            transition: 0.3s;
        }

        .switch input:checked + .switch-slider {
            background-color: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }

        .switch input:checked + .switch-slider:before {
            transform: translateX(20px);
            background-color: var(--md-sys-color-on-primary);
            width: 24px;
            height: 24px;
            bottom: 2px;
            left: 2px;
        }

        /* 主题选择 */
        .theme-options {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .theme-option {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-option.active {
            border-color: var(--md-sys-color-primary);
        }

        .theme-option.light {
            background-color: #FFFBFE;
        }

        .theme-option.dark {
            background-color: #1C1B1F;
        }

        .theme-option.sepia {
            background-color: #F5E6D3;
        }

        .theme-option.green {
            background-color: #E8F5E9;
        }

        /* 字体大小控制 */
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .font-size-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .font-size-btn:hover {
            transform: scale(1.1);
        }

        .font-size-value {
            min-width: 48px;
            text-align: center;
            font-size: 16px;
            color: var(--md-sys-color-on-surface);
        }

        /* 模态框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 24px;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--md-sys-color-surface);
            border-radius: 28px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 24px 24px 16px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
        }

        .modal-content {
            padding: 0 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .modal-actions {
            padding: 24px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* 按钮 */
        .btn {
            padding: 10px 24px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-text {
            background: transparent;
            color: var(--md-sys-color-primary);
        }

        .btn-text:hover {
            background-color: var(--md-sys-color-primary-container);
        }

        .btn-filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .btn-filled:hover {
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* 章节列表 */
        .chapter-list {
            list-style: none;
        }

        .chapter-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chapter-item:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        .chapter-item.current {
            color: var(--md-sys-color-primary);
            font-weight: 500;
        }

        /* 书签列表 */
        .bookmark-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .bookmark-content {
            flex: 1;
            cursor: pointer;
        }

        .bookmark-text {
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .bookmark-position {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 4px;
        }

        .bookmark-delete {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--md-sys-color-error);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 搜索栏 */
        .search-container {
            padding: 0 16px 16px;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: 28px;
            padding: 0 16px;
            height: 56px;
        }

        .search-bar .material-icons-round {
            color: var(--md-sys-color-on-surface-variant);
        }

        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0 16px;
            font-size: 16px;
            color: var(--md-sys-color-on-surface);
            outline: none;
        }

        .search-input::placeholder {
            color: var(--md-sys-color-on-surface-variant);
        }

        /* 搜索结果 */
        .search-result-item {
            padding: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            cursor: pointer;
        }

        .search-result-item:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        .search-highlight {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Snackbar */
        .snackbar {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--md-sys-color-inverse-surface);
            color: var(--md-sys-color-inverse-on-surface);
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 300;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: calc(100% - 32px);
            text-align: center;
        }

        .snackbar.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 隐藏文件输入 */
        .file-input {
            display: none;
        }

        /* 加载动画 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--md-sys-color-surface-variant);
            border-top-color: var(--md-sys-color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 响应式调整 */
        @media (max-width: 600px) {
            .books-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 12px;
            }

            .book-cover-text {
                font-size: 14px;
            }

            .reader-container {
                padding: 60px 16px 80px;
            }
        }

        /* 触摸区域 */
        .touch-area {
            position: fixed;
            top: 64px;
            bottom: 0;
            width: 25%;
            z-index: 50;
        }

        .touch-area.left {
            left: 0;
        }

        .touch-area.right {
            right: 0;
        }

        .touch-area.center {
            left: 25%;
            width: 50%;
        }

        /* 书签页 */
        .bookmarks-page {
            padding: 16px;
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--md-sys-color-outline);
            border-radius: 4px;
        }

        /* 阅读进度指示器 */
        .reading-progress {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background-color: var(--md-sys-color-primary);
            z-index: 150;
            transition: width 0.1s ease;
        }

        /* 菜单 */
        .context-menu {
            position: fixed;
            background-color: var(--md-sys-color-surface);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 300;
            min-width: 160px;
            display: none;
        }

        .context-menu.visible {
            display: block;
        }

        .menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        .menu-item .material-icons-round {
            margin-right: 12px;
            font-size: 20px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .menu-item span {
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
        }

        .menu-item.danger span {
            color: var(--md-sys-color-error);
        }

        .menu-item.danger .material-icons-round {
            color: var(--md-sys-color-error);
        }
    </style>
</head>
<body>
    <!-- 阅读进度条 -->
    <div class="reading-progress" id="readingProgress"></div>

    <!-- 主页面 -->
    <div class="page active" id="homePage">
        <!-- 顶部栏 -->
        <header class="top-app-bar">
            <span class="top-app-bar-title">小说查看器</span>
            <button class="icon-btn" id="searchBtn">
                <span class="material-icons-round">search</span>
            </button>
        </header>

        <!-- 书架 -->
        <div class="bookshelf" id="bookshelf">
            <div class="empty-state" id="emptyState">
                <span class="material-icons-round">menu_book</span>
                <h3>书架空空如也</h3>
                <p>点击右下角的按钮导入你的第一本小说吧</p>
            </div>
            <div class="books-grid" id="booksGrid"></div>
        </div>

        <!-- FAB -->
        <button class="fab" id="importFab">
            <span class="material-icons-round">add</span>
        </button>

        <!-- 底部导航 -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home">
                <div class="nav-icon">
                    <span class="material-icons-round">home</span>
                </div>
                <span class="nav-label">书架</span>
            </button>
            <button class="nav-item" data-page="bookmarks">
                <div class="nav-icon">
                    <span class="material-icons-round">bookmark</span>
                </div>
                <span class="nav-label">书签</span>
            </button>
            <button class="nav-item" data-page="settings">
                <div class="nav-icon">
                    <span class="material-icons-round">settings</span>
                </div>
                <span class="nav-label">设置</span>
            </button>
        </nav>
    </div>

    <!-- 书签页面 -->
    <div class="page" id="bookmarksPage">
        <header class="top-app-bar">
            <span class="top-app-bar-title">我的书签</span>
        </header>
        <div class="bookmarks-page" id="bookmarksList">
            <div class="empty-state">
                <span class="material-icons-round">bookmark_border</span>
                <h3>暂无书签</h3>
                <p>阅读时长按可以添加书签</p>
            </div>
        </div>
        <nav class="bottom-nav">
            <button class="nav-item" data-page="home">
                <div class="nav-icon">
                    <span class="material-icons-round">home</span>
                </div>
                <span class="nav-label">书架</span>
            </button>
            <button class="nav-item active" data-page="bookmarks">
                <div class="nav-icon">
                    <span class="material-icons-round">bookmark</span>
                </div>
                <span class="nav-label">书签</span>
            </button>
            <button class="nav-item" data-page="settings">
                <div class="nav-icon">
                    <span class="material-icons-round">settings</span>
                </div>
                <span class="nav-label">设置</span>
            </button>
        </nav>
    </div>

    <!-- 设置页面 -->
    <div class="page" id="settingsPage">
        <header class="top-app-bar">
            <span class="top-app-bar-title">设置</span>
        </header>
        <div class="settings-page">
            <div class="settings-section">
                <div class="settings-section-title">外观</div>
                <div class="settings-card">
                    <div class="settings-item">
                        <div class="settings-item-icon">
                            <span class="material-icons-round">dark_mode</span>
                        </div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">深色模式</div>
                            <div class="settings-item-subtitle">减少眼睛疲劳</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="darkModeSwitch">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-icon">
                            <span class="material-icons-round">palette</span>
                        </div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">阅读主题</div>
                            <div class="theme-options">
                                <div class="theme-option light active" data-theme="light" title="默认"></div>
                                <div class="theme-option dark" data-theme="dark" title="夜间"></div>
                                <div class="theme-option sepia" data-theme="sepia" title="护眼"></div>
                                <div class="theme-option green" data-theme="green" title="绿色"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">阅读</div>
                <div class="settings-card">
                    <div class="settings-item">
                        <div class="settings-item-icon">
                            <span class="material-icons-round">format_size</span>
                        </div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">字体大小</div>
                            <div class="font-size-control">
                                <button class="font-size-btn" id="fontDecrease">
                                    <span class="material-icons-round">remove</span>
                                </button>
                                <span class="font-size-value" id="fontSizeValue">18px</span>
                                <button class="font-size-btn" id="fontIncrease">
                                    <span class="material-icons-round">add</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-icon">
                            <span class="material-icons-round">format_line_spacing</span>
                        </div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">行间距</div>
                            <div class="font-size-control">
                                <button class="font-size-btn" id="lineHeightDecrease">
                                    <span class="material-icons-round">remove</span>
                                </button>
                                <span class="font-size-value" id="lineHeightValue">1.8</span>
                                <button class="font-size-btn" id="lineHeightIncrease">
                                    <span class="material-icons-round">add</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-icon">
                            <span class="material-icons-round">swap_horiz</span>
                        </div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">点击翻页</div>
                            <div class="settings-item-subtitle">点击屏幕两侧翻页</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="tapToTurnSwitch" checked>
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">数据</div>
                <div class="settings-card">
                    <div class="settings-item" id="exportDataBtn" style="cursor: pointer;">
                        <div class="settings-item-icon">
                            <span class="material-icons-round">download</span>
                        </div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">导出数据</div>
                            <div class="settings-item-subtitle">导出所有书籍和设置</div>
                        </div>
                    </div>
                    <div class="settings-item" id="importDataBtn" style="cursor: pointer;">
                        <div class="settings-item-icon">
                            <span class="material-icons-round">upload</span>
                        </div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">导入数据</div>
                            <div class="settings-item-subtitle">恢复之前导出的数据</div>
                        </div>
                    </div>
                    <div class="settings-item" id="clearDataBtn" style="cursor: pointer;">
                        <div class="settings-item-icon" style="background-color: #FFCDD2;">
                            <span class="material-icons-round" style="color: #B71C1C;">delete</span>
                        </div>
                        <div class="settings-item-content">
                            <div class="settings-item-title" style="color: var(--md-sys-color-error);">清除所有数据</div>
                            <div class="settings-item-subtitle">删除所有书籍和设置</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">关于</div>
                <div class="settings-card">
                    <div class="settings-item">
                        <div class="settings-item-icon">
                            <span class="material-icons-round">info</span>
                        </div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">小说查看器</div>
                            <div class="settings-item-subtitle">版本 1.0.0 | Material Design 3</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <nav class="bottom-nav">
            <button class="nav-item" data-page="home">
                <div class="nav-icon">
                    <span class="material-icons-round">home</span>
                </div>
                <span class="nav-label">书架</span>
            </button>
            <button class="nav-item" data-page="bookmarks">
                <div class="nav-icon">
                    <span class="material-icons-round">bookmark</span>
                </div>
                <span class="nav-label">书签</span>
            </button>
            <button class="nav-item active" data-page="settings">
                <div class="nav-icon">
                    <span class="material-icons-round">settings</span>
                </div>
                <span class="nav-label">设置</span>
            </button>
        </nav>
    </div>

    <!-- 阅读页面 -->
    <div class="page reader-page" id="readerPage">
        <header class="top-app-bar hidden" id="readerAppBar">
            <button class="icon-btn" id="backBtn" style="color: white;">
                <span class="material-icons-round">arrow_back</span>
            </button>
            <span class="top-app-bar-title" id="readerTitle" style="color: white;"></span>
            <button class="icon-btn" id="readerBookmarkBtn" style="color: white;">
                <span class="material-icons-round">bookmark_border</span>
            </button>
            <button class="icon-btn" id="chaptersBtn" style="color: white;">
                <span class="material-icons-round">format_list_bulleted</span>
            </button>
        </header>

        <div class="reader-container" id="readerContainer">
            <div class="reader-content" id="readerContent"></div>
        </div>

        <!-- 触摸区域 -->
        <div class="touch-area left" id="touchLeft"></div>
        <div class="touch-area center" id="touchCenter"></div>
        <div class="touch-area right" id="touchRight"></div>

        <!-- 底部工具栏 -->
        <div class="reader-toolbar" id="readerToolbar">
            <div class="toolbar-row">
                <button class="toolbar-btn" id="prevChapterBtn">
                    <span class="material-icons-round">skip_previous</span>
                </button>
                <div class="progress-bar-container">
                    <input type="range" class="progress-bar" id="progressBar" min="0" max="100" value="0">
                    <div class="progress-text" id="progressText">0%</div>
                </div>
                <button class="toolbar-btn" id="nextChapterBtn">
                    <span class="material-icons-round">skip_next</span>
                </button>
            </div>
            <div class="toolbar-row">
                <button class="toolbar-btn" id="toolbarFontDecrease">
                    <span class="material-icons-round">text_decrease</span>
                </button>
                <button class="toolbar-btn" id="toolbarFontIncrease">
                    <span class="material-icons-round">text_increase</span>
                </button>
                <button class="toolbar-btn" id="toolbarThemeLight">
                    <span class="material-icons-round">light_mode</span>
                </button>
                <button class="toolbar-btn" id="toolbarThemeDark">
                    <span class="material-icons-round">dark_mode</span>
                </button>
                <button class="toolbar-btn" id="toolbarSettings">
                    <span class="material-icons-round">tune</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 搜索模态框 -->
    <div class="modal-overlay" id="searchModal">
        <div class="modal">
            <div class="modal-header">
                <div class="search-bar">
                    <span class="material-icons-round">search</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="搜索书籍内容...">
                    <button class="icon-btn" id="closeSearchBtn">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
            </div>
            <div class="modal-content" id="searchResults"></div>
        </div>
    </div>

    <!-- 章节模态框 -->
    <div class="modal-overlay" id="chaptersModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">章节目录</h2>
            </div>
            <div class="modal-content">
                <ul class="chapter-list" id="chapterList"></ul>
            </div>
            <div class="modal-actions">
                <button class="btn btn-text" id="closeChaptersBtn">关闭</button>
            </div>
        </div>
    </div>

    <!-- 确认模态框 -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="confirmTitle">确认</h2>
            </div>
            <div class="modal-content">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-text" id="confirmCancelBtn">取消</button>
                <button class="btn btn-filled" id="confirmOkBtn">确认</button>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div class="context-menu" id="contextMenu">
        <div class="menu-item" id="menuContinueRead">
            <span class="material-icons-round">play_arrow</span>
            <span>继续阅读</span>
        </div>
        <div class="menu-item" id="menuBookInfo">
            <span class="material-icons-round">info</span>
            <span>书籍信息</span>
        </div>
        <div class="menu-item danger" id="menuDeleteBook">
            <span class="material-icons-round">delete</span>
            <span>删除书籍</span>
        </div>
    </div>

    <!-- Snackbar -->
    <div class="snackbar" id="snackbar"></div>

    <!-- 文件输入 -->
    <input type="file" class="file-input" id="fileInput" accept=".txt,.html,.htm,.md,.json" multiple>
    <input type="file" class="file-input" id="dataFileInput" accept=".json">

    <script>
        // 应用状态
        const state = {
            books: [],
            bookmarks: [],
            currentBook: null,
            currentPosition: 0,
            settings: {
                darkMode: false,
                readingTheme: 'light',
                fontSize: 18,
                lineHeight: 1.8,
                tapToTurn: true
            }
        };

        // DOM 元素
        const elements = {
            // 页面
            homePage: document.getElementById('homePage'),
            bookmarksPage: document.getElementById('bookmarksPage'),
            settingsPage: document.getElementById('settingsPage'),
            readerPage: document.getElementById('readerPage'),
            
            // 书架
            emptyState: document.getElementById('emptyState'),
            booksGrid: document.getElementById('booksGrid'),
            bookmarksList: document.getElementById('bookmarksList'),
            
            // 阅读器
            readerAppBar: document.getElementById('readerAppBar'),
            readerTitle: document.getElementById('readerTitle'),
            readerContainer: document.getElementById('readerContainer'),
            readerContent: document.getElementById('readerContent'),
            readerToolbar: document.getElementById('readerToolbar'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            readingProgress: document.getElementById('readingProgress'),
            
            // 模态框
            searchModal: document.getElementById('searchModal'),
            searchInput: document.getElementById('searchInput'),
            searchResults: document.getElementById('searchResults'),
            chaptersModal: document.getElementById('chaptersModal'),
            chapterList: document.getElementById('chapterList'),
            confirmModal: document.getElementById('confirmModal'),
            confirmTitle: document.getElementById('confirmTitle'),
            confirmMessage: document.getElementById('confirmMessage'),
            
            // 菜单
            contextMenu: document.getElementById('contextMenu'),
            
            // 其他
            snackbar: document.getElementById('snackbar'),
            fileInput: document.getElementById('fileInput'),
            dataFileInput: document.getElementById('dataFileInput')
        };

        // 初始化
        function init() {
            loadData();
            bindEvents();
            renderBooks();
            renderBookmarks();
            applySettings();
        }

        // 加载数据
        function loadData() {
            try {
                const savedBooks = localStorage.getItem('novelReader_books');
                const savedBookmarks = localStorage.getItem('novelReader_bookmarks');
                const savedSettings = localStorage.getItem('novelReader_settings');
                
                if (savedBooks) state.books = JSON.parse(savedBooks);
                if (savedBookmarks) state.bookmarks = JSON.parse(savedBookmarks);
                if (savedSettings) state.settings = { ...state.settings, ...JSON.parse(savedSettings) };
            } catch (e) {
                console.error('加载数据失败:', e);
            }
        }

        // 保存数据
        function saveData() {
            try {
                localStorage.setItem('novelReader_books', JSON.stringify(state.books));
                localStorage.setItem('novelReader_bookmarks', JSON.stringify(state.bookmarks));
                localStorage.setItem('novelReader_settings', JSON.stringify(state.settings));
            } catch (e) {
                console.error('保存数据失败:', e);
                showSnackbar('存储空间不足，部分数据可能无法保存');
            }
        }

        // 绑定事件
        function bindEvents() {
            // 导航
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchPage(item.dataset.page));
            });

            // 导入按钮
            document.getElementById('importFab').addEventListener('click', () => {
                elements.fileInput.click();
            });

            // 文件选择
            elements.fileInput.addEventListener('change', handleFileSelect);
            elements.dataFileInput.addEventListener('change', handleDataImport);

            // 搜索
            document.getElementById('searchBtn').addEventListener('click', () => openModal('search'));
            document.getElementById('closeSearchBtn').addEventListener('click', () => closeModal('search'));
            elements.searchInput.addEventListener('input', debounce(handleSearch, 300));

            // 阅读器
            document.getElementById('backBtn').addEventListener('click', exitReader);
            document.getElementById('readerBookmarkBtn').addEventListener('click', toggleBookmark);
            document.getElementById('chaptersBtn').addEventListener('click', () => openModal('chapters'));
            document.getElementById('closeChaptersBtn').addEventListener('click', () => closeModal('chapters'));

            // 触摸区域
            document.getElementById('touchLeft').addEventListener('click', () => handleTouchNavigation('prev'));
            document.getElementById('touchRight').addEventListener('click', () => handleTouchNavigation('next'));
            document.getElementById('touchCenter').addEventListener('click', toggleReaderUI);

            // 进度条
            elements.progressBar.addEventListener('input', handleProgressChange);

            // 工具栏按钮
            document.getElementById('prevChapterBtn').addEventListener('click', prevChapter);
            document.getElementById('nextChapterBtn').addEventListener('click', nextChapter);
            document.getElementById('toolbarFontDecrease').addEventListener('click', () => changeFontSize(-2));
            document.getElementById('toolbarFontIncrease').addEventListener('click', () => changeFontSize(2));
            document.getElementById('toolbarThemeLight').addEventListener('click', () => setReadingTheme('light'));
            document.getElementById('toolbarThemeDark').addEventListener('click', () => setReadingTheme('dark'));
            document.getElementById('toolbarSettings').addEventListener('click', () => {
                exitReader();
                setTimeout(() => switchPage('settings'), 100);
            });

            // 设置
            document.getElementById('darkModeSwitch').addEventListener('change', (e) => {
                state.settings.darkMode = e.target.checked;
                applySettings();
                saveData();
            });

            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    setReadingTheme(option.dataset.theme);
                });
            });

            document.getElementById('fontDecrease').addEventListener('click', () => changeFontSize(-2));
            document.getElementById('fontIncrease').addEventListener('click', () => changeFontSize(2));
            document.getElementById('lineHeightDecrease').addEventListener('click', () => changeLineHeight(-0.2));
            document.getElementById('lineHeightIncrease').addEventListener('click', () => changeLineHeight(0.2));

            document.getElementById('tapToTurnSwitch').addEventListener('change', (e) => {
                state.settings.tapToTurn = e.target.checked;
                saveData();
            });

            // 数据管理
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', () => elements.dataFileInput.click());
            document.getElementById('clearDataBtn').addEventListener('click', confirmClearData);

            // 确认模态框
            document.getElementById('confirmCancelBtn').addEventListener('click', () => closeModal('confirm'));

            // 右键菜单
            document.getElementById('menuContinueRead').addEventListener('click', () => {
                if (state.selectedBook) openBook(state.selectedBook.id);
                hideContextMenu();
            });
            document.getElementById('menuBookInfo').addEventListener('click', () => {
                if (state.selectedBook) showBookInfo(state.selectedBook);
                hideContextMenu();
            });
            document.getElementById('menuDeleteBook').addEventListener('click', () => {
                if (state.selectedBook) confirmDeleteBook(state.selectedBook);
                hideContextMenu();
            });

            // 点击其他地方关闭菜单
            document.addEventListener('click', (e) => {
                if (!elements.contextMenu.contains(e.target)) {
                    hideContextMenu();
                }
            });

            // 模态框点击背景关闭
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('visible');
                    }
                });
            });

            // 阅读器滚动监听
            elements.readerContainer.addEventListener('scroll', handleReaderScroll);

            // 键盘事件
            document.addEventListener('keydown', handleKeydown);

            // 长按添加书签
            let longPressTimer;
            elements.readerContent.addEventListener('touchstart', (e) => {
                longPressTimer = setTimeout(() => {
                    toggleBookmark();
                }, 800);
            });
            elements.readerContent.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
            });
            elements.readerContent.addEventListener('touchmove', () => {
                clearTimeout(longPressTimer);
            });
        }

        // 切换页面
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            switch (page) {
                case 'home':
                    elements.homePage.classList.add('active');
                    break;
                case 'bookmarks':
                    elements.bookmarksPage.classList.add('active');
                    renderBookmarks();
                    break;
                case 'settings':
                    elements.settingsPage.classList.add('active');
                    break;
            }

            document.querySelectorAll(`.nav-item[data-page="${page}"]`).forEach(n => {
                n.classList.add('active');
            });
        }

        // 处理文件选择
        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            for (const file of files) {
                try {
                    await importBook(file);
                } catch (error) {
                    showSnackbar(`导入 ${file.name} 失败: ${error.message}`);
                }
            }

            e.target.value = '';
            renderBooks();
        }

        // 导入书籍
        async function importBook(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const fileName = file.name.replace(/\.[^.]+$/, '');
                        
                        // 检测章节
                        const chapters = detectChapters(content);
                        
                        const book = {
                            id: Date.now() + Math.random().toString(36).substr(2, 9),
                            title: fileName,
                            content: content,
                            chapters: chapters,
                            addedAt: new Date().toISOString(),
                            lastReadAt: null,
                            position: 0,
                            progress: 0,
                            size: file.size
                        };
                        
                        state.books.push(book);
                        saveData();
                        showSnackbar(`《${fileName}》导入成功`);
                        resolve(book);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('文件读取失败'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        // 检测章节
        function detectChapters(content) {
            const chapters = [];
            const lines = content.split('\n');
            const chapterPatterns = [
                /^第[一二三四五六七八九十百千万\d]+[章节回]/,
                /^Chapter\s+\d+/i,
                /^[0-9]+[\.\、]\s*.+/,
                /^【.+】$/,
                /^━+.+━+$/
            ];
            
            let currentPosition = 0;
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (trimmedLine) {
                    for (const pattern of chapterPatterns) {
                        if (pattern.test(trimmedLine)) {
                            chapters.push({
                                title: trimmedLine.substring(0, 50),
                                position: currentPosition,
                                line: index
                            });
                            break;
                        }
                    }
                }
                currentPosition += line.length + 1;
            });
            
            // 如果没有检测到章节，创建一个默认章节
            if (chapters.length === 0) {
                chapters.push({
                    title: '全文',
                    position: 0,
                    line: 0
                });
            }
            
            return chapters;
        }

        // 渲染书架
        function renderBooks() {
            if (state.books.length === 0) {
                elements.emptyState.style.display = 'flex';
                elements.booksGrid.style.display = 'none';
            } else {
                elements.emptyState.style.display = 'none';
                elements.booksGrid.style.display = 'grid';
                
                elements.booksGrid.innerHTML = state.books.map(book => `
                    <div class="book-card" data-id="${book.id}">
                        <div class="book-cover">
                            <span class="book-cover-text">${book.title.substring(0, 20)}</span>
                        </div>
                        <div class="book-info">
                            <div class="book-title">${book.title}</div>
                            <div class="book-progress">${Math.round(book.progress || 0)}% · ${formatSize(book.size)}</div>
                        </div>
                        <button class="book-menu-btn">
                            <span class="material-icons-round">more_vert</span>
                        </button>
                    </div>
                `).join('');

                // 绑定点击事件
                elements.booksGrid.querySelectorAll('.book-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('.book-menu-btn')) {
                            openBook(card.dataset.id);
                        }
                    });
                    
                    card.querySelector('.book-menu-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        showContextMenu(e, state.books.find(b => b.id === card.dataset.id));
                    });
                    
                    // 长按也显示菜单
                    let pressTimer;
                    card.addEventListener('touchstart', (e) => {
                        pressTimer = setTimeout(() => {
                            e.preventDefault();
                            showContextMenu(e, state.books.find(b => b.id === card.dataset.id));
                        }, 500);
                    });
                    card.addEventListener('touchend', () => clearTimeout(pressTimer));
                    card.addEventListener('touchmove', () => clearTimeout(pressTimer));
                });
            }
        }

        // 渲染书签列表
        function renderBookmarks() {
            if (state.bookmarks.length === 0) {
                elements.bookmarksList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons-round">bookmark_border</span>
                        <h3>暂无书签</h3>
                        <p>阅读时点击书签按钮或长按内容可以添加书签</p>
                    </div>
                `;
            } else {
                elements.bookmarksList.innerHTML = state.bookmarks.map(bookmark => `
                    <div class="bookmark-item" data-id="${bookmark.id}">
                        <div class="bookmark-content">
                            <div class="bookmark-text">${bookmark.text}</div>
                            <div class="bookmark-position">${bookmark.bookTitle} · ${Math.round(bookmark.progress)}%</div>
                        </div>
                        <button class="bookmark-delete">
                            <span class="material-icons-round">delete</span>
                        </button>
                    </div>
                `).join('');

                elements.bookmarksList.querySelectorAll('.bookmark-item').forEach(item => {
                    item.querySelector('.bookmark-content').addEventListener('click', () => {
                        const bookmark = state.bookmarks.find(b => b.id === item.dataset.id);
                        if (bookmark) {
                            openBook(bookmark.bookId, bookmark.position);
                        }
                    });
                    
                    item.querySelector('.bookmark-delete').addEventListener('click', () => {
                        const id = item.dataset.id;
                        state.bookmarks = state.bookmarks.filter(b => b.id !== id);
                        saveData();
                        renderBookmarks();
                        showSnackbar('书签已删除');
                    });
                });
            }
        }

        // 打开书籍
        function openBook(bookId, position = null) {
            const book = state.books.find(b => b.id === bookId);
            if (!book) {
                showSnackbar('书籍不存在');
                return;
            }

            state.currentBook = book;
            state.currentPosition = position !== null ? position : book.position || 0;

            // 更新最后阅读时间
            book.lastReadAt = new Date().toISOString();
            saveData();

            // 显示阅读器
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            elements.readerPage.classList.add('active');

            // 设置标题
            elements.readerTitle.textContent = book.title;

            // 渲染内容
            renderContent();

            // 滚动到位置
            setTimeout(() => {
                const scrollPosition = (state.currentPosition / book.content.length) * 
                    (elements.readerContainer.scrollHeight - elements.readerContainer.clientHeight);
                elements.readerContainer.scrollTop = scrollPosition;
                updateProgress();
            }, 100);

            // 渲染章节列表
            renderChapters();

            // 隐藏UI
            elements.readerAppBar.classList.add('hidden');
            elements.readerToolbar.classList.remove('visible');
        }

        // 渲染内容
        function renderContent() {
            if (!state.currentBook) return;

            const content = state.currentBook.content;
            // 处理段落
            const paragraphs = content.split(/\n\s*\n|\n/).filter(p => p.trim());
            const html = paragraphs.map(p => `<p>${escapeHtml(p.trim())}</p>`).join('');
            
            elements.readerContent.innerHTML = html;
        }

        // 渲染章节列表
        function renderChapters() {
            if (!state.currentBook || !state.currentBook.chapters) return;

            elements.chapterList.innerHTML = state.currentBook.chapters.map((chapter, index) => `
                <li class="chapter-item" data-position="${chapter.position}">
                    ${chapter.title}
                </li>
            `).join('');

            elements.chapterList.querySelectorAll('.chapter-item').forEach(item => {
                item.addEventListener('click', () => {
                    const position = parseInt(item.dataset.position);
                    jumpToPosition(position);
                    closeModal('chapters');
                });
            });
        }

        // 跳转到位置
        function jumpToPosition(position) {
            if (!state.currentBook) return;

            const ratio = position / state.currentBook.content.length;
            const scrollPosition = ratio * (elements.readerContainer.scrollHeight - elements.readerContainer.clientHeight);
            elements.readerContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
        }

        // 退出阅读器
        function exitReader() {
            if (state.currentBook) {
                // 保存阅读位置
                state.currentBook.position = state.currentPosition;
                saveData();
            }

            state.currentBook = null;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            elements.homePage.classList.add('active');
            elements.readingProgress.style.width = '0';
        }

        // 切换阅读器UI
        function toggleReaderUI() {
            elements.readerAppBar.classList.toggle('hidden');
            elements.readerToolbar.classList.toggle('visible');
        }

        // 处理触摸导航
        function handleTouchNavigation(direction) {
            if (!state.settings.tapToTurn) return;

            const container = elements.readerContainer;
            const scrollAmount = container.clientHeight * 0.9;

            if (direction === 'prev') {
                container.scrollBy({ top: -scrollAmount, behavior: 'smooth' });
            } else {
                container.scrollBy({ top: scrollAmount, behavior: 'smooth' });
            }
        }

        // 处理进度条变化
        function handleProgressChange(e) {
            if (!state.currentBook) return;

            const progress = e.target.value;
            const scrollHeight = elements.readerContainer.scrollHeight - elements.readerContainer.clientHeight;
            elements.readerContainer.scrollTop = (progress / 100) * scrollHeight;
        }

        // 处理阅读器滚动
        function handleReaderScroll() {
            if (!state.currentBook) return;

            const container = elements.readerContainer;
            const scrollHeight = container.scrollHeight - container.clientHeight;
            const progress = scrollHeight > 0 ? (container.scrollTop / scrollHeight) * 100 : 0;

            state.currentPosition = Math.round((progress / 100) * state.currentBook.content.length);
            state.currentBook.progress = progress;
            state.currentBook.position = state.currentPosition;

            updateProgress();
        }

        // 更新进度显示
        function updateProgress() {
            if (!state.currentBook) return;

            const progress = state.currentBook.progress || 0;
            elements.progressBar.value = progress;
            elements.progressText.textContent = `${Math.round(progress)}%`;
            elements.readingProgress.style.width = `${progress}%`;

            // 更新书签按钮状态
            const hasBookmark = state.bookmarks.some(b => 
                b.bookId === state.currentBook.id && 
                Math.abs(b.position - state.currentPosition) < 500
            );
            
            const bookmarkBtn = document.getElementById('readerBookmarkBtn');
            bookmarkBtn.querySelector('.material-icons-round').textContent = 
                hasBookmark ? 'bookmark' : 'bookmark_border';
        }

        // 切换书签
        function toggleBookmark() {
            if (!state.currentBook) return;

            const existingIndex = state.bookmarks.findIndex(b => 
                b.bookId === state.currentBook.id && 
                Math.abs(b.position - state.currentPosition) < 500
            );

            if (existingIndex !== -1) {
                state.bookmarks.splice(existingIndex, 1);
                showSnackbar('书签已移除');
            } else {
                // 获取当前位置的文本片段
                const textStart = Math.max(0, state.currentPosition - 50);
                const textEnd = Math.min(state.currentBook.content.length, state.currentPosition + 100);
                const text = state.currentBook.content.substring(textStart, textEnd).trim();

                state.bookmarks.push({
                    id: Date.now().toString(),
                    bookId: state.currentBook.id,
                    bookTitle: state.currentBook.title,
                    position: state.currentPosition,
                    progress: state.currentBook.progress || 0,
                    text: text,
                    createdAt: new Date().toISOString()
                });
                showSnackbar('书签已添加');
            }

            saveData();
            updateProgress();
        }

        // 上一章
        function prevChapter() {
            if (!state.currentBook || !state.currentBook.chapters) return;

            const currentPos = state.currentPosition;
            const chapters = state.currentBook.chapters;
            
            for (let i = chapters.length - 1; i >= 0; i--) {
                if (chapters[i].position < currentPos - 100) {
                    jumpToPosition(chapters[i].position);
                    showSnackbar(chapters[i].title);
                    return;
                }
            }
            
            showSnackbar('已经是第一章了');
        }

        // 下一章
        function nextChapter() {
            if (!state.currentBook || !state.currentBook.chapters) return;

            const currentPos = state.currentPosition;
            const chapters = state.currentBook.chapters;
            
            for (let i = 0; i < chapters.length; i++) {
                if (chapters[i].position > currentPos + 100) {
                    jumpToPosition(chapters[i].position);
                    showSnackbar(chapters[i].title);
                    return;
                }
            }
            
            showSnackbar('已经是最后一章了');
        }

        // 搜索
        function handleSearch() {
            const query = elements.searchInput.value.trim().toLowerCase();
            
            if (!query) {
                elements.searchResults.innerHTML = '';
                return;
            }

            const results = [];
            
            state.books.forEach(book => {
                const content = book.content.toLowerCase();
                let index = 0;
                let count = 0;
                
                while ((index = content.indexOf(query, index)) !== -1 && count < 5) {
                    const start = Math.max(0, index - 30);
                    const end = Math.min(content.length, index + query.length + 30);
                    let excerpt = book.content.substring(start, end);
                    
                    // 高亮关键词
                    const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
                    excerpt = escapeHtml(excerpt).replace(regex, '<span class="search-highlight">$1</span>');
                    
                    results.push({
                        bookId: book.id,
                        bookTitle: book.title,
                        position: index,
                        excerpt: excerpt
                    });
                    
                    index += query.length;
                    count++;
                }
            });

            if (results.length === 0) {
                elements.searchResults.innerHTML = `
                    <div class="empty-state" style="padding: 24px;">
                        <p>未找到相关内容</p>
                    </div>
                `;
            } else {
                elements.searchResults.innerHTML = results.map(result => `
                    <div class="search-result-item" data-book-id="${result.bookId}" data-position="${result.position}">
                        <div style="font-size: 12px; color: var(--md-sys-color-primary); margin-bottom: 4px;">
                            ${result.bookTitle}
                        </div>
                        <div style="font-size: 14px;">...${result.excerpt}...</div>
                    </div>
                `).join('');

                elements.searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        closeModal('search');
                        openBook(item.dataset.bookId, parseInt(item.dataset.position));
                    });
                });
            }
        }

        // 设置相关
        function applySettings() {
            // 深色模式
            if (state.settings.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            document.getElementById('darkModeSwitch').checked = state.settings.darkMode;
            document.getElementById('tapToTurnSwitch').checked = state.settings.tapToTurn;
            
            // 字体大小
            document.documentElement.style.setProperty('--font-size', `${state.settings.fontSize}px`);
            document.getElementById('fontSizeValue').textContent = `${state.settings.fontSize}px`;
            
            // 行间距
            document.documentElement.style.setProperty('--line-height', state.settings.lineHeight);
            document.getElementById('lineHeightValue').textContent = state.settings.lineHeight.toFixed(1);
            
            // 阅读主题
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.toggle('active', option.dataset.theme === state.settings.readingTheme);
            });
        }

        function changeFontSize(delta) {
            state.settings.fontSize = Math.max(12, Math.min(32, state.settings.fontSize + delta));
            applySettings();
            saveData();
        }

        function changeLineHeight(delta) {
            state.settings.lineHeight = Math.max(1.2, Math.min(3, state.settings.lineHeight + delta));
            applySettings();
            saveData();
        }

        function setReadingTheme(theme) {
            state.settings.readingTheme = theme;
            
            if (theme === 'dark') {
                state.settings.darkMode = true;
            } else {
                state.settings.darkMode = false;
            }
            
            document.documentElement.setAttribute('data-theme', theme);
            
            applySettings();
            saveData();
        }

        // 数据管理
        function exportData() {
            const data = {
                books: state.books,
                bookmarks: state.bookmarks,
                settings: state.settings,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `novel-reader-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSnackbar('数据导出成功');
        }

        function handleDataImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.books) state.books = data.books;
                    if (data.bookmarks) state.bookmarks = data.bookmarks;
                    if (data.settings) state.settings = { ...state.settings, ...data.settings };
                    
                    saveData();
                    renderBooks();
                    renderBookmarks();
                    applySettings();
                    
                    showSnackbar('数据导入成功');
                } catch (error) {
                    showSnackbar('数据导入失败：格式无效');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function confirmClearData() {
            elements.confirmTitle.textContent = '清除所有数据';
            elements.confirmMessage.textContent = '确定要删除所有书籍、书签和设置吗？此操作不可撤销。';
            
            document.getElementById('confirmOkBtn').onclick = () => {
                state.books = [];
                state.bookmarks = [];
                state.settings = {
                    darkMode: false,
                    readingTheme: 'light',
                    fontSize: 18,
                    lineHeight: 1.8,
                    tapToTurn: true
                };
                
                localStorage.clear();
                saveData();
                renderBooks();
                renderBookmarks();
                applySettings();
                
                closeModal('confirm');
                showSnackbar('所有数据已清除');
            };
            
            openModal('confirm');
        }

        // 右键菜单
        function showContextMenu(e, book) {
            state.selectedBook = book;
            
            const menu = elements.contextMenu;
            const rect = e.target.getBoundingClientRect();
            
            let x = e.clientX || rect.left;
            let y = e.clientY || rect.bottom;
            
            // 确保菜单在视口内
            menu.style.left = '0';
            menu.style.top = '0';
            menu.classList.add('visible');
            
            const menuRect = menu.getBoundingClientRect();
            
            if (x + menuRect.width > window.innerWidth) {
                x = window.innerWidth - menuRect.width - 8;
            }
            if (y + menuRect.height > window.innerHeight) {
                y = window.innerHeight - menuRect.height - 8;
            }
            
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
        }

        function hideContextMenu() {
            elements.contextMenu.classList.remove('visible');
            state.selectedBook = null;
        }

        function showBookInfo(book) {
            const size = formatSize(book.size);
            const addedAt = new Date(book.addedAt).toLocaleDateString();
            const lastRead = book.lastReadAt ? new Date(book.lastReadAt).toLocaleDateString() : '未阅读';
            const chapters = book.chapters ? book.chapters.length : 0;
            
            elements.confirmTitle.textContent = book.title;
            elements.confirmMessage.innerHTML = `
                <p><strong>文件大小：</strong>${size}</p>
                <p><strong>导入日期：</strong>${addedAt}</p>
                <p><strong>最后阅读：</strong>${lastRead}</p>
                <p><strong>章节数：</strong>${chapters}</p>
                <p><strong>阅读进度：</strong>${Math.round(book.progress || 0)}%</p>
            `;
            
            document.getElementById('confirmOkBtn').style.display = 'none';
            document.getElementById('confirmCancelBtn').textContent = '关闭';
            
            openModal('confirm');
            
            // 恢复按钮
            setTimeout(() => {
                document.getElementById('confirmOkBtn').style.display = '';
                document.getElementById('confirmCancelBtn').textContent = '取消';
            }, 0);
        }

        function confirmDeleteBook(book) {
            elements.confirmTitle.textContent = '删除书籍';
            elements.confirmMessage.textContent = `确定要删除《${book.title}》吗？`;
            
            document.getElementById('confirmOkBtn').onclick = () => {
                state.books = state.books.filter(b => b.id !== book.id);
                state.bookmarks = state.bookmarks.filter(b => b.bookId !== book.id);
                saveData();
                renderBooks();
                closeModal('confirm');
                showSnackbar('书籍已删除');
            };
            
            openModal('confirm');
        }

        // 模态框控制
        function openModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            if (modal) {
                modal.classList.add('visible');
                if (type === 'search') {
                    elements.searchInput.focus();
                }
            }
        }

        function closeModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            if (modal) {
                modal.classList.remove('visible');
            }
        }

        // Snackbar
        function showSnackbar(message, duration = 3000) {
            elements.snackbar.textContent = message;
            elements.snackbar.classList.add('visible');
            
            setTimeout(() => {
                elements.snackbar.classList.remove('visible');
            }, duration);
        }

        // 键盘快捷键
        function handleKeydown(e) {
            if (elements.readerPage.classList.contains('active')) {
                switch (e.key) {
                    case 'ArrowLeft':
                    case 'PageUp':
                        handleTouchNavigation('prev');
                        break;
                    case 'ArrowRight':
                    case 'PageDown':
                    case ' ':
                        e.preventDefault();
                        handleTouchNavigation('next');
                        break;
                    case 'Escape':
                        exitReader();
                        break;
                    case 'b':
                    case 'B':
                        toggleBookmark();
                        break;
                }
            }
        }

        // 工具函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // 启动应用
        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MD3 Code Editor</title>
    <!-- 引入 Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <!-- 引入 Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

    <style>
        /* =========================================
           MD3 Design Tokens & Variables
           ========================================= */
        :root {
            /* 基础色相 (Violet) */
            --md-primary: #6750a4;
            --md-on-primary: #ffffff;
            --md-primary-container: #eaddff;
            --md-on-primary-container: #21005d;
            
            --md-surface: #fdf8fd;
            --md-surface-container: #f3edf7;
            --md-surface-container-high: #ece6f0;
            
            --md-on-surface: #1c1b1f;
            --md-outline: #79747e;

            /* 编辑器特定 */
            --editor-bg: #fff;
            --editor-fg: #1c1b1f;
            
            /* 尺寸 */
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 8px;
            
            --header-height: 64px;
        }

        /* 暗黑模式 */
        [data-theme="dark"] {
            --md-primary: #d0bcff;
            --md-on-primary: #381e72;
            --md-primary-container: #4f378b;
            --md-on-primary-container: #eaddff;
            
            --md-surface: #141218;
            --md-surface-container: #1d1b20;
            --md-surface-container-high: #2b2930;
            
            --md-on-surface: #e6e1e5;
            --md-outline: #938f99;

            --editor-bg: #141218;
            --editor-fg: #e6e1e5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-surface);
            color: var(--md-on-surface);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* =========================================
           UI Components
           ========================================= */
        
        /* 顶部应用栏 (Top App Bar) */
        header {
            height: var(--header-height);
            background-color: var(--md-surface);
            display: flex;
            align-items: center;
            padding: 0 16px;
            justify-content: space-between;
            z-index: 10;
        }

        .logo {
            font-size: 22px;
            font-weight: 500;
            color: var(--md-on-surface);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        /* 图标按钮 */
        .icon-btn {
            background: transparent;
            border: none;
            color: var(--md-on-surface);
            width: 40px; /* 48px touch target */
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .icon-btn:hover { background-color: rgba(var(--md-on-surface), 0.08); }
        .material-symbols-rounded { font-size: 24px; }

        /* 填充按钮 (MD3 Filled Button) */
        .btn-filled {
            background-color: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            height: 40px;
            padding: 0 24px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            transition: box-shadow 0.2s, filter 0.2s;
        }
        .btn-filled:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            filter: brightness(1.05);
        }

        /* =========================================
           Main Layout (Editor + Preview)
           ========================================= */
        main {
            flex: 1;
            display: flex;
            gap: 16px;
            padding: 0 16px 16px 16px;
            overflow: hidden;
        }

        .panel {
            background-color: var(--md-surface-container);
            border-radius: var(--radius-m);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: flex 0.3s ease;
        }

        .panel-header {
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--md-primary);
            background-color: var(--md-surface-container-high);
        }

        /* 编辑器容器 */
        #editor-container {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            overflow: auto;
        }

        /* CodeMirror 6 自定义样式修正 */
        .cm-editor { height: 100%; }
        .cm-scroller { overflow: auto; font-family: inherit; }
        .cm-gutters { 
            background-color: var(--md-surface-container-high) !important; 
            color: var(--md-outline) !important;
            border-right: none !important;
        }
        .cm-content { padding-bottom: 50px; } /* 底部留白 */

        /* 预览容器 */
        #preview-container {
            flex: 1;
            background-color: white; /* 预览必须是白底除非iframe内部控制 */
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* =========================================
           Floating Action Button (Mobile Only)
           ========================================= */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 16px; /* MD3 FAB shape */
            background-color: var(--md-primary-container);
            color: var(--md-on-primary-container);
            border: none;
            display: none; /* 默认隐藏，手机显示 */
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 100;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.95); }

        /* =========================================
           Responsive Design
           ========================================= */
        @media (max-width: 768px) {
            main {
                flex-direction: column;
                padding: 0;
                gap: 0;
            }
            
            .panel {
                border-radius: 0;
                flex: 1;
            }

            /* 移动端切换逻辑 */
            .panel { display: none; }
            .panel.active { display: flex; }

            header {
                padding: 0 12px;
            }
            
            .desktop-run { display: none; }
            .fab { display: flex; }

            /* 底部导航栏模拟 (Tabs) */
            .mobile-tabs {
                height: 80px; /* Tall for MD3 */
                background-color: var(--md-surface);
                display: flex;
                justify-content: space-around;
                align-items: center;
                padding-bottom: 16px;
                border-top: 1px solid var(--md-surface-container-high);
            }
            
            .tab-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                color: var(--md-on-surface);
                opacity: 0.7;
                font-size: 12px;
                font-weight: 500;
                padding: 8px 20px;
                border-radius: 16px;
                transition: all 0.3s;
            }
            
            .tab-item.active {
                opacity: 1;
                color: var(--md-on-surface);
            }
            .tab-item.active .icon-box {
                background-color: var(--md-primary-container);
                color: var(--md-on-primary-container);
            }

            .icon-box {
                width: 64px;
                height: 32px;
                border-radius: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background-color 0.3s;
            }
            
            /* 调整编辑器字体 */
            #editor-container { font-size: 16px; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="logo">
            <span class="material-symbols-rounded" style="color: var(--md-primary)">code_blocks</span>
            CodeSpace
        </div>
        <div class="actions">
            <button class="icon-btn" id="theme-toggle" title="切换主题">
                <span class="material-symbols-rounded">dark_mode</span>
            </button>
            <button class="btn-filled desktop-run" id="run-btn-desktop">
                <span class="material-symbols-rounded">play_arrow</span>
                运行
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Code Editor Panel -->
        <div class="panel active" id="panel-code">
            <div class="panel-header">INDEX.HTML</div>
            <div id="editor-container"></div>
        </div>

        <!-- Preview Panel -->
        <div class="panel" id="panel-preview">
            <div class="panel-header">PREVIEW</div>
            <div id="preview-container">
                <iframe id="preview-frame"></iframe>
            </div>
        </div>
    </main>

    <!-- Mobile Run FAB -->
    <button class="fab" id="run-btn-mobile">
        <span class="material-symbols-rounded">play_arrow</span>
    </button>

    <!-- Mobile Bottom Navigation -->
    <div class="mobile-tabs" id="mobile-nav" style="display: none;">
        <div class="tab-item active" onclick="switchTab('code')">
            <div class="icon-box"><span class="material-symbols-rounded">edit</span></div>
            代码
        </div>
        <div class="tab-item" onclick="switchTab('preview')">
            <div class="icon-box"><span class="material-symbols-rounded">preview</span></div>
            预览
        </div>
    </div>

    <!-- Logic via Modules -->
    <script type="module">
        // 使用 ESM 引入 CodeMirror 6 (从 CDN)
        import {EditorView, basicSetup} from "https://esm.sh/codemirror@6.0.1";
        import {html} from "https://esm.sh/@codemirror/lang-html@6.4.0";
        import {oneDark} from "https://esm.sh/@codemirror/theme-one-dark@6.1.2";
        import {keymap} from "https://esm.sh/@codemirror/view@6.0.0";
        import {indentWithTab} from "https://esm.sh/@codemirror/commands@6.0.0";

        // 初始代码
        const initialCode = `<!-- 欢迎使用 MD3 在线编辑器 -->
<!-- 手机电脑通用，支持实时预览 -->

<!DOCTYPE html>
<style>
  body {
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin: 0;
  }
  h1 {
    font-size: 3rem;
    text-shadow: 0 4px 10px rgba(0,0,0,0.3);
    animation: float 3s ease-in-out infinite;
  }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
  }
</style>

<body>
  <h1>Hello World! ✨</h1>
</body>
`;

        let editor;
        const editorContainer = document.getElementById('editor-container');
        
        // 1. 初始化编辑器
        function initEditor(themeExtension = []) {
            // 清空容器防止重复初始化
            editorContainer.innerHTML = '';
            
            editor = new EditorView({
                doc: initialCode,
                extensions: [
                    basicSetup,
                    keymap.of([indentWithTab]),
                    html(), // HTML 语法支持
                    ...themeExtension, // 主题
                    EditorView.lineWrapping, // 自动换行
                    EditorView.updateListener.of((v) => {
                        if (v.docChanged) {
                            // 可选：在这里添加自动保存或防抖自动运行
                        }
                    })
                ],
                parent: editorContainer
            });
        }

        // 2. 运行代码逻辑
        function runCode() {
            const code = editor.state.doc.toString();
            const frame = document.getElementById('preview-frame');
            // 重置 iframe 内容
            frame.srcdoc = code;
            
            // 如果在手机端，自动跳转到预览 Tab
            if (window.innerWidth <= 768) {
                switchTab('preview');
            }
        }

        // 3. 主题切换逻辑
        let isDark = false;
        const themeToggle = document.getElementById('theme-toggle');
        
        function toggleTheme() {
            isDark = !isDark;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            
            // 切换图标
            const icon = themeToggle.querySelector('span');
            icon.textContent = isDark ? 'light_mode' : 'dark_mode';
            
            // 重新初始化编辑器以应用/移除代码高亮主题
            // 注意：生产环境中推荐使用 Compartment 动态配置，这里为了简单直接重建
            const currentCode = editor ? editor.state.doc.toString() : initialCode;
            
            // 编辑器主题配置 (CodeMirror 默认是白的，OneDark 是黑的)
            const themeExt = isDark ? [oneDark] : []; 
            
            editor.destroy(); // 销毁旧实例
            
            editor = new EditorView({
                doc: currentCode,
                extensions: [
                    basicSetup,
                    keymap.of([indentWithTab]),
                    html(),
                    ...themeExt,
                    EditorView.lineWrapping
                ],
                parent: editorContainer
            });
        }

        // 4. 移动端 Tab 切换逻辑
        window.switchTab = function(tabName) {
            const codePanel = document.getElementById('panel-code');
            const previewPanel = document.getElementById('panel-preview');
            const tabs = document.querySelectorAll('.tab-item');
            const fab = document.getElementById('run-btn-mobile');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tabName === 'code') {
                codePanel.style.display = 'flex';
                previewPanel.style.display = 'none';
                tabs[0].classList.add('active');
                fab.style.display = 'flex'; // 在代码页显示运行按钮
            } else {
                codePanel.style.display = 'none';
                previewPanel.style.display = 'flex';
                tabs[1].classList.add('active');
                fab.style.display = 'none'; // 在预览页隐藏运行按钮
            }
        };

        // 5. 检测设备并调整 UI
        function checkLayout() {
            const isMobile = window.innerWidth <= 768;
            const mobileNav = document.getElementById('mobile-nav');
            
            if (isMobile) {
                mobileNav.style.display = 'flex';
                // 初始化移动端状态
                switchTab('code'); 
            } else {
                mobileNav.style.display = 'none';
                // 桌面端显示所有面板
                document.getElementById('panel-code').style.display = 'flex';
                document.getElementById('panel-preview').style.display = 'flex';
            }
        }

        // 事件监听
        document.getElementById('run-btn-desktop').addEventListener('click', runCode);
        document.getElementById('run-btn-mobile').addEventListener('click', runCode);
        themeToggle.addEventListener('click', toggleTheme);
        window.addEventListener('resize', checkLayout);

        // 启动
        initEditor(); // 默认亮色
        checkLayout();

    </script>
</body>
</html>

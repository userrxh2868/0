<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高级沙盒模拟器 MD3 v2.5</title>
    <!-- 引入 Material Symbols 图标库 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* ==================== MD3 Design System ==================== */
        :root {
            /* Color Tokens */
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #31111D;

            /* Elevation */
            --md-sys-elevation-2: 0px 4px 8px 3px rgba(0,0,0,0.15);
            --md-sys-elevation-3: 0px 4px 12px 6px rgba(0,0,0,0.2);

            /* Motion */
            --md-sys-motion-easing-emphasized: cubic-bezier(0.2, 0.0, 0.0, 1.0);
            --md-sys-motion-easing-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --md-sys-motion-duration-medium: 400ms;
            
            /* Dialog */
            --md-dialog-bg: #EEE8F4;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --md-sys-color-primary: #D0BCFF;
                --md-sys-color-on-primary: #381E72;
                --md-sys-color-primary-container: #4F378B;
                --md-sys-color-on-primary-container: #EADDFF;
                --md-sys-color-secondary-container: #4A4458;
                --md-sys-color-on-secondary-container: #E8DEF8;
                --md-sys-color-surface: #1C1B1F;
                --md-sys-color-surface-container: #25232A;
                --md-sys-color-on-surface: #E6E1E5;
                --md-sys-color-on-surface-variant: #CAC4D0;
                --md-sys-color-outline: #938F99;
                --md-sys-color-surface-variant: #49454F;
                --md-sys-color-tertiary-container: #492532;
                --md-sys-color-on-tertiary-container: #FFD8E4;
                --md-dialog-bg: #2B2930;
            }
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; 
            background-color: var(--md-sys-color-surface); 
            color: var(--md-sys-color-on-surface);
            font-family: 'Roboto', sans-serif; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }

        /* Top Bar */
        header {
            height: 64px; 
            display: flex; 
            align-items: center; 
            padding: 0 16px;
            justify-content: space-between; 
            font-weight: 400; 
            font-size: 22px;
            z-index: 10;
        }
        
        .header-actions { display: flex; gap: 8px; }

        /* Icon Button */
        .icon-btn {
            width: 40px; height: 40px; 
            border-radius: 20px; 
            border: none; 
            background: transparent;
            color: var(--md-sys-color-on-surface-variant); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            position: relative; 
            overflow: hidden;
            transition: background 0.2s var(--md-sys-motion-easing-emphasized);
        }
        .icon-btn:active { background: rgba(var(--md-sys-color-on-surface), 0.12); transform: scale(0.95); }
        .icon-btn.active { background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); }
        
        .material-symbols-outlined {
            font-size: 24px;
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Canvas */
        #game-container {
            flex: 1; 
            position: relative; 
            background: #000; 
            margin: 0 16px 16px;
            border-radius: 16px; 
            overflow: hidden; 
            box-shadow: var(--md-sys-elevation-2);
            touch-action: none; 
            cursor: crosshair;
        }
        /* Canvas transform logic */
        canvas { 
            width: 100%; height: 100%; 
            image-rendering: pixelated; 
            display: block; 
            transform-origin: 0 0;
            /* Animation for smooth zoom reset, but not during drag */
            transition: transform 0.05s linear; 
        }

        /* Controls */
        .controls-area {
            background-color: var(--md-sys-color-surface-container); 
            padding: 16px 16px 24px;
            border-radius: 28px 28px 0 0; 
            display: flex; 
            flex-direction: column; 
            gap: 16px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); 
            z-index: 20;
            transition: transform 0.3s var(--md-sys-motion-easing-emphasized);
        }

        .tool-row {
            display: flex; gap: 12px; align-items: center;
        }

        /* Chips */
        .chip-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 4px; scrollbar-width: none; flex: 1; }
        .chip-scroll::-webkit-scrollbar { display: none; }
        
        .chip {
            height: 32px; 
            padding: 0 16px; 
            border-radius: 8px; 
            border: 1px solid var(--md-sys-color-outline);
            background: transparent; 
            color: var(--md-sys-color-on-surface-variant); 
            font-size: 14px; 
            font-weight: 500;
            display: flex; 
            align-items: center; 
            justify-content: center;
            white-space: nowrap; 
            cursor: pointer; 
            transition: all 0.2s var(--md-sys-motion-easing-emphasized);
            gap: 8px;
        }
        
        .chip:active { transform: scale(0.95); }
        .chip.active {
            background: var(--md-sys-color-secondary-container); 
            color: var(--md-sys-color-on-secondary-container); 
            border-color: transparent;
        }
        
        /* Special Tool Toggle (Hand) */
        .tool-toggle {
            height: 40px; width: 40px; border-radius: 12px;
            border: 1px solid var(--md-sys-color-outline);
            background: transparent;
            color: var(--md-sys-color-on-surface);
            display: none; /* Hidden by default */
            align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tool-toggle.visible { display: flex; }
        .tool-toggle.active {
            background: var(--md-sys-color-tertiary-container);
            color: var(--md-sys-color-on-tertiary-container);
            border-color: transparent;
        }

        /* Buttons */
        .btn-filled {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            height: 40px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
            width: 100%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.2s var(--md-sys-motion-easing-emphasized);
        }
        .btn-filled:active { transform: scale(0.97); opacity: 0.9; }

        .btn-text {
            background: transparent;
            color: var(--md-sys-color-primary);
            border: none;
            height: 40px;
            padding: 0 12px;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Bottom Sheet */
        #more-sheet {
            position: fixed; bottom: -100%; left: 0; right: 0; 
            background: var(--md-sys-color-surface-container);
            border-radius: 28px 28px 0 0; 
            padding: 24px; 
            transition: bottom var(--md-sys-motion-duration-medium) var(--md-sys-motion-easing-emphasized);
            z-index: 100; 
            max-height: 75vh; 
            overflow-y: auto;
            box-shadow: var(--md-sys-elevation-3);
        }
        #more-sheet.open { bottom: 0; }
        
        .grid-elements {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 12px;
        }
        .element-card {
            display: flex; flex-direction: column; align-items: center; padding: 12px 8px;
            background: var(--md-sys-color-surface); 
            border-radius: 12px; gap: 8px; cursor: pointer;
            font-size: 12px; text-align: center;
            color: var(--md-sys-color-on-surface);
            transition: transform 0.2s var(--md-sys-motion-easing-emphasized), background 0.2s;
        }
        .element-card:active { background: var(--md-sys-color-surface-variant); transform: scale(0.95); }
        .element-dot { width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(128,128,128,0.2); }

        .backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4);
            z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .backdrop.open { opacity: 1; pointer-events: auto; }

        .slider-container { display: flex; align-items: center; gap: 16px; font-size: 14px; color: var(--md-sys-color-on-surface-variant); }
        input[type=range] { flex: 1; accent-color: var(--md-sys-color-primary); height: 4px; }
        
        /* Dialogs */
        .dialog-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 200; display: none;
            align-items: center; justify-content: center; opacity: 0;
            transition: opacity 0.3s;
        }
        .dialog-overlay.show { display: flex; opacity: 1; }
        
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .dialog {
            background: var(--md-dialog-bg); width: 85%; max-width: 320px;
            border-radius: 28px; padding: 24px; 
            box-shadow: var(--md-sys-elevation-3);
            display: flex; flex-direction: column;
            transform-origin: center;
        }
        .dialog.large { max-width: 600px; height: 75vh; }
        .dialog-overlay.show .dialog { 
            animation: popIn 0.4s var(--md-sys-motion-easing-spring) forwards;
        }
        
        .dialog-title { font-size: 24px; margin: 0 0 16px 0; font-weight: 400; color: var(--md-sys-color-on-surface); }
        .dialog-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 0; border-bottom: 1px solid var(--md-sys-color-outline-variant);
            cursor: pointer; color: var(--md-sys-color-on-surface);
        }
        .dialog-item:last-child { border-bottom: none; }
        
        textarea.code-area {
            flex: 1; background: var(--md-sys-color-surface-variant); 
            border: none; border-radius: 8px;
            padding: 16px; font-family: monospace; font-size: 12px; resize: none;
            color: var(--md-sys-color-on-surface); margin-bottom: 16px; outline: none;
        }
        
        /* Switch */
        .switch { position: relative; display: inline-block; width: 52px; height: 32px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--md-sys-color-surface-variant); 
            border: 2px solid var(--md-sys-color-outline);
            transition: .4s var(--md-sys-motion-easing-emphasized); border-radius: 32px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 6px; bottom: 6px;
            background-color: var(--md-sys-color-outline); transition: .4s var(--md-sys-motion-easing-emphasized); border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--md-sys-color-primary); border-color: var(--md-sys-color-primary); }
        input:checked + .slider:before { transform: translateX(20px); background-color: var(--md-sys-color-on-primary); width: 24px; height: 24px; left: 2px; bottom: 2px; }

        .select-input {
            background: transparent;
            border: 1px solid var(--md-sys-color-outline);
            color: var(--md-sys-color-on-surface);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            font-family: inherit;
        }

    </style>
</head>
<body>

    <header>
        <span>物理沙盒 v2.5</span>
        <div class="header-actions">
            <button class="icon-btn" onclick="togglePause()" id="pause-btn" title="暂停/开始">
                <span class="material-symbols-outlined">pause</span>
            </button>
            <button class="icon-btn" onclick="openSettings()" title="设置">
                <span class="material-symbols-outlined">settings</span>
            </button>
            <button class="icon-btn" onclick="clearCanvas()" title="清空画布">
                <span class="material-symbols-outlined">delete</span>
            </button>
        </div>
    </header>

    <div id="game-container">
        <canvas id="sandbox"></canvas>
    </div>

    <div class="controls-area">
        <div class="slider-container">
            <span class="material-symbols-outlined" style="font-size:20px;">brush</span>
            <input type="range" min="1" max="10" value="3" id="brushSize">
            <span id="fps-counter" style="display:none; width:60px; text-align:right; font-variant-numeric: tabular-nums;">60 FPS</span>
        </div>

        <div class="tool-row">
            <!-- New Zoom/Pan Tool Toggle -->
            <button class="tool-toggle" id="view-mode-btn" onclick="toggleViewMode()" title="视图模式 (移动/缩放)">
                <span class="material-symbols-outlined">pan_tool</span>
            </button>
            
            <div class="chip-scroll" id="quick-bar"></div>
        </div>

        <button class="btn-filled" onclick="toggleSheet(true)">
            <span class="material-symbols-outlined">grid_view</span>
            更多元素
        </button>
    </div>

    <!-- Backdrop -->
    <div class="backdrop" id="backdrop" onclick="closeAllOverlays()"></div>

    <!-- More Elements Sheet -->
    <div id="more-sheet">
        <div style="width:32px; height:4px; background:var(--md-sys-color-outline); opacity:0.4; margin:-10px auto 20px; border-radius:2px;"></div>
        <h3 style="margin:0 0 16px; font-size:22px; font-weight:400;">元素库</h3>
        <div class="grid-elements" id="all-elements-grid"></div>
    </div>

    <!-- Settings Dialog -->
    <div class="dialog-overlay" id="settings-overlay" onclick="closeSettings(event)">
        <div class="dialog">
            <h2 class="dialog-title">设置</h2>
            
            <div class="dialog-item">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span class="material-symbols-outlined">speed</span>
                    <span>显示 FPS</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="fps-toggle" onchange="toggleFPS()">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Zoom Toggle Setting -->
            <div class="dialog-item">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span class="material-symbols-outlined">zoom_in</span>
                    <span>启用缩放功能</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="zoom-toggle" onchange="toggleZoomFeature()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="dialog-item">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span class="material-symbols-outlined">aspect_ratio</span>
                    <span>画质 / 分辨率</span>
                </div>
                <select class="select-input" id="res-select" onchange="changeResolution(this.value)">
                    <option value="8">低 (大颗粒)</option>
                    <option value="4" selected>中 (默认)</option>
                    <option value="2">高 (精细)</option>
                </select>
            </div>

            <div class="dialog-item" onclick="openSourceView()">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span class="material-symbols-outlined">html</span>
                    <span>查看源代码</span>
                </div>
                <span class="material-symbols-outlined" style="font-size:20px; opacity:0.5;">chevron_right</span>
            </div>
            <div class="dialog-item" onclick="openAbout()">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span class="material-symbols-outlined">info</span>
                    <span>关于</span>
                </div>
                <span class="material-symbols-outlined" style="font-size:20px; opacity:0.5;">chevron_right</span>
            </div>
            <div style="text-align:right; margin-top:24px;">
                <button class="btn-text" onclick="document.getElementById('settings-overlay').classList.remove('show'); toggleBackdrop(false);">关闭</button>
            </div>
        </div>
    </div>

    <!-- Source Code Dialog -->
    <div class="dialog-overlay" id="source-overlay" onclick="closeSource(event)">
        <div class="dialog large">
            <h2 class="dialog-title">源代码</h2>
            <textarea class="code-area" id="source-code-view" readonly></textarea>
            <div style="display:flex; justify-content:flex-end; gap:8px;">
                <button class="btn-filled" onclick="copySource()" style="width:auto; padding:0 24px;">
                    <span class="material-symbols-outlined">content_copy</span>
                    <span id="copy-btn-text">复制</span>
                </button>
                <button class="btn-text" onclick="document.getElementById('source-overlay').classList.remove('show')">关闭</button>
            </div>
        </div>
    </div>

    <!-- About Dialog -->
    <div class="dialog-overlay" id="about-overlay" onclick="closeAbout(event)">
        <div class="dialog">
            <h2 class="dialog-title">关于</h2>
            <p style="font-size:14px; line-height:1.6; opacity:0.8; margin-top:0;">
                <strong>高级沙盒模拟器 v2.5</strong><br><br>
                - 新增：暂停/开始功能<br>
                - 新增：缩放与平移系统 (设置中开启)<br>
                - 新元素：液氮、漂白剂、反重力粉末
            </p>
            <div style="text-align:right; margin-top:24px;">
                <button class="btn-text" onclick="document.getElementById('about-overlay').classList.remove('show')">返回</button>
            </div>
        </div>
    </div>

    <script>
        // ================= 配置与元素定义 =================
        let canvasScale = 4; 
        let isPaused = false;
        let zoomFeatureEnabled = false;
        let isViewMode = false;
        
        // Zoom/Pan State
        let scale = 1;
        let pPanning = false;
        let pointX = 0, pointY = 0, startX = 0, startY = 0;
        
        const TYPES = { EMPTY: 0, SOLID: 1, POWDER: 2, LIQUID: 3, GAS: 4 };

        const ELEMENTS = {
            AIR:   { id: 0, name: '空气', type: TYPES.EMPTY, color: [0,0,0,0] },
            
            // --- 固体 ---
            STONE: { id: 1, name: '石头', type: TYPES.SOLID, color: [120, 120, 120], variance: 20 },
            WOOD:  { id: 2, name: '木头', type: TYPES.SOLID, color: [139, 69, 19], flammable: true, burnRate: 0.03 },
            ICE:   { id: 3, name: '冰块', type: TYPES.SOLID, color: [173, 216, 230], meltRate: 0.01 },
            C4:    { id: 4, name: 'C-4',  type: TYPES.SOLID, color: [180, 200, 100], explosive: true, radius: 25 },
            FUSE:  { id: 5, name: '导火索', type: TYPES.SOLID, color: [100, 50, 50], flammable: true, burnRate: 0.2 },
            PLANT: { id: 6, name: '植物', type: TYPES.SOLID, color: [34, 139, 34], flammable: true, burnRate: 0.08 },
            CONC:  { id: 7, name: '水泥', type: TYPES.SOLID, color: [180, 180, 180], variance: 10 },
            WAX:   { id: 8, name: '蜡',   type: TYPES.SOLID, color: [240, 240, 220], meltRate: 0.05, flammable: true, burnRate: 0.02 },
            ELEC:  { id: 9, name: '雷电', type: TYPES.SOLID, color: [255, 255, 0], life: 3, hot: true, variance: 0 },
            GLASS: { id: 14, name: '玻璃', type: TYPES.SOLID, color: [200, 255, 255, 100], variance: 0 },
            URAN:  { id: 15, name: '铀',   type: TYPES.SOLID, color: [0, 255, 100], hot: true, variance: 50 },
            TNT:   { id: 17, name: 'TNT',  type: TYPES.SOLID, color: [200, 50, 50], explosive: true, radius: 45 },
            CLONE: { id: 80, name: '克隆', type: TYPES.SOLID, color: [255, 0, 255], clone: true },
            DRYICE:{ id: 18, name: '干冰', type: TYPES.SOLID, color: [240, 240, 255], sublimate: true },
            TERM:  { id: 81, name: '白蚁', type: TYPES.SOLID, color: [180, 150, 100], isBug: true },
            NA:    { id: 82, name: '钠',   type: TYPES.SOLID, color: [200, 200, 220], reactive: true },

            // --- 粉末 ---
            SAND:  { id: 10, name: '沙子', type: TYPES.POWDER, color: [226, 197, 139], variance: 20, density: 1.5 },
            GUNP:  { id: 11, name: '火药', type: TYPES.POWDER, color: [60, 60, 60], explosive: true, radius: 10 },
            SALT:  { id: 12, name: '盐',   type: TYPES.POWDER, color: [240, 240, 240], density: 1.2 },
            SEED:  { id: 13, name: '种子', type: TYPES.POWDER, color: [100, 255, 100], density: 1.1, grow: true },
            ASH:   { id: 16, name: '灰烬', type: TYPES.POWDER, color: [100, 100, 100], density: 1.3 },
            ANTIG: { id: 83, name: '反重力', type: TYPES.POWDER, color: [100, 200, 255], gravity: -1 }, // NEW
            BLEACH:{ id: 84, name: '漂白剂', type: TYPES.POWDER, color: [255, 250, 240], bleach: true }, // NEW

            // --- 液体 ---
            WATER: { id: 20, name: '水',   type: TYPES.LIQUID, color: [64, 164, 223], density: 1.0, variance: 10 },
            OIL:   { id: 21, name: '石油', type: TYPES.LIQUID, color: [50, 40, 20], density: 0.8, flammable: true, burnRate: 0.15 },
            ACID:  { id: 22, name: '酸液', type: TYPES.LIQUID, color: [124, 252, 0], density: 1.0, acid: true },
            LAVA:  { id: 23, name: '岩浆', type: TYPES.LIQUID, color: [255, 69, 0], density: 2.0, hot: true },
            MERC:  { id: 24, name: '水银', type: TYPES.LIQUID, color: [192, 192, 192], density: 4.0 },
            NITRO: { id: 85, name: '液氮', type: TYPES.LIQUID, color: [160, 220, 255], density: 0.9, cold: true }, // NEW

            // --- 气体/特效 ---
            FIRE:  { id: 30, name: '火焰', type: TYPES.GAS, color: [255, 100, 0], variance: 80, hot: true, life: 25 },
            STEAM: { id: 31, name: '蒸汽', type: TYPES.GAS, color: [220, 220, 255, 150], life: 100 },
            SMOKE: { id: 32, name: '烟雾', type: TYPES.GAS, color: [80, 80, 80, 100], life: 50 },
            GAS:   { id: 33, name: '甲烷', type: TYPES.GAS, color: [150, 255, 150, 100], flammable: true, burnRate: 0.8, density: 0.1 },
            FOG:   { id: 35, name: '白雾', type: TYPES.GAS, color: [240, 240, 255, 180], density: 1.2, life: 120, heavyGas: true },
            VIRUS: { id: 34, name: '病毒', type: TYPES.SOLID, color: [128, 0, 128], infect: true },

            ERASER:{ id: 99, name: '橡皮', type: TYPES.SOLID, color: [255,255,255,50], isEraser: true }
        };

        let currentEl = ELEMENTS.SAND;
        const canvas = document.getElementById('sandbox');
        const ctx = canvas.getContext('2d', { alpha: false });
        
        let width, height;
        let grid, imageData, buffer32;

        function initGrid() {
            const container = document.getElementById('game-container');
            width = Math.floor(container.clientWidth / canvasScale);
            height = Math.floor(container.clientHeight / canvasScale);
            
            canvas.width = width;
            canvas.height = height;
            
            grid = new Int32Array(width * height).fill(0);
            imageData = ctx.createImageData(width, height);
            buffer32 = new Uint32Array(imageData.data.buffer);
            resetZoom();
        }
        
        const idx = (x, y) => x + y * width;
        const inB = (x, y) => x >= 0 && x < width && y >= 0 && y < height;
        
        // ================= 引擎逻辑 =================
        function update() {
            if (!isPaused) {
                // Loop Logic
                for (let y = height - 1; y >= 0; y--) {
                    // Two-way scan check for anti-gravity
                    updateRow(y);
                }
                // Need a top-down pass for anti-gravity elements? 
                // Currently simplifying to single pass for performance. 
                // Anti-gravity will check upwards in standard loop or need specific handling.
                // For simplicity, handle antigrav by checking UP during the standard DOWN loop (it will move "slowly" per frame or needs inverted loop).
                // Let's implement Anti-Gravity in the standard loop but checking upwards.
            }
            draw();
            requestAnimationFrame(update);
        }

        function updateRow(y) {
            const scanLeft = Math.random() > 0.5;
            const startX = scanLeft ? 0 : width - 1;
            const endX = scanLeft ? width : -1;
            const stepX = scanLeft ? 1 : -1;

            for (let x = startX; x !== endX; x += stepX) {
                const i = idx(x, y);
                const id = grid[i];
                if (id === 0) continue;

                const el = getElById(id);
                if (!el) continue;

                if (processInteractions(x, y, i, el)) continue;

                // Move Logic
                if (el.gravity === -1) moveAntiGravity(x, y, i, el);
                else if (el.type === TYPES.POWDER) movePowder(x, y, i, el);
                else if (el.type === TYPES.LIQUID) moveLiquid(x, y, i, el);
                else if (el.type === TYPES.GAS) moveGas(x, y, i, el);
                else if (el.isBug) {
                        const dir = Math.random() < 0.25 ? -1 : (Math.random() > 0.75 ? 1 : 0);
                        const dy = Math.random() < 0.25 ? -1 : (Math.random() > 0.75 ? 1 : 0);
                        if (inB(x+dir, y+dy) && grid[idx(x+dir, y+dy)] === 0) swap(i, idx(x+dir, y+dy));
                }
            }
        }

        function processInteractions(x, y, i, el) {
            if (Math.random() > 0.4) return false; 
            const neighbors = [{x:x, y:y-1}, {x:x, y:y+1}, {x:x-1, y:y}, {x:x+1, y:y}];

            // 1. 克隆
            if (el.clone) {
                for(let n of neighbors) {
                    if(inB(n.x, n.y)) {
                        const nid = grid[idx(n.x, n.y)];
                        if (nid !== 0 && nid !== el.id) { grid[i] = nid; return true; }
                    }
                }
            }
            
            // 2. 漂白剂
            if (el.bleach) {
                for(let n of neighbors) {
                    if(inB(n.x, n.y)) {
                        const nid = grid[idx(n.x, n.y)];
                        const nel = getElById(nid);
                        if (nid !== 0 && nid !== el.id && nel.type !== TYPES.GAS) {
                             if(Math.random() < 0.1) {
                                // Turn neighbor to "White Powder" or just delete color logic?
                                // Let's turn it to Salt (white powder) as a visual approximation
                                grid[idx(n.x, n.y)] = ELEMENTS.SALT.id;
                                if(Math.random() < 0.2) grid[i] = 0; // Consume bleach
                                return true;
                             }
                        }
                    }
                }
            }

            // 3. 液氮
            if (el.cold) {
                // Freezes water to ice
                for(let n of neighbors) {
                    if(inB(n.x, n.y) && grid[idx(n.x, n.y)] === ELEMENTS.WATER.id) {
                        grid[idx(n.x, n.y)] = ELEMENTS.ICE.id;
                        grid[i] = ELEMENTS.GAS.id; // Nitrogen boils off
                        return true;
                    }
                }
                // Boils in air
                if (Math.random() < 0.05) { grid[i] = ELEMENTS.GAS.id; return true; }
            }

            // 4. 钠遇水爆炸
            if (el.reactive) {
                 for(let n of neighbors) {
                    if(inB(n.x, n.y) && grid[idx(n.x, n.y)] === ELEMENTS.WATER.id) {
                        explode(x, y, 15); return true;
                    }
                }
            }

            // 5. 白蚁吃木头
            if (el.isBug) {
                for(let n of neighbors) {
                    if(inB(n.x, n.y) && grid[idx(n.x, n.y)] === ELEMENTS.WOOD.id) {
                        grid[idx(n.x, n.y)] = 0; return true;
                    }
                }
            }

            // 6. 干冰升华
            if (el.sublimate) {
                if(Math.random() < 0.05) { grid[i] = ELEMENTS.FOG.id; return true; }
            }

            // 生命周期
            if (el.life) {
                if (Math.random() < 0.1) {
                    if (el.id === ELEMENTS.FIRE.id) grid[i] = ELEMENTS.SMOKE.id; 
                    else if (el.id === ELEMENTS.ELEC.id) grid[i] = 0;
                    else if (el.id === ELEMENTS.SMOKE.id || el.id === ELEMENTS.FOG.id) grid[i] = 0; 
                    else grid[i] = 0;
                    return true;
                }
            }

            // 燃烧/爆炸
            if (el.flammable || el.explosive) {
                let touchedFire = false;
                for (let n of neighbors) {
                    if (inB(n.x, n.y)) {
                        const nid = grid[idx(n.x, n.y)];
                        const nel = getElById(nid);
                        if (nel && (nel.hot || nel.id === ELEMENTS.LAVA.id || nel.id === ELEMENTS.ELEC.id || nel.id === ELEMENTS.URAN.id)) {
                            touchedFire = true;
                            break;
                        }
                    }
                }
                if (touchedFire) {
                    if (el.explosive) { explode(x, y, el.radius); return true; }
                    else if (el.flammable && Math.random() < el.burnRate) {
                        grid[i] = ELEMENTS.FIRE.id; 
                        if (Math.random() < 0.05) grid[i] = ELEMENTS.ASH.id;
                        return true;
                    }
                }
            }

            // 蜡熔化
            if (el.id === ELEMENTS.WAX.id) {
                 for (let n of neighbors) {
                    if (inB(n.x, n.y)) {
                        const nid = grid[idx(n.x, n.y)];
                        const nel = getElById(nid);
                        if(nel && nel.hot) {
                            if(Math.random() < el.meltRate) { grid[i] = ELEMENTS.OIL.id; return true; }
                        }
                    }
                 }
            }

            // 种子生长
            if (el.grow) {
                const down = idx(x, y+1);
                if (y+1 < height && (grid[down] === ELEMENTS.SAND.id || grid[down] === ELEMENTS.WATER.id)) {
                    if(Math.random() < 0.05) { grid[i] = ELEMENTS.PLANT.id; return true; }
                }
            }

            // 岩浆互动
            if (el.id === ELEMENTS.LAVA.id) {
                const up = idx(x, y-1);
                if (y-1 >= 0 && grid[up] === ELEMENTS.WATER.id) {
                    grid[up] = ELEMENTS.STEAM.id; grid[i] = ELEMENTS.STONE.id; return true;
                }
            }

            // 酸腐蚀
            if (el.acid) {
                const down = idx(x, y+1);
                if (y+1 < height && grid[down] !== 0 && grid[down] !== el.id && grid[down] !== ELEMENTS.ACID.id && grid[down] !== ELEMENTS.GLASS.id) {
                    if (Math.random() < 0.1) {
                        grid[down] = 0; 
                        if(Math.random() < 0.2) grid[i] = 0; 
                        return true;
                    }
                }
            }

            // 冰融化
            if (el.id === ELEMENTS.ICE.id) {
                 if (Math.random() < 0.005) { grid[i] = ELEMENTS.WATER.id; return true; } 
            }

            // 雷电破坏
            if (el.id === ELEMENTS.ELEC.id) {
                for(let n of neighbors) {
                    if(inB(n.x,n.y) && grid[idx(n.x,n.y)] !== 0) {
                        if(Math.random() < 0.5) grid[idx(n.x,n.y)] = ELEMENTS.FIRE.id;
                    }
                }
            }

            return false;
        }

        function explode(cx, cy, r) {
            grid[idx(cx, cy)] = ELEMENTS.FIRE.id;
            for (let y = -r; y <= r; y++) {
                for (let x = -r; x <= r; x++) {
                    if (x*x + y*y <= r*r) {
                        const px = cx + x; const py = cy + y;
                        if (inB(px, py)) {
                            if (Math.random() > 0.7) grid[idx(px, py)] = ELEMENTS.FIRE.id;
                            else if (Math.random() > 0.5) grid[idx(px, py)] = ELEMENTS.SMOKE.id;
                            else grid[idx(px, py)] = 0;
                        }
                    }
                }
            }
        }

        function moveAntiGravity(x, y, i, el) {
            const up = idx(x, y-1);
            if (y-1 >= 0) {
                if (grid[up] === 0) { swap(i, up); }
                else {
                    const dir = Math.random() > 0.5 ? 1 : -1;
                    if(inB(x+dir, y-1) && grid[idx(x+dir, y-1)] === 0) swap(i, idx(x+dir, y-1));
                }
            }
        }

        function movePowder(x, y, i, el) {
            const down = idx(x, y+1);
            if (y+1 < height) {
                const targetId = grid[down]; const targetEl = getElById(targetId);
                if (targetId === 0 || (targetEl && targetEl.type === TYPES.LIQUID && targetEl.density < el.density)) {
                    swap(i, down);
                } else {
                    const dir = Math.random() > 0.5 ? 1 : -1;
                    const sideDown = idx(x+dir, y+1);
                    if (inB(x+dir, y+1)) {
                         const sideId = grid[sideDown]; const sideEl = getElById(sideId);
                         if (sideId === 0 || (sideEl && sideEl.type === TYPES.LIQUID && sideEl.density < el.density)) {
                             swap(i, sideDown);
                         }
                    }
                }
            }
        }

        function moveLiquid(x, y, i, el) {
            const down = idx(x, y+1);
            if (y+1 < height) {
                const targetId = grid[down]; const targetEl = getElById(targetId);
                if (targetId === 0) { swap(i, down); return; } 
                else if (targetEl && targetEl.type === TYPES.LIQUID && el.density > targetEl.density) {
                    swap(i, down); return;
                }
            }
            const dir = Math.random() > 0.5 ? 1 : -1;
            const side = idx(x+dir, y);
            if (inB(x+dir, y) && grid[side] === 0) swap(i, side);
        }

        function moveGas(x, y, i, el) {
            const dirY = el.heavyGas ? 1 : -1;
            const nextY = y + dirY;
            if (nextY >= 0 && nextY < height) {
                const targetId = grid[idx(x, nextY)];
                const targetEl = getElById(targetId);
                if (targetId === 0 || (targetEl && targetEl.type === TYPES.LIQUID && !el.heavyGas)) {
                     swap(i, idx(x, nextY)); return;
                }
                if (el.id === ELEMENTS.SMOKE.id && Math.random() > 0.3) return;
                const dir = Math.random() > 0.5 ? 1 : -1;
                const sideY = idx(x+dir, nextY);
                if (inB(x+dir, nextY) && grid[sideY] === 0) swap(i, sideY);
            }
        }

        function swap(i, j) { const temp = grid[i]; grid[i] = grid[j]; grid[j] = temp; }
        function getElById(id) { return Object.values(ELEMENTS).find(e => e.id === id); }

        function draw() {
            buffer32.fill(0xFF000000); 
            for (let i = 0; i < grid.length; i++) {
                const id = grid[i];
                if (id !== 0) {
                    const el = getElById(id);
                    if (el) {
                        const [r, g, b, a=255] = el.color;
                        let R=r, G=g, B=b;
                        let v = 0;
                        if(el.variance) v = (Math.random() - 0.5) * el.variance;
                        else if (el.type === TYPES.LIQUID) v = (Math.random() - 0.5) * 10;
                        if (el.id === ELEMENTS.FIRE.id) {
                            if (Math.random() > 0.5) { R=255; G=200; } 
                            else { R=200; G=50; } 
                            v = (Math.random()-0.5) * 40;
                        }
                        buffer32[i] = (a << 24) | (clamp(B+v) << 16) | (clamp(G+v) << 8) | clamp(R+v);
                    }
                }
            }
            ctx.putImageData(imageData, 0, 0);
            frameCount++;
        }
        
        let frameCount = 0;
        setInterval(() => {
            if(showFps) document.getElementById('fps-counter').innerText = `${frameCount} FPS`;
            frameCount = 0;
        }, 1000);

        const clamp = v => Math.max(0, Math.min(255, v | 0));

        // ================= UI 操作 =================
        let isDrawing = false;
        let showFps = false;
        
        const QUICK_KEYS = ['SAND', 'WATER', 'STONE', 'FIRE', 'MERC', 'NITRO', 'TNT', 'BLEACH', 'ANTIG', 'ERASER'];

        function initUI() {
            initGrid();
            
            const quickBar = document.getElementById('quick-bar');
            const allGrid = document.getElementById('all-elements-grid');

            QUICK_KEYS.forEach(k => quickBar.appendChild(createChip(ELEMENTS[k], k)));

            Object.keys(ELEMENTS).forEach(k => {
                if (k === 'AIR') return;
                const el = ELEMENTS[k];
                const card = document.createElement('div');
                card.className = 'element-card';
                card.innerHTML = `
                    <div class="element-dot" style="background:rgba(${el.color[0]},${el.color[1]},${el.color[2]},1)"></div>
                    <span>${el.name}</span>
                `;
                card.onclick = () => selectElement(k);
                allGrid.appendChild(card);
            });
            updateActiveState();
        }

        function createChip(el, key) {
            const btn = document.createElement('button');
            btn.className = 'chip'; btn.dataset.key = key; 
            btn.innerHTML = `${el.name}`;
            btn.onclick = () => selectElement(key);
            return btn;
        }

        function selectElement(key) {
            currentEl = ELEMENTS[key];
            updateActiveState();
            toggleSheet(false);
        }

        function updateActiveState() {
            const currentKey = Object.keys(ELEMENTS).find(k => ELEMENTS[k] === currentEl);
            document.querySelectorAll('.chip').forEach(c => {
                if(c.dataset.key === currentKey) {
                    c.classList.add('active');
                    if(!c.querySelector('.material-symbols-outlined')) {
                        const check = document.createElement('span');
                        check.className = 'material-symbols-outlined';
                        check.style.fontSize = '18px';
                        check.innerText = 'check';
                        c.prepend(check);
                    }
                } else {
                    c.classList.remove('active');
                    const check = c.querySelector('.material-symbols-outlined');
                    if(check) check.remove();
                }
            });
        }

        function changeResolution(val) {
            canvasScale = parseInt(val);
            initGrid();
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pause-btn');
            btn.innerHTML = isPaused ? 
                '<span class="material-symbols-outlined">play_arrow</span>' : 
                '<span class="material-symbols-outlined">pause</span>';
        }

        // ================= Zoom / Pan Logic =================
        function toggleZoomFeature() {
            zoomFeatureEnabled = document.getElementById('zoom-toggle').checked;
            const btn = document.getElementById('view-mode-btn');
            if (zoomFeatureEnabled) {
                btn.classList.add('visible');
            } else {
                btn.classList.remove('visible');
                // Reset view if disabling
                isViewMode = false;
                btn.classList.remove('active');
                resetZoom();
            }
        }

        function toggleViewMode() {
            isViewMode = !isViewMode;
            const btn = document.getElementById('view-mode-btn');
            if (isViewMode) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function resetZoom() {
            scale = 1; pointX = 0; pointY = 0;
            updateTransform();
        }

        function updateTransform() {
            canvas.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        }

        function handleInput(e) {
            // Prevent default behavior to stop scrolling/zooming whole page
            e.preventDefault();

            // Handle Zoom/Pan Mode
            if (isViewMode && zoomFeatureEnabled) {
                if (e.type === 'mousedown' || e.type === 'touchstart') {
                    pPanning = true;
                    if(e.touches && e.touches.length === 2) {
                        // Pinch Zoom Start logic would go here
                    } else {
                        startX = (e.touches ? e.touches[0].clientX : e.clientX) - pointX;
                        startY = (e.touches ? e.touches[0].clientY : e.clientY) - pointY;
                    }
                } else if (e.type === 'mousemove' || e.type === 'touchmove') {
                    if (!pPanning) return;
                    if(e.touches && e.touches.length === 2) {
                         // Simplify: Just 1 finger pan for now in this version or wheel for zoom
                         // Full pinch zoom requires complex math, simplified here to drag pan
                    } else {
                        pointX = (e.touches ? e.touches[0].clientX : e.clientX) - startX;
                        pointY = (e.touches ? e.touches[0].clientY : e.clientY) - startY;
                        updateTransform();
                    }
                } else if (e.type === 'mouseup' || e.type === 'touchend') {
                    pPanning = false;
                }
                return; 
            }

            // Handle Drawing
            if (!isDrawing && e.type !== 'mousemove' && e.type !== 'touchmove') return;
            if (!isDrawing && (e.type === 'mousemove' || e.type === 'touchmove')) return;

            // Coordinate Calculation compensating for Zoom/Pan
            const rect = canvas.getBoundingClientRect(); 
            // rect includes the scale and translation transform automatically!
            
            let cx = e.touches ? e.touches[0].clientX : e.clientX;
            let cy = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = Math.floor((cx - rect.left) / rect.width * width);
            const y = Math.floor((cy - rect.top) / rect.height * height);
            const r = parseInt(document.getElementById('brushSize').value);

            for (let dy = -r; dy <= r; dy++) {
                for (let dx = -r; dx <= r; dx++) {
                    if (dx*dx + dy*dy <= r*r) {
                        const px = x + dx; const py = y + dy;
                        if (inB(px, py)) {
                            if (currentEl.isEraser) grid[idx(px, py)] = 0;
                            else if (grid[idx(px, py)] === 0 || currentEl.type === TYPES.SOLID) { 
                                if (Math.random() > 0.05) grid[idx(px, py)] = currentEl.id;
                            }
                        }
                    }
                }
            }
        }

        // Add Wheel Zoom support
        canvas.addEventListener('wheel', (e) => {
            if (!zoomFeatureEnabled || !isViewMode) return;
            e.preventDefault();
            const xs = (e.clientX - pointX) / scale;
            const ys = (e.clientY - pointY) / scale;
            const delta = -e.deltaY;
            
            (delta > 0) ? (scale *= 1.1) : (scale /= 1.1);
            if(scale < 1) scale = 1; // Min zoom
            if(scale > 10) scale = 10; // Max zoom
            
            pointX = e.clientX - xs * scale;
            pointY = e.clientY - ys * scale;
            updateTransform();
        }, {passive: false});

        // Event Listeners
        canvas.addEventListener('mousedown', e => { 
            if(!isViewMode) isDrawing=true; 
            handleInput(e); 
        });
        canvas.addEventListener('mousemove', handleInput);
        window.addEventListener('mouseup', () => { isDrawing=false; pPanning=false; });
        
        canvas.addEventListener('touchstart', e => { 
            if(!isViewMode) isDrawing=true; 
            handleInput(e); 
        }, {passive:false});
        canvas.addEventListener('touchmove', handleInput, {passive:false});
        window.addEventListener('touchend', () => { isDrawing=false; pPanning=false; });

        // Dialog Functions
        function toggleSheet(open) {
            const sheet = document.getElementById('more-sheet');
            toggleBackdrop(open);
            if(open) sheet.classList.add('open'); else sheet.classList.remove('open');
        }
        function toggleBackdrop(show) {
            const bd = document.getElementById('backdrop');
            if(show) bd.classList.add('open'); else bd.classList.remove('open');
        }
        function openSettings() {
            document.getElementById('settings-overlay').classList.add('show');
            toggleBackdrop(true);
        }
        function closeSettings(e) {
            if (e.target.id === 'settings-overlay') {
                document.getElementById('settings-overlay').classList.remove('show');
                toggleBackdrop(false);
            }
        }
        function openSourceView() {
            const htmlContent = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
            document.getElementById('source-code-view').value = htmlContent;
            document.getElementById('settings-overlay').classList.remove('show');
            document.getElementById('source-overlay').classList.add('show');
            toggleBackdrop(true);
        }
        function copySource() {
            const textArea = document.getElementById('source-code-view');
            textArea.select();
            document.execCommand('copy'); 
            const btnText = document.getElementById('copy-btn-text');
            const original = btnText.innerText;
            btnText.innerText = "已复制";
            setTimeout(() => btnText.innerText = original, 2000);
        }
        function closeSource(e) {
            if (e.target.id === 'source-overlay') {
                document.getElementById('source-overlay').classList.remove('show');
                toggleBackdrop(false);
            }
        }
        function openAbout() { document.getElementById('about-overlay').classList.add('show'); }
        function closeAbout(e) { if(e.target.id==='about-overlay') document.getElementById('about-overlay').classList.remove('show'); }
        function closeAllOverlays() {
            toggleSheet(false);
            document.getElementById('settings-overlay').classList.remove('show');
            document.getElementById('about-overlay').classList.remove('show');
            document.getElementById('source-overlay').classList.remove('show');
        }
        function toggleFPS() {
            showFps = document.getElementById('fps-toggle').checked;
            document.getElementById('fps-counter').style.display = showFps ? 'block' : 'none';
        }
        function clearCanvas() { grid.fill(0); resetZoom(); }

        initUI();
        requestAnimationFrame(update);
    </script>
</body>
</html>

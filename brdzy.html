<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡¥å…ƒæ—¦ä½œä¸š v8.0 (å¿«ä¹åŠ å€ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #d32f2f;
            --primary-light: #ff6659;
            --accent-color: #fbc02d;
            --bg-color: #ffffff;
            --surface-color: #f5f5f5;
            --text-color: #333333;
            --text-secondary: #666666;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.14);
            --ease-elastic: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-smooth: cubic-bezier(0.4, 0.0, 0.2, 1);
            --buff-color: #2979ff;
            --event-color: #9c27b0;
            --tech-color: #00bcd4;
            --help-color: #ff9800;
            --chaos-color: #e91e63; /* æ··æ²Œè‰² */
            --code-bg: #282c34;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Roboto', 'Helvetica Neue', 'PingFang SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #app {
            width: 100%;
            max-width: 480px;
            height: 100%;
            position: relative;
            background: #fff;
            display: flex;
            flex-direction: column;
            z-index: 1;
        }

        /* ç´§æ€¥çŠ¶æ€çº¢è‰²é—ªçƒèƒŒæ™¯ */
        #danger-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 50px rgba(211, 47, 47, 0.6);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 10;
            animation: pulse 1s infinite alternate;
            display: none;
        }
        @keyframes pulse {
            from { box-shadow: inset 0 0 30px rgba(211, 47, 47, 0.4); }
            to { box-shadow: inset 0 0 80px rgba(211, 47, 47, 0.8); }
        }

        /* é¡µé¢åŸºç¡€ */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.4s var(--ease-smooth), transform 0.4s var(--ease-smooth);
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        .page.active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1);
        }

        h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 30px;
            text-align: center;
            font-weight: 900;
            text-shadow: 2px 2px 0px var(--accent-color);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 1.2rem;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: transform 0.1s var(--ease-smooth), box-shadow 0.2s;
            position: relative;
            width: 80%;
            max-width: 300px;
            text-align: center;
            white-space: nowrap;
            margin-bottom: 15px;
        }
        .btn:active { transform: scale(0.95); box-shadow: var(--shadow-sm); }
        
        .btn-secondary {
            background-color: #fff;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .ripple-btn {
            position: relative;
            overflow: hidden;
            transform: translate3d(0, 0, 0);
        }

        /* æ¸¸æˆä¸»ç•Œé¢å¸ƒå±€ */
        #game-screen {
            justify-content: flex-start;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .status-card {
            background: var(--surface-color);
            width: 100%;
            padding: 15px;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 10px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        /* Buff æŒ‡ç¤ºå™¨ */
        #buff-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--buff-color);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(41, 121, 255, 0.3);
            transform: translateX(120%);
            transition: transform 0.3s var(--ease-elastic);
        }
        #buff-indicator.show { transform: translateX(0); }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .progress-track {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .progress-track:last-child { margin-bottom: 0; }

        .progress-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.6s var(--ease-elastic), background-color 0.3s;
        }
        #homework-bar { background-color: var(--primary-color); width: 0%; }
        #time-bar { background-color: var(--accent-color); width: 100%; }

        /* æ—¥å¿—åŒºåŸŸ */
        #event-log {
            flex: 1;
            width: 100%;
            background: #fff;
            border: 2px solid var(--surface-color);
            border-radius: 12px;
            margin-bottom: 10px;
            padding: 10px;
            overflow-y: auto;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column-reverse;
            min-height: 60px;
            max-height: 140px;
        }

        .log-item {
            padding: 6px 10px;
            margin-bottom: 5px;
            background: var(--surface-color);
            border-radius: 6px;
            border-left: 4px solid;
            animation: slideIn 0.4s var(--ease-elastic);
            line-height: 1.3;
        }
        .log-item.good { border-left-color: #4caf50; }
        .log-item.bad { border-left-color: var(--primary-color); }
        .log-item.neutral { border-left-color: var(--accent-color); }
        .log-item.buff { border-left-color: var(--buff-color); background: #e3f2fd; }
        .log-item.event { border-left-color: var(--event-color); background: #f3e5f5; font-weight: bold; }
        .log-item.chaos { border-left-color: var(--chaos-color); background: #fce4ec; font-weight: bold; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* æŒ‰é’®ç½‘æ ¼ - æ»šåŠ¨å®¹å™¨ */
        .action-container {
            width: 100%;
            flex: 1.5;
            overflow-y: auto;
            padding-bottom: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: min-content;
            gap: 10px;
            padding: 2px;
        }

        .action-btn {
            background: white;
            border: 1px solid #eee;
            color: var(--text-color);
            padding: 12px 4px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s var(--ease-smooth);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 75px;
        }
        .action-btn:active { transform: scale(0.95); background: var(--surface-color); }
        .emoji-icon { font-size: 1.5rem; }

        /* ç‰¹æ®ŠæŒ‰é’®é¢œè‰² */
        .btn-buff { border-bottom: 3px solid var(--buff-color); }
        .btn-risk { border-bottom: 3px solid var(--primary-color); }
        .btn-special { border-bottom: 3px solid var(--event-color); }
        .btn-tech { border-bottom: 3px solid var(--tech-color); }
        .btn-help { border-bottom: 3px solid var(--help-color); }
        .btn-chaos { border: 2px dashed var(--chaos-color); background: #fff0f5; }

        /* æ¶Ÿæ¼ª */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            background-color: rgba(0, 0, 0, 0.15);
            pointer-events: none;
        }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        /* ç»“æœé¡µ */
        .result-content { 
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        #result-title { font-size: 2rem; margin-bottom: 10px; }
        #result-desc { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5; }
        
        /* v8.0 ç§°å·å¾½ç«  */
        #achievement-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #fff;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(255, 165, 0, 0.4);
            animation: popIn 0.5s var(--ease-elastic);
            display: none;
        }
        @keyframes popIn {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        /* æºä»£ç å¼¹çª—æ ·å¼ */
        #code-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #code-modal.visible {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            height: 80%;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.3s var(--ease-elastic);
        }
        #code-modal.visible .modal-content {
            transform: scale(1);
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .code-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        #code-textarea {
            flex: 1;
            width: 100%;
            background-color: var(--code-bg);
            color: #abb2bf;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.8rem;
            resize: none;
            margin-bottom: 15px;
            user-select: text;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-copy { background: #4caf50; color: white; }
        .btn-close { background: #eee; color: #333; }

        /* å½©å¸¦ç‰¹æ•ˆ Canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* å°å±é€‚é… */
        @media (max-height: 680px) {
            h1 { font-size: 1.8rem; margin-bottom: 15px; }
            .status-card { padding: 10px; margin-bottom: 5px; }
            .action-btn { min-height: 60px; font-size: 0.8rem; padding: 8px; }
            .emoji-icon { font-size: 1.2rem; }
            #event-log { min-height: 50px; }
            .modal-content { height: 90%; }
        }
    </style>
</head>
<body>
    <div id="danger-overlay"></div>
    <canvas id="confetti-canvas"></canvas>
    
    <div id="app">
        <!-- é¦–é¡µ -->
        <div id="home-screen" class="page active">
            <h1>ğŸ–‹è¡¥å…ƒæ—¦ä½œä¸šğŸ–‹</h1>
            <p style="color:var(--text-secondary); margin-bottom: 30px;">v8.0 å¿«ä¹åŠ å€ï¼šæˆå°±ç³»ç»Ÿä¸é­”æ³•çŒ®ç¥­</p>
            <button class="btn ripple-btn" onclick="startGame()">å¼€å§‹è¡¥ä½œä¸š</button>
            <button class="btn btn-secondary ripple-btn" onclick="showSourceCode()">æŸ¥çœ‹/å¤åˆ¶ æºä»£ç </button>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="game-screen" class="page">
            <div class="status-card">
                <div id="buff-indicator">
                    <span>âš¡ ç²¾åŠ›æ—ºç››</span>
                    <span id="buff-count">3</span>
                </div>
                <div class="progress-label">
                    <span>ğŸ“š ä½œä¸šè¿›åº¦</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="progress-track">
                    <div id="homework-bar" class="progress-bar"></div>
                </div>

                <div class="progress-label" style="margin-top: 8px;">
                    <span>ğŸ•› å‰©ä½™æ—¶é—´</span>
                    <span id="time-text">100%</span>
                </div>
                <div class="progress-track">
                    <div id="time-bar" class="progress-bar"></div>
                </div>
            </div>

            <div id="event-log">
                <div class="log-item neutral">å‡æœŸä½™é¢ä¸è¶³ï¼Œå…¨å®¶æ€»åŠ¨å‘˜å¼€å§‹ï¼</div>
            </div>

            <div class="action-container">
                <div class="action-grid">
                    <!-- 1. åŸºç¡€ -->
                    <button class="action-btn ripple-btn" onclick="takeAction('write')">
                        <span class="emoji-icon">ğŸ–‹</span>
                        è€å®å†™ä½œä¸š
                    </button>
                    <button class="action-btn ripple-btn" onclick="takeAction('phone')">
                        <span class="emoji-icon">ğŸ“±</span>
                        ç©ä¼šå„¿æ‰‹æœº
                    </button>
                    
                    <!-- 2. AIä¸æœç´¢ -->
                    <button class="action-btn ripple-btn" onclick="takeAction('kimi')">
                        <span class="emoji-icon">ğŸ’»</span>
                        Kimiæœç­”æ¡ˆ
                    </button>
                    <button class="action-btn ripple-btn btn-tech" onclick="takeAction('zyb')">
                        <span class="emoji-icon">ğŸ“¸</span>
                        ä½œä¸šå¸®æœé¢˜
                    </button>
                    <button class="action-btn ripple-btn btn-tech" onclick="takeAction('web')">
                        <span class="emoji-icon">ğŸŒ</span>
                        ç½‘ä¸Šæœä¸€æœ
                    </button>

                    <!-- 3. æ±‚åŠ© -->
                    <button class="action-btn ripple-btn btn-help" onclick="takeAction('ask')">
                        <span class="emoji-icon">âœ‰ï¸</span>
                        æ±‚åŠ©å­¦éœ¸
                    </button>
                    <button class="action-btn ripple-btn btn-help" onclick="takeAction('teacher')">
                        <span class="emoji-icon">ğŸ‘©â€ğŸ«</span>
                        é—®è€å¸ˆ
                    </button>
                    <button class="action-btn ripple-btn btn-help" onclick="takeAction('parent')">
                        <span class="emoji-icon">ğŸ‘ª</span>
                        å«å®¶é•¿
                    </button>

                    <!-- 4. æŠ•æœºä¸ç‰¹æ®Š -->
                    <button class="action-btn ripple-btn" onclick="takeAction('guess')">
                        <span class="emoji-icon">ğŸ²</span>
                        å…¨é€‰C
                    </button>
                    <button class="action-btn ripple-btn" onclick="takeAction('copy')">
                        <span class="emoji-icon">ğŸ“–</span>
                        æŠ„ä¹¦åç­”æ¡ˆ
                    </button>
                    <button class="action-btn ripple-btn btn-buff" onclick="takeAction('coffee')">
                        <span class="emoji-icon">â˜•</span>
                        å–çº¢ç‰› (Buff)
                    </button>
                    <button class="action-btn ripple-btn btn-risk" onclick="takeAction('tear')">
                        <span class="emoji-icon">âœ‚ï¸</span>
                        æ’•æ‰è¿™é¡µ
                    </button>

                    <!-- 5. ç–¯ç‹‚ -->
                    <button class="action-btn ripple-btn btn-special" onclick="takeAction('clock')">
                        <span class="emoji-icon">â³</span>
                        è°ƒæ…¢æ—¶é’Ÿ
                    </button>
                    <button class="action-btn ripple-btn btn-special" onclick="takeAction('hire')">
                        <span class="emoji-icon">ğŸ‘¯â€â™€ï¸</span>
                        é›‡ä½£è€å¦¹
                    </button>

                    <!-- 6. ä¼‘é—²ä¸é£é™© -->
                    <button class="action-btn ripple-btn" onclick="takeAction('music')">
                        <span class="emoji-icon">ğŸ§</span>
                        å¬éŸ³ä¹
                    </button>
                    <button class="action-btn ripple-btn btn-risk" onclick="takeAction('sick')">
                        <span class="emoji-icon">ğŸ¤’</span>
                        è£…ç—…
                    </button>

                    <!-- 7. v8.0 æ–°å¢è¶£å‘³é€‰é¡¹ -->
                    <button class="action-btn ripple-btn btn-chaos" onclick="takeAction('sacrifice')">
                        <span class="emoji-icon">ğŸ”®</span>
                        çŒ®ç¥­ç¬”èŠ¯
                    </button>
                    <button class="action-btn ripple-btn" onclick="takeAction('nap')">
                        <span class="emoji-icon">ğŸ’¤</span>
                        æˆ˜æœ¯è¡¥è§‰
                    </button>
                </div>
            </div>
        </div>

        <!-- ç»“æœç•Œé¢ -->
        <div id="result-screen" class="page">
            <div class="result-content">
                <h1 id="result-title">ç»“æœ</h1>
                <!-- ç§°å·å¾½ç«  -->
                <div id="achievement-badge">ç§°å·: è¿™ä¹ˆå·®ï¼Œç›´æ¥ç»™æˆ‘å½“ä½œä¸šæ–°æ‰‹</div>
                <div style="font-size: 4rem; margin-bottom: 20px;" id="result-emoji">ğŸ˜</div>
                <p id="result-desc">åœ¨è¿™é‡Œæ˜¾ç¤ºç»“æœæè¿°</p>
                <button class="btn ripple-btn" onclick="resetGame()">å†ç©ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <!-- æºä»£ç æ¨¡æ€æ¡† -->
    <div id="code-modal">
        <div class="modal-content">
            <div class="code-header">
                <span class="code-title">ğŸ“œ ç½‘é¡µæºä»£ç </span>
                <span style="font-size:0.8rem; color:#666;">å¯ä»¥å…¨é€‰å¤åˆ¶ç”¨äºäºŒåˆ›</span>
            </div>
            <textarea id="code-textarea" readonly></textarea>
            <div class="modal-actions">
                <button class="modal-btn btn-copy" onclick="copySource()">å¤åˆ¶å…¨éƒ¨ä»£ç </button>
                <button class="modal-btn btn-close" onclick="closeSourceModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€ä¸ç»Ÿè®¡
        let state = {
            progress: 0,
            time: 100,
            isGameOver: false,
            buffTurns: 0,
            lastAction: '',
            // v8.0 ç»Ÿè®¡æ•°æ®ç”¨äºæˆå°±
            stats: {
                honest: 0,   // è€å®å†™æ¬¡æ•°
                cheat: 0,    // ç§‘æŠ€/æŠ„è¢­æ¬¡æ•°
                risk: 0,     // é£é™©æ¬¡æ•°
                chaos: 0,    // çŒ®ç¥­æ¬¡æ•°
                help: 0      // æ±‚åŠ©æ¬¡æ•°
            }
        };

        // DOM å…ƒç´ 
        const screens = {
            home: document.getElementById('home-screen'),
            game: document.getElementById('game-screen'),
            result: document.getElementById('result-screen')
        };
        const bars = {
            homework: document.getElementById('homework-bar'),
            time: document.getElementById('time-bar')
        };
        const texts = {
            progress: document.getElementById('progress-text'),
            time: document.getElementById('time-text')
        };
        const logContainer = document.getElementById('event-log');
        const buffIndicator = document.getElementById('buff-indicator');
        const buffCountText = document.getElementById('buff-count');
        const dangerOverlay = document.getElementById('danger-overlay');
        const achievementBadge = document.getElementById('achievement-badge');
        
        // æºä»£ç ç›¸å…³DOM
        const codeModal = document.getElementById('code-modal');
        const codeTextarea = document.getElementById('code-textarea');

        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[screenName].classList.add('active');
        }

        function startGame() {
            // é‡ç½®çŠ¶æ€
            state = { 
                progress: 0, 
                time: 100, 
                isGameOver: false, 
                buffTurns: 0, 
                lastAction: '',
                stats: { honest: 0, cheat: 0, risk: 0, chaos: 0, help: 0 }
            };
            logContainer.innerHTML = '<div class="log-item neutral">å‡æœŸä½™é¢ä¸è¶³ï¼Œå…¨å®¶æ€»åŠ¨å‘˜å¼€å§‹ï¼</div>';
            dangerOverlay.style.display = 'none';
            achievementBadge.style.display = 'none';
            updateUI();
            switchScreen('game');
        }

        function resetGame() {
            switchScreen('home');
        }

        // --- æºä»£ç åŠŸèƒ½ ---
        function showSourceCode() {
            const html = document.documentElement.outerHTML;
            codeTextarea.value = html;
            codeModal.classList.add('visible');
        }
        function closeSourceModal() {
            codeModal.classList.remove('visible');
        }
        function copySource() {
            codeTextarea.select();
            codeTextarea.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(codeTextarea.value).then(() => {
                const btn = document.querySelector('.btn-copy');
                const originalText = btn.innerText;
                btn.innerText = "å¤åˆ¶æˆåŠŸï¼";
                setTimeout(() => btn.innerText = originalText, 2000);
            });
        }

        function updateUI() {
            bars.homework.style.width = `${state.progress}%`;
            bars.time.style.width = `${state.time}%`;
            
            if(state.time < 20) {
                bars.time.style.backgroundColor = 'var(--primary-color)';
                dangerOverlay.style.display = 'block';
                dangerOverlay.style.opacity = '1';
            } else {
                bars.time.style.backgroundColor = 'var(--accent-color)';
                dangerOverlay.style.display = 'none';
            }

            texts.progress.innerText = `${Math.floor(state.progress)}%`;
            texts.time.innerText = `${Math.floor(state.time)}%`;

            if(state.buffTurns > 0) {
                buffIndicator.classList.add('show');
                buffCountText.innerText = state.buffTurns;
            } else {
                buffIndicator.classList.remove('show');
            }
        }

        function addLog(message, type = 'neutral') {
            const div = document.createElement('div');
            div.className = `log-item ${type}`;
            div.innerText = message;
            logContainer.insertBefore(div, logContainer.firstChild);
            if(logContainer.children.length > 25) logContainer.lastChild.remove();
        }

        function checkGameOver() {
            if (state.progress >= 100) {
                endGame(true);
                return true;
            }
            if (state.time <= 0) {
                endGame(false);
                return true;
            }
            return false;
        }

        // v8.0 è®¡ç®—æˆå°±ç§°å·
        function determineAchievement() {
            const s = state.stats;
            const total = s.honest + s.cheat + s.risk + s.chaos + s.help;
            
            if (s.chaos > 2) return "æ··æ²Œé­”ç‹";
            if (s.cheat > s.honest * 2) return "ç§‘æŠ€ä¸ç‹ æ´»";
            if (s.risk > 3) return "ç»å‘½èµŒå¾’";
            if (s.honest > total * 0.7) return "å·ç‹ä¹‹ç‹";
            if (s.help > 4) return "å•ƒè€ä¸€æ—";
            if (state.time < 5) return "å‹å“¨ç»æ€";
            return "ä½œä¸šè¡¥å…¨å¸ˆ";
        }

        function endGame(isWin) {
            state.isGameOver = true;
            dangerOverlay.style.display = 'none';
            
            setTimeout(() => {
                switchScreen('result');
                const title = document.getElementById('result-title');
                const desc = document.getElementById('result-desc');
                const emoji = document.getElementById('result-emoji');
                
                // æ˜¾ç¤ºæˆå°±å¾½ç« 
                const achievement = determineAchievement();
                achievementBadge.innerText = `ğŸ–ï¸ ç§°å·ï¼š${achievement}`;
                achievementBadge.style.display = 'inline-block';

                if (isWin) {
                    title.innerText = "ç‰›é€¼ï¼Œç›´æ¥å¥‡è¿¹è¯ç”Ÿï¼";
                    title.style.color = "#4caf50";
                    emoji.innerText = "ğŸ‰";
                    
                    // è§¦å‘å½©å¸¦ç‰¹æ•ˆ
                    fireConfetti();

                    if (state.time <= 5) {
                        desc.innerText = `å‰©ä½™æ—¶é—´ ${Math.floor(state.time)}%... \nå¿ƒè„éƒ½è¦è·³å‡ºæ¥äº†ï¼æé™å‹å“¨ï¼`;
                    } else if (state.time > 40) {
                        desc.innerText = `å‰©ä½™ ${Math.floor(state.time)}% æ—¶é—´ï¼\nè½»è½»æ¾æ¾ï¼Œè¿™å°±æ˜¯å¼ºè€…çš„ä»å®¹ã€‚`;
                    } else {
                        desc.innerText = `å‰©ä½™ ${Math.floor(state.time)}% æ—¶é—´ã€‚\nç»ˆäºè¡¥å®Œäº†ï¼Œå®‰å¿ƒç¡è§‰ï¼`;
                    }
                } else {
                    title.innerText = "å½»åº•å‡‰å‡‰...";
                    title.style.color = "var(--primary-color)";
                    emoji.innerText = "ğŸ˜­";
                    desc.innerText = `è¿›åº¦åœç•™åœ¨ ${Math.floor(state.progress)}%ã€‚\nå‡†å¤‡å¥½è¿æ¥æ··åˆåŒæ‰“å§...`;
                }
            }, 800);
        }

        // v8.0 å½©å¸¦ç‰¹æ•ˆ
        function fireConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const colors = ['#f44336', '#2196f3', '#ffeb3b', '#4caf50', '#9c27b0'];
            
            for(let i=0; i<100; i++) {
                particles.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20,
                    size: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    life: 100
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    if(p.life > 0) {
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += 0.5; // gravity
                        p.life--;
                        ctx.fillStyle = p.color;
                        ctx.fillRect(p.x, p.y, p.size, p.size);
                        active = true;
                    }
                });
                if(active) requestAnimationFrame(animate);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            animate();
        }

        // éšæœºäº‹ä»¶
        function triggerRandomEvent() {
            if (Math.random() > 0.18) return; 

            const events = [
                { msg: "ã€çªå‘ã€‘åœç”µäº†ï¼åªèƒ½ç‚¹èœ¡çƒ›å†™...", time: -6, type: 'event' },
                { msg: "ã€çªå‘ã€‘ç¬”æ‘”æ–­äº†ï¼Œå¢¨æ°´æº…äº†ä¸€èº«...", time: -5, type: 'event' },
                { msg: "ã€çªå‘ã€‘å‘ç°å»å¹´çš„å‹å²é’±ï¼å£«æ°”å¤§æŒ¯ã€‚", progress: 6, type: 'event' },
                { msg: "ã€çªå‘ã€‘å¦ˆå¦ˆé€æ°´æœï¼Œè¢«è¿«å‡è£…æ€è€ƒ...", time: -4, type: 'event' },
                { msg: "ã€çªå‘ã€‘ç¾¤é‡Œè¯´æœ‰ä¸€é¡µä¸ç”¨å†™ï¼å¥½è€¶ï¼", progress: 8, type: 'event' },
                { msg: "ã€çªå‘ã€‘æƒ³ä¸Šå•æ‰€ï¼Œæ²¡çº¸äº†...", time: -8, type: 'event' },
                { msg: "ã€çªå‘ã€‘ç‹—æŠŠä½œä¸šå¼èµ°äº†ï¼", time: -7, type: 'event' }
            ];

            const evt = events[Math.floor(Math.random() * events.length)];
            setTimeout(() => {
                if(evt.time) state.time += evt.time;
                if(evt.progress) state.progress += evt.progress;
                addLog(evt.msg, evt.type);
                updateUI();
                checkGameOver();
            }, 500); 
        }

        function takeAction(actionType) {
            if (state.isGameOver) return;

            let progressChange = 0;
            let timeChange = 0;
            let msg = "";
            let type = "neutral";
            let rand = Math.random();

            // è¿å‡»ç³»ç»Ÿ
            let comboBonus = 0;
            if (state.lastAction === actionType && ['write', 'kimi', 'zyb'].includes(actionType)) {
                comboBonus = 3;
            }
            state.lastAction = actionType;

            // Buff é€»è¾‘
            let multiplier = 1;
            const noBuffActions = ['coffee', 'phone', 'clock', 'tear', 'music', 'nap', 'sacrifice'];
            if(state.buffTurns > 0 && !noBuffActions.includes(actionType)) {
                multiplier = 1.5;
                state.buffTurns--;
            }

            switch(actionType) {
                // --- åŸºç¡€ ---
                case 'write': 
                    state.stats.honest++;
                    timeChange = -10; progressChange = 12 * multiplier;
                    if(rand > 0.8) { progressChange += 5; msg = "è¿›å…¥å¿ƒæµçŠ¶æ€ï¼Œä¸‹ç¬”å¦‚æœ‰ç¥ï¼"; type = "good"; } 
                    else { msg = "è€è€å®å®å†™å®Œäº†ä¸€é¡µç»ƒä¹ å†Œã€‚"; }
                    break;
                case 'phone': 
                    state.stats.risk++;
                    timeChange = -15;
                    if (rand > 0.6) { progressChange = -5; msg = "åˆ·è§†é¢‘å¤ªä¸Šå¤´ï¼Œå•è¯å…¨å¿˜äº†ï¼"; type = "bad"; } 
                    else { msg = "å›äº†å‡ æ¡æ¶ˆæ¯ï¼Œè¿˜å¥½æ²¡æ²‰è¿·ã€‚"; }
                    break;

                // --- ç§‘æŠ€ ---
                case 'kimi': 
                    state.stats.cheat++;
                    timeChange = -6;
                    if (rand > 0.85) { progressChange = 0; msg = "ç½‘æ–­äº†ï¼Kimi æ€è€ƒè¶…æ—¶..."; type = "bad"; } 
                    else { progressChange = 28 * multiplier; msg = "Kimi ç»™å‡ºå®Œç¾è§£æï¼ŒæŠ„å¾—é£èµ·ï¼"; type = "good"; }
                    break;
                case 'zyb': 
                    state.stats.cheat++;
                    timeChange = -5;
                    if (rand > 0.7) { progressChange = 32 * multiplier; msg = "æ‹ç…§æœé¢˜ä¸€ç§’å‡ºç­”æ¡ˆï¼Œç§‘æŠ€ä¸‡å²ï¼"; type = "good"; } 
                    else if (rand < 0.2) { progressChange = 0; timeChange = -10; msg = "è¢«å¼ºåˆ¶çœ‹30ç§’è§†é¢‘å¹¿å‘Šï¼"; type = "bad"; } 
                    else { progressChange = 5; msg = "æœä¸åˆ°åŸé¢˜ï¼Œæ‰¾ä¸ªç±»ä¼¼çš„å‚è€ƒã€‚"; type = "neutral"; }
                    break;
                case 'web': 
                    state.stats.cheat++;
                    timeChange = -8;
                    if (rand > 0.5) { progressChange = 20 * multiplier; msg = "åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ç±»ä¼¼é¢˜ç›®ã€‚"; type = "neutral"; } 
                    else { progressChange = 0; msg = "æœç€æœç€ç‚¹è¿›äº†å¨±ä¹æ–°é—»..."; type = "bad"; }
                    break;

                // --- æ±‚åŠ© ---
                case 'ask': 
                    state.stats.help++;
                    timeChange = -8;
                    if (rand > 0.5) { progressChange = 30 * multiplier; msg = "å­¦éœ¸å‘æ¥å·å­ç…§ç‰‡ï¼Œè¿™æ³¢ç¨³äº†ã€‚"; type = "good"; } 
                    else { progressChange = 0; msg = "å­¦éœ¸ï¼š'æˆ‘ä¹Ÿåœ¨è¡¥å‘¢ï¼Œåˆ«çƒ¦æˆ‘'ã€‚"; type = "bad"; }
                    break;
                case 'teacher': 
                    state.stats.help++;
                    timeChange = -15; 
                    if (rand > 0.6) { progressChange = 40; msg = "è€å¸ˆå‘æ¥è¯­éŸ³è®²è§£ï¼Œè±ç„¶å¼€æœ—ï¼"; type = "good"; } 
                    else { progressChange = 0; timeChange = -5; msg = "è€å¸ˆï¼š'æ˜å¤©æ¥åŠå…¬å®¤æ‰¾æˆ‘'ã€‚"; type = "bad"; }
                    break;
                case 'parent': 
                    state.stats.help++;
                    timeChange = -10;
                    if (rand > 0.8) { progressChange = 50; msg = "çˆ¸çˆ¸å¸®ä½ æŠ„äº†ä¸€æ•´ç« è¯¾æ–‡ï¼"; type = "good"; } 
                    else if (rand < 0.4) { progressChange = 0; timeChange = -20; msg = "è¢«çˆ¸å¦ˆæ··åˆåŒæ‰“è®­è¯åŠå°æ—¶ï¼"; type = "bad"; } 
                    else { progressChange = 15; msg = "å¦ˆå¦ˆç›‘ç£ï¼Œè™½ç„¶æ…¢ä½†ä¸æ•¢èµ°ç¥ã€‚"; type = "neutral"; }
                    break;

                // --- æŠ•æœº ---
                case 'guess': 
                    state.stats.risk++;
                    timeChange = -3;
                    if (rand > 0.4) { progressChange = 10 * multiplier; msg = "é€‰æ‹©é¢˜å…¨é€‰Cï¼Œé€Ÿåº¦é£å¿«ï¼"; } 
                    else { progressChange = 2; msg = "å…¨æ˜¯ç®€ç­”é¢˜ï¼Œæ²¡æ³•è’™å•Šï¼"; type = "bad"; }
                    break;
                case 'copy': 
                    state.stats.cheat++;
                    timeChange = -5;
                    if (rand > 0.75) { progressChange = 0; timeChange = -10; msg = "ç­”æ¡ˆé¡µè¢«æ’•äº†ï¼Ÿï¼å¿ƒæ€å´©äº†ï¼"; type = "bad"; } 
                    else { progressChange = 25 * multiplier; msg = "æ‰¾åˆ°ç­”æ¡ˆï¼Œç¬”å°–èµ·ç«äº†ï¼"; type = "good"; }
                    break;
                case 'coffee':
                    timeChange = -5; progressChange = 0; state.buffTurns = 4;
                    msg = "å–ä¸‹çº¢ç‰›ï¼Œå……æ»¡åŠ›é‡ï¼(æ•ˆç‡UP)"; type = "buff";
                    break;
                case 'tear':
                    state.stats.risk++;
                    timeChange = -1;
                    if (rand > 0.7) { progressChange = -15; msg = "è¢«å¦ˆå¦ˆå‘ç°æ’•ä½œä¸šï¼è¿›åº¦å€’æ‰£ï¼"; type = "bad"; } 
                    else { progressChange = 15; msg = "æ’•æ‹‰â€”â€”è¿™é¡µä½œä¸šç‰©ç†æ¶ˆå¤±äº†ã€‚"; }
                    break;
                case 'clock': 
                    state.stats.risk++;
                    if (rand > 0.8) { state.time = 0; progressChange = 0; msg = "è¢«å¦ˆå¦ˆå‘ç°æ‹¨æ…¢æ—¶é’Ÿï¼å½“åœºæŠ“è·ï¼"; type = "bad"; } 
                    else { timeChange = 12; progressChange = 0; msg = "ç¥ä¸çŸ¥é¬¼è§‰åœ°æ‹¨æ…¢æ—¶é’Ÿ... +æ—¶é—´"; type = "buff"; }
                    break;
                case 'hire': 
                    state.stats.help++;
                    timeChange = -12;
                    if (rand > 0.6) { progressChange = 35 * multiplier; msg = "å¦¹å¦¹ä¸ºäº†é›¶é£Ÿå¸®ä½ ç‹‚è¡¥ä½œä¸šï¼"; type = "good"; } 
                    else { progressChange = 5; msg = "å¦¹å¦¹å«Œé¢˜å¤ªéš¾è·‘è·¯äº†..."; type = "bad"; }
                    break;
                case 'music': 
                    timeChange = -5; progressChange = 5;
                    if (rand > 0.5) { state.buffTurns = 2; msg = "å¸¦ä¸Šè€³æœºï¼Œä¸–ç•Œå®‰é™äº†ã€‚(Buff+2)"; type = "buff"; } 
                    else { msg = "å¬ç€å¬ç€è·Ÿç€å”±èµ·æ¥äº†ï¼Œæ•ˆç‡ä¸€èˆ¬ã€‚"; }
                    break;
                case 'sick': 
                    state.stats.risk++;
                    progressChange = 0;
                    if (rand > 0.6) { timeChange = 20; msg = "æ¼”æŠ€çˆ†å‘ï¼å¦ˆå¦ˆè®©ä½ ä¼‘æ¯ä¸€ä¼šã€‚(æ—¶é—´+20)"; type = "good"; } 
                    else { timeChange = -15; msg = "è£…ç—…è¢«è¯†ç ´ï¼Œè¢«å¸¦å»åŒ»é™¢æŒ‚å·ï¼Œè¡€äºï¼"; type = "bad"; }
                    break;

                // --- v8.0 æ–°å¢è¶£å‘³é€‰é¡¹ ---
                case 'sacrifice': // çŒ®ç¥­
                    state.stats.chaos++;
                    if (rand > 0.9) { 
                        progressChange = 100; msg = "ã€å¤§æˆåŠŸã€‘ä½œä¸šä¹‹ç¥æ˜¾çµï¼ä½œä¸šç¬é—´å®Œæˆï¼"; type = "good"; 
                    } else if (rand > 0.5) {
                        progressChange = 10; timeChange = 10; msg = "çŒ®ç¥­æˆåŠŸï¼Œè·å¾—äº†å°‘é‡æ—¶é—´å’Œè¿›åº¦ã€‚"; type = "neutral";
                    } else if (rand > 0.2) {
                        progressChange = -20; msg = "ã€å¤§å¤±è´¥ã€‘å¢¨æ°´æ‰“ç¿»äº†ï¼ä½œä¸šæ¯äº†ä¸€åŠï¼"; type = "bad";
                    } else {
                        state.time = 5; msg = "ã€æ··æ²Œã€‘çŒ®ç¥­äº†ä½ çš„å¯¿å‘½... æ—¶é—´æ¿’ä¸´å½’é›¶ï¼"; type = "chaos";
                    }
                    break;
                
                case 'nap': // æˆ˜æœ¯è¡¥è§‰
                    progressChange = -5; // è¿›åº¦å€’é€€ï¼ˆå› ä¸ºæ²¡å†™ï¼‰
                    if (rand > 0.4) {
                        timeChange = 15;
                        msg = "ç¡äº†15åˆ†é’Ÿï¼Œç²¾ç¥ç™¾å€ï¼(æ—¶é—´+15ï¼Œè¿›åº¦-5)";
                        type = "good";
                    } else {
                        timeChange = -30;
                        msg = "ä¸€è§‰ç¡è¿‡å¤´äº†ï¼ï¼å®Œäº†å®Œäº†ï¼(æ—¶é—´-30)";
                        type = "bad";
                    }
                    break;
            }

            state.progress += progressChange + comboBonus;
            state.time += timeChange;
            
            if(comboBonus > 0) msg += " ã€è¿å‡»+3%ã€‘";
            if(multiplier > 1 && msg.indexOf("Buff") === -1 && progressChange > 0) msg += "(BuffåŠ æˆ!)";

            if (state.progress < 0) state.progress = 0;
            if (state.progress > 100) state.progress = 100;
            if (state.time < 0) state.time = 0;
            if (state.time > 100) state.time = 100;

            addLog(msg, type);
            updateUI();
            
            if (!checkGameOver()) {
                triggerRandomEvent();
            }
        }

        document.addEventListener('click', function (e) {
            const target = e.target.closest('.ripple-btn');
            if (target) {
                const circle = document.createElement('span');
                const diameter = Math.max(target.clientWidth, target.clientHeight);
                const radius = diameter / 2;
                const rect = target.getBoundingClientRect();
                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${e.clientX - rect.left - radius}px`;
                circle.style.top = `${e.clientY - rect.top - radius}px`;
                circle.classList.add('ripple');
                const existingRipple = target.querySelector('.ripple');
                if (existingRipple) existingRipple.remove();
                target.appendChild(circle);
                setTimeout(() => circle.remove(), 600);
            }
        });
    </script>
</body>
</html>
